---
author: ["柯棋瀚"]
title: "更新日誌"
date: 2021-02-24
lastmod: 2021-02-28
---

### 2021-02-23

內測版上線。前端0.9，程序0.9

todo list: 1、增加多選，2、增加長曆，3、增加文件導出，4、修改四部宋代曆法

### 2-24

前端0.91: 加入readme；加入評論；加入 GA；加入更新日誌。

### 2-26

程序2.02: 加入合朔日月赤度、節氣日赤度。

### 2-28

前端0.93、程序2.03: 採用滾動數組，減少計算次數，重構數據結構，本地端速度提高 40%；前端相應調整，採用  Web Worker 多線程。避免 UI 與計算的衝突。

程序2.04 今天突然發現望都不對，想了半天才發現，之前都是入曆日+1/2朔望月近點月之差，實際上應該是朔入曆+朔望月/2

### 3-2

前端0.94：採用懶加載策略，只加載當前屏幕的信息。現在可以秒加載了，看來絕大部分時間都消耗在渲染上。

程序2.05：魏晉時期的日月食基本完成，沒算大業日食的特殊情況，太複雜了。

### 3-15

前端0.96：增加日書、轉換tab

程序2.10：增加魏晉日書，轉換工具。



簡介
-----

1.  本工具的使用對象是古代天文曆法研究者。對於一般文史研究者，推薦使用頁腳的友情鏈接（當然，「時間」板塊的三個工具還是挺有用的）。
2.  目前的古代朔閏査詢網站都是根據工具書、文獻材料手動調整的（參考中研院 [兩千年中西曆轉換說明書](https://sinocal.sinica.edu.tw/lusodoc.html)，廖育棟 [本網站的農曆編算](https://ytliu0.github.io/ChineseCalendar/computation_chinese.html)）。本工具可提供古代實行未實行的 60 餘部曆法（包括我復原的 8 部魏晉南北朝曆法、2 部隋曆、3 部唐曆、5 部宋曆、1 部金曆）的計算，完全遵照各曆算法進行全自動計算，無手動干預。主要有三大功能區：
    1. 【朔閏表】每年的積年、冬至大小餘、閏餘；冬至時刻的入轉日、入交泛日、入週天度。各月定朔（線性內插、二次三次內插）、平朔，定朔時刻日月所在赤道度，定望，平氣、定氣、定氣日昏中星。日月食食甚時刻、食分。
    2. 【曆書】包含天文曆、具注曆兩部份。
       1. 天文曆：每日太陽赤經、極黃經宿度，日赤緯、日出時刻、正午晷長，月赤經、月赤緯。
       2. 具注曆：每年「術數年」積年、男女九宮，年干支五行、納音、魁罡之月，23 種歲神，年九宮色。每月月建、月神、吉時、月九宮色。每日干支、儒略日、公曆日期、納音五行、建除、黃道吉日黑道凶日、七星值日、二十八宿二十八禽值日，二十四節氣時刻、七十二候時刻、土王用事時刻、卦用事時刻，人神、日遊神、血支血忌，10 種日神。
    3. 【數學工具】包含同餘、方程、天文、時間四個板塊。
       1. 同餘：大衍求一術、解一次同餘式、大衍總數術，擬秦九韶調日法、淸人調日法三種、連分數，最大公因數、章蔀紀元法，古曆入元、秦九韶演紀法，從零開始造唐宋曆。
       2. 方程：九章算術開方術、累減開方術，二分迭代法解高次方程，隙積術芻童垛、三角垛落一形垛、四角垛方垛，招差術、拉格朗日內插，會圓術、弧矢割圓術、三斜求積術。
       3. 天文：日躔月離及誤差，太陽赤黃經轉換及誤差，太陽去極度、赤緯、日出、晷長及誤差，月亮極白經、赤經、極黃緯，現代天文任意時刻太陽高度、方位角、晷長。
       4. 時間：將萬分小數轉換爲辰刻，儒略日、日期轉換，公元年、年干支轉換。
3.  本工具完全開源，如您需要査詢、核査各曆的詳細參數與算法，請前往源碼倉庫。如您不嫌麻煩，可以下載源碼，在本地運行程序。
4.  如您發現任何問題，可通過評論框或郵件向我反饋。本程序目前未經過文獻檢驗，且急就草創，錯漏叢生，尙不能用於正式學術研究。若您在研究過程中發現程序結果與文獻不符，望不吝提供線索。這個工具是根據研究需要而開發的，如果您有任何功能需求，敬請與我聯繫，我會在力所能及的範圍內儘量實現。
5.  各時期曆法的行用情況見 [赫赫金鑰｜中國古代曆法史](https://kqh.me/tutorial/calendar4/)。
6.  編程理念：以研究需求爲中心；設計理念：以用戶體驗爲中心，傻瓜式操作。關於朔閏表表格的設計：採用加粗—正常——淺灰三層結構，用戶一眼就看到了定朔、平朔、平氣的干支，第二眼看到的是小分，最後看到的是不甚重要的昬中星。定朔平朔之間、定氣平氣之閒用細線，朔望氣之間用粗線。數字都用的等寬字體。每欄中間不設線，間隔恰到好處，不會太寬，讓視線跳躍得很累，也不會太緊，不易分辨。
7.  計算程序採用 JavaScript 編寫，採用滾動數組，減少近一半的計算時間。後端框架爲 Node，前端框架採用 React，採用 Web Worker 將 UI 線程與計算線程分離，採用懶加載，大幅壓縮渲染時間。更多技術特徵見 README。【隱私聲明】本站使用了 Google Analytics 進行流量分析；評論系統採用 Hyvor Talk；服務器託管在 Netlify 平臺。運算均在本地進行。

凡例
--

### 1、朔望氣閏食

1.  第一行爲整年的情況，例如「積2759228 天紀己卯蔀49 大51小747 冬至12.5 閏餘6842閏11」的意思是：此年上元積年爲 2759228 年，入天紀己卯蔀 49 年，天正月大餘 51、小餘 747，冬至日數 12.5，閏餘 0.6842，按照閏餘法，11 月爲閏月。大餘加上蔀或紀名干支卽爲天正朔干支，如上例，己卯 16 + 大餘 51 = 67，mod (67, 60) = 7，正月朔爲庚午。四分曆日法爲 940，小餘 747 轉換爲十進制就是 747 / 940 ≒ 0.7947。冬至 12.5 同樣需要加上蔀干支。閏餘爲十進制，若以章法19爲單位，就是0.6842×19=13。
2.  劉歆《世經》論《三統》上元積年多爲算外，但也有用算上的；《殷曆》 《周曆》等古四分曆，歷代學者論上元積年多用算上，但也有用算外的。統一起見，本表各曆上元積年均爲算外，入蔀（統）年均爲算上。
3.  由於我暫時想不明白的原因，朔干支轉換成公曆日期的功能（該算法移植自廖育棟），一年中可能有一個月有1天誤差（如甲子應該是2月2日，顯示的是2月1日），並且有可能一整年會前後錯開一個月（ 如正月朔對應的是二月的公曆日期）。本工具提供的公曆日期僅供參考，如需使用公曆日期，請使用廖育棟的 [儒略日數和日干支計算器](https://ytliu0.github.io/ChineseCalendar/Julian_chinese.html) 進行覆核。
4.  置閏共有三種方法：閏餘法、無中氣法、固定冬至法，閏餘法可分爲年中置閏、年末置閏兩種，無中氣法閏月必在年中（當然也可能在最後一個月） ，固定冬至法閏月必在年末。漢代以後均採用無中氣法。古六曆並不確定採用何種置閏法，本工具能同時顯示三種置閏法的結果（絕對獨家技術） ，以固定冬至法為主。第一行最後標注的是閏餘年中置閏法的閏月，若採用閏餘年末置閏法，最後一個月就是閏月。中氣一行採用無中氣置閏法，有「□□」的年份爲無中氣置閏法的閏年，「□□」表示該月無中氣，爲閏月。需要留意的是，若固定冬至法閏年在閏餘法、無中氣法的上一年，那麼該年的閏餘法、無中氣法閏月數需要加 1 ，因為固定冬至法把該年的第一個月往上年奪去了。固定冬至法的閏月必定置於年末；無中氣法的閏月可能比閏餘年中法提前或延後一個月：中氣與朔同在一日，中氣的時刻比朔早，則閏餘未達到閏準，還不能置閏；但是由於中氣與朔已經在一日了，上個月無中氣，需要置閏。
5.  判斷大小月的方法：看天干是否相同。如一、二、三月的朔分別是辛亥、辛巳、庚戌，辛亥、辛巳天干一樣，說明一月有 30 日，爲大月；辛巳、庚戌天干不同，說明二月有 29 日，爲小月。
6.  「平朔」卽未考慮日月速度變化而得出的朔日，「平氣」卽未考慮日速度變化而得出的中氣日，「定朔」卽加上日月速度改正而得出的朔日，「定氣」卽加上日速度改正而得出的中氣日。干支下的數字為小分，均為十進制小數，如「8184」卽0.8184，換算成24小時制爲：0.8184 × 24 = 19.6416，0.6416 × 60 = 38.496，0.496 × 60 ≒ 30，卽19點38分30秒。小分到取小數點後四位，卽精度爲 8.64 s。各曆均有不同的辰法，需要您手動進行轉換。未來我可能會加入辰法自動轉換。
7.  「二次」表示用二次差內插法計算出的小分，「一次」表示用線性內插法計算出的小分，「三次」表示用三次差公式計算出的小分。若某曆有二次差定朔計算，則望干支及小餘爲二次差定望，其餘曆法同理。
8.  雖然漢末《乾象曆》便出現了定朔推步，但直到唐初《麟德曆》纔正式開始用定朔編排曆書，此前都是平朔注曆，定朔僅用於交食推步。雖然隋劉焯《皇極曆》 便發明了二次差計算定朔，但編排曆書時僅採用簡單的線性內插進行計算，二次差僅用於交食推步。雖然《皇極曆》開始便可以計算定氣，但直到淸《時憲曆》 纔開始用定氣編排曆書，之前都是平氣注曆。本程序在平朔注曆時代用平朔編排閏月；在定朔推曆時代用二次差編排閏月、進朔，若遇一次差與二次差存在臨界差異，用戶大可進行手動調整，但這種極端情況應該不大可能出現。
9.  《元嘉》規定若月食發生在黎明之前，則屬上日，我把此規定用於所有的魏晉系曆法。干支減去1的，在定朔干支一格加上「-」，小分不變。《麟德》開始行進朔法，我目前暫時簡單將 0.75 作爲進朔標準，進朔的月在干支後加上「+」來表示，僅將干支加 1，小分不變。如「乙丑+」表示原本的干支是甲子，進朔爲乙丑，而小分與進朔前一致。如果遇到與文獻不一致的情況，用戶可根據小分自行調整進朔與置閏。
10.  日食定在朔，月食定在望。「● ◐ ○」分別表示全食、偏食、虧蝕微少。乾象、大明沒有虧食程序的計算，大業以前沒有全食限，整齊起見，我一槪補齊。

### 2、日書

【尚未完工】日書按月提供全年每一日的信息：

1.  第幾日、干支
2.  【日赤】日所在赤道度
3.  【日黃】日所在黃道度
4.  【日去極】日黃道去極度、日視赤緯。
5.  【晷長】以尺爲單位
6.  【日出】日出時刻。與朔閏表一樣，四位數前省略了「0.」，0.2500 卽 24 \* 0.25 = 6 點
7.  【昏中星】太陽落山後約 2.5 刻的時候，正南的星宿。所謂「日短星昴」
8.  【月赤】月所在赤道度
9.  【黃白距】月與日的緯度差，日去極 + 黃白距 = 月去極。月在陽曆（黃道以南）爲正，月在陰曆（黃道以北）爲負
10.  【候土卦】發斂（七十二候）、土王用事、卦用事三個合在一起。

【魁罡之月】切不得修造動土，大凶。【七曜對應】蜜=日，莫=月，雲漢=火，嘀=水，溫沒斯=木，那頡=金，雞緩=土【七曜値日吉凶】太陽直日，宜見官、出行、求財，走失必得，吉事重吉，凶事重凶；太陰直日，納財、治病、服藥、修井灶門戶，忌見官；火直日，宜買六畜、治病、合伙造書契、合市，忌針灸；水直日，宜入學造功德，一切工巧皆成，六畜走失自來；木直日，宜見官、禮事、買莊宅、下文狀、洗頭；金直日，宜受法、市口馬、著新衣、修門戶，忌見官；土直日，宜典莊田、市買牛馬，利加萬倍，修倉庫。【三元紫白詩】上利與功紫白方，碧綠之地患癰瘡，黃赤之方遭疾病，黑方動土主凶喪。【長短星】不宜市貿、交易、裁衣、納財【人神吉凶】人神所在及血忌血支不可鍼灸出血。【日遊吉凶】日遊在房內，產婦不宜於方位上安牀帳，及掃舍皆凶。（赵贞《敦煌具注历中的「蜜日」探研》、楊帥《出土文獻所見 7-14 世紀中國曆注研究》、鄧文寬《敦煌文獻S2620號唐年神方位圖試釋》。鄧文寬《敦煌古曆叢識》還有一部分歲神，以後補充。《敦煌曆日探研》，《出土文獻研究》第七輯）【黃道黑道】青龍黃道，天乙星；明堂黃道，貴人星；金匱黃道，福德星；天德黃道，寶光星；玉堂黃道，少微星，天開星；司命黃道，鳳輦星，月仙星；天刑黑道，天刑星；白虎黑道，天殺星；朱雀黑道，天訟星；天牢黑道，鎮神星；玄武黑道，天獄星；勾陳黑道，地獄星。（具體內容自己搜索）【往亡】不可起土功。分往亡、氣往亡兩類，爲示區分，我將第一類稱爲往亡，第二類稱爲氣亡。往亡=土忌、土禁、地杓、大徼、土司空。【復日】魁罡所擊之辰，忌爲凶事，利爲吉事。【重日】凶事重凶。【反支】反支日公車不受章奏，漢明帝「蠲其制」。流行於秦漢。推算方法仍有待研究。我暫且用 554433221166【大時小時】頁 257【歸忌】忌遠行、歸家、移徙、娶婦【天李】=天理=天獄。不可入官、入室【臨日】=赤帝臨日，忌臨民、訴訟。（王強《出土戰國秦漢數術文獻神煞研究》）

### 3、五星

預計 2023 年推出，敬請期待。

### 4、轉換

此頁面提供了幾個轉換工具：

#### 大衍求一術

輸入兩個 **互質** 的整數 a, b，求方程 `a * x ≡ 1 (mod b)` 的解 x 。可以 a>b ，也可 a<b 。更多內容可參考 [中国剩余定理和大衍求一术](https://zhuanlan.zhihu.com/p/272302805)。

#### 調日法與無窮調日法

一個朔望月是 29.5305 日有餘，在《授時》以前都用分數來表示朔分。自何承天始，以 彊子26 / 彊母47 爲彊率，以 弱子9 / 弱母17 爲弱率，則 朔餘 / 日法 可表示爲 (26m+9n) / (49m+17n) ，m 卽陽率（彊數），n 卽陰率（弱數），彊弱率之間的任何數都可以作如上表示。調日法是南系、隋系、唐系、宋系的不傳之祕，直到乾嘉時期李銳纔闡明此法（更多見 劉鈍《 李銳、顧觀光調日法工作述評》，《自然科學史研究》1987(2)；陳久金《調日法研究》1984(3)；李繼閩《關於調日法的數學原理》，西北大學學報 1985(2)；[赫赫金鑰](https://kqh.me/tutorial/calendar4)）。

無窮調日法是我自己的一點點小改進。彊弱率需滿足如下條件：![](https://pic.imgdb.cn/item/604db4765aedab222ce451f5.png)，卽 `彊子 * 弱母 - 彊母 * 弱子 = 1` 。那麼推廣開來，26/47 和 9/17 只是一種可能性而已，適合求朔分 0.5305 附近的數，而任何滿足這個條件的彊弱二率，都可以用來調制。只需要輸入分母（卽曆法中的日法）、彊率，便會自動根據大衍求一術求出弱率，再根據李銳公式求出分子（卽曆法中的朔餘）和彊弱數（卽加權） ；也可以同時輸入分子和分母，根據累彊弱之數、李銳、顧觀光-陳久金三種方法各自生成彊弱數。這推廣開來的調日法就是無窮調日法。輸入框中默認是何承天彊率。不過李銳公式有一個限制，必須滿足 弱數<彊母，例如玄始曆 47251 / 89052 ，李銳公式解得 47252 = 26×1816 + 9×4，累強弱、顧-陳公式解得 47251 = 26×1799 + 9×53，卽 47251 / 89052 和 47252 / 89052 都滿足調日法，但李銳公式求不出前者。

更多說明見 [赫赫金鑰](https://kqh.me/tutorial/calendar4)。

#### 連分數逼近

給定一個分數，求其最大公因數、連分數、各漸進連分數。連分數逼近非常適合與調日法參照。

#### 儒略日與日期互轉

核心計算程序移植自 [廖育棟](https://ytliu0.github.io/ChineseCalendar/Julian.js) 教授，表示感謝！我增加了毫秒計算，雖然沒什麼用。

#### 黃赤轉換

黃道積度、赤道積度的相互轉換（如230度）。不用在意輸入的是黃道還是赤道，因為黃赤差都是一樣的，會自動生成黃道度和赤道度兩個結果，輸入的是黃道度，則選用生成的赤道度卽可，反之亦然。

若想進行黃赤入宿度的相互轉換（如斗3度），直接在日書進行線性內插卽可。

