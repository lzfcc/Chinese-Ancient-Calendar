## 天文計算說明

### 躔離

入轉日需在一個近點月<n>約27.5545</n>以內。太陽運動很簡單，用一次傅立葉函數就能比較準確地擬合，但有一個問題是，基本上所有的古曆都以冬至爲近日點<n>日速最快</n>，實際上並不是這麼回事，在 1250 年左右纔是正好以冬至爲近日點，往前往後誤差都會越來越大，只有<v>儀天曆</v>對日躔表有意識地做出了修正；月亮運動相當複雜，週期項非常多，而古曆都僅僅以一個近點月爲週期，我們只能用非常粗糙的近似修正來模擬古曆模型。圖中分爲三部分：1、日盈縮積，距冬至日數這麼多天，太陽實際上走了多少度；2、遲疾積，入近點月這麼多天，月亮實際走了多少度；3、日行改正=日盈縮積/(月實行速-日實行速)；4、月行改正=-月遲疾積/(月實行速-日實行速) 。平朔+日行改正+月行改正=定朔，平氣-日盈縮積=定氣。入交定分=入交泛分+太陽改正+0.0785077*月亮改正。理想的分母是(月實行速-日實行速)，但是不同時期的曆法所選分母各不相同，授時曆以月實行速爲分母，唐宋曆法上以月平行速爲分母，魏晉曆法基本上是(月實行速-日平行速)。有 8 部曆法以遠地點<n>月速最慢</n>入轉，其餘都是近地點<n>月速最快</n>入轉。

### 赤經極黃經

第一行「球面三角」是黃赤經轉換的公式，第二行「三角割圓」是用三角函數代替會圓術的弧矢割圓術，<v>授時</v>弧矢割圓術用的是會圓術。弧矢割圓術是近似三角形、勾股定理、會圓術的組合，前兩者都是精確公式，只有會圓術是近似公式，那麼從理論上來講，如果用三角函數代替會圓術，就能得到和球面三角完全一致的結果，實際上也是這樣的。度數從冬至起算，二至到二分：赤大於黃；二分到二至：黃大於赤。只有<v>紀元</v>有黃轉赤公式，其餘只能赤轉黃，我用與<v>紀元</v>相同的求反函數思路，補出各宋系曆法的黃轉赤公式。最後一欄的赤緯是直接根據赤道度或黃道度算出來的，下面的赤緯是根據距離冬至日數算出來的，要考慮日躔，而表格法曆法在製表時已經考慮了日躔，所以此處不能加上表格法曆法的赤緯。小數點後 4 位的精度是 0.36”

### 日緯

黃道去極度 = 週天/4 - 赤緯。 假設 1 尺 = 20 cm，小數點後 4 位是精度就是 20μm。日出時刻 = 夜半漏 + 2.5 刻<n>一日百刻。</n>球面三角的日出、晷長有兩行，上行計入蒙氣差、日視半徑等修正因素，作爲誤差 1 標準，下行未加入修正，作爲誤差 2 標準。各曆法赤緯誤差（度）：四分 0.7，麟徳 0.13，大衍 0.06，宣明、儀天 0.45，崇玄 0.09，崇天 0.23、明天 0.2，觀天 0.21，紀元、授時 0.11。各曆漏刻誤差（分鐘）：授時 0.7、乾元、紀元、重修大明、庚午 3.8，四分、景初、元嘉 4.4，崇玄 4.6，大明 4.7，皇極 5.6，大業戊寅 6.1，麟徳 4.6，明天、觀天 4.9，大衍 5.1，崇天 6.2，宣明 7.7，儀天 7.9。各曆觀測地點：四分、景初、元嘉、大明：洛陽，皇極、大業、戊寅、麟徳、宣明：長安，大衍、崇玄、應天、儀天、崇天：陽城，乾元、明天、觀天、紀元、重修大明、庚午：俊儀，授時：大都（陳美東）

晷長單位爲尺，表高 8 尺。有效晷長範圍：0—50 尺，有效天頂距範圍：0—85 度。天頂距<n>戴日之北度</n> = 黃道去極度 - (象限 - 緯度)，象限 = 恆星年/4，<u>陽城</u>緯度<n>北極出地高度</n> 34.475

### 月極黃經 ⇒ 極白經、赤經、極黃緯

需要輸入此刻入降交點<n>正交</n>交點月的日數、距離冬至的日數。距離冬至日數會加上日躔、轉換爲黃道度，再進行接下來的計算。正交至半交：白大於黃，半交至正交：黃大於白。一交點月約 27.21222 日。<v>大衍</v>月黃緯表用到了三次內插，前半段<code>Δ = 171, -24, -8</code>後半段<code>Δ = -75, -40, 8</code>。<v>宋曆</v>第一行赤道度以九道術求得，第二行以黃赤轉換公式求得；<v>授時</v>赤道度則直接以弧矢割圓術求得。赤白差一欄，除了紀元，都是赤道-白道，紀元較爲特殊，日月同名：赤白差=黃赤差+黃白差，異名：赤白差=黃赤差-黃白差

### 交點月

我的獨創發明：<code>Node = Lunar * EcliCycle / (1/2 + EcliCycle)</code>，以<v>皇極</v>驗之，可見<v>皇極</v>之交點月正以此公式化之。<v>大明</v>以前無交點月，只有交食週期，我藉此全部統一爲用交點月進行計算，非常方便。可輸入小數或分數，算出來的小數可通過「同餘」標籤中的「連分數」化爲漸進分數

### 日食

大業戊寅皇極麟徳要根據月份來判斷，這裏爲了簡化輸入，我改爲用節氣判斷季節，這不準確。入交日在正交、半交附近發生交食，交點月的一半約爲 13.60611

### 任意時刻太陽高度、方位角、晷長

輸入年前冬至時刻<n>（例如計算 2020 年 12 月 29 日、2021 年 6 月 29 日，均輸入 2020 年 12 月 21 日冬至時刻。可通過廖育棟網站、壽星天文曆、日梭天文曆、中國天文年曆等査詢）</n>、該日距冬至的整數日數<n>（冬至當日爲 0）</n>、想要計算的時刻、地理緯度、影桿的高度<n>（北京約 39 度）</n>、公元年。程序自動將距冬至日數轉換爲眞黃經、赤緯。方位角正負：子線或午線以右以東爲負，以左以西爲正，本程序計算出的方位角不大於 90°