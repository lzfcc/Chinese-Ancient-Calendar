## 同餘模塊說明

分隔符：<code>; , ， 。 ； 空格</code>；組數不限

### 大衍求一術

解一次同餘式的核心模塊，孫子定理、不定方程、調日法、演紀都需要求一術。輸入兩個互質整數<n>衍數、定母</n>，求方程 <code>a * x ≡ 1 (mod b)</code> 的解 x

### 大衍總數術

卽解同餘式組，是秦九韶推廣之孫子定理。求解多組 x ≡ r<sub>i</sub> (mod m<sub>i</sub>) ，有解的充要條件是 gcd (m<sub>i</sub>, m<sub>i+1</sub>) | abs (r<sub>i</sub> - r <sub>i+1</sub>)；依次輸入各組餘數 r、元數 m。孫子定理有解的充要條件：(m<sub>1</sub>,m<sub>2</sub> | |r<sub>1</sub>-r<sub>2</sub>|)  1、定母i|元數i；2、定母互質；3、M=定母相乘=元數的最小公倍數。在孫子定理中，模數需兩兩互質，而秦九韶將不互質的元數變爲互質的定母，進而可以使用孫子定理求解。

### 連分數

給定一個分數，求其連分數、各漸進連分數。非常適合與調日法參照。古代數學似乎沒有小數，都是分數運算，而計算機程序都是浮點運算，所以也可以用這個工具將計算機計算出的結果轉換爲分數。

### 調日法

一個朔望月是 29.53059 日有餘，在<v>授時</v>以前都用分數來表示小分。自何承天<v>元嘉</v>始，以 彊子26 / 彊母47 爲彊率，以 弱子9 / 弱母17 爲弱率，則 `朔餘 / 日法` 可表示爲 ` (26m+9n) / (49m+17n)` ，m 卽陽率<n>彊數</n>，n 卽陰率<n>弱數</n>，彊弱率之間的任何數都可以作如上表示。調日法是南系、隋系、唐系、宋系的不傳之祕，直到乾嘉時期李銳纔闡明此法<n>更多見 劉鈍 <v>李銳、顧觀光調日法工作述評</v>，<v>自然科學史研究</v>1987(2)；陳久金<v>調日法研究</v>1984(3)；李繼閩<v>關於調日法的數學原理</v>，西北大學學報 1985(2)</n>。

無窮調日法是我自己的一點點小改進。彊弱率需滿足如下條件：<img src="https://pic.imgdb.cn/item/604db4765aedab222ce451f5.png" alt="" width='140'></img>，卽 `彊子 * 弱母 - 彊母 * 弱子 = 1` 。那麼推廣開來，26/47 和 9/17 只是一種可能性而已，適合求朔分 0.5305 附近的數，而任何滿足這個條件的彊弱二率，都可以用來調制。只需要輸入分母<n>卽曆法中的日法</n>、彊率，便會自動根據大衍求一術求出弱率，再根據李銳公式求出分子<n>卽曆法中的朔餘</n>和彊弱數<n>卽加權</n> ；也可以同時輸入分子和分母，根據累彊弱之數、李銳、顧觀光-陳久金三種方法各自生成彊弱數。這推廣開來的調日法就是無窮調日法。輸入框中默認是何承天彊率。不過李銳公式有一個限制，必須滿足 `弱數<彊母`，例如玄始曆 47251 / 89052 ，李銳公式解得 47252 = 26×1816 + 9×4，累強弱、顧-陳公式解得 47251 = 26×1799 + 9×53，卽 47251 / 89052 和 47252 / 89052 都滿足調日法，但李銳公式求不出前者。

宋<v>明天曆</v>作者<u>周琮</u>論調日法曰：

> 自漢太初至于今，冬至差十日，如劉歆三統復強於古，故先儒謂之最疏。後漢劉洪考驗四分，於天不合，乃減朔餘，苟合時用。自是已降，率意加減，以造日法。宋世何承天更以四十九分之二十六爲強率，十七分之九爲弱率，於強弱之際以求日法。承天日法七百五十二，得一十五強，一弱。自後治曆者，莫不因承天法，累強弱之數，皆不悟日月有自然合會之數。
>
> 今稍悟其失，定新曆以三萬九千爲日法，六百二十四萬爲度母，九千五百爲斗分，二萬六百九十三爲朔餘，可以上𥡴於古，下驗於今，反覆推求，若應繩準。又以二百三十萬一千爲月行之餘<n>月行十三度之餘</n>，以一百六十萬四百四十七爲日行之餘<n>日行周天之餘</n>。乃會日月之行，以盈不足平之，幷盈不足，是爲一朔之法<n>日法也，名元法</n>。今乃以大月乘不足之數，以小月乘盈行之分，平而幷之，是爲一朔之實<n>周天分也</n>。以法約實，得日月相會之數，皆以等數約之，悉得今有之數<n>盈爲朔虛，不足爲朔餘</n>。又二法相乘爲本母，各母互乘，以減周天，餘則歲差生焉，亦以等數約之，卽得歲差、度母、周天實用之數。此之一法，理極幽眇，所謂反覆相求，潛遁相通，數有冥符，法有偶會，古曆家皆所未達<n>以等數約之，得三萬九千爲元法，九千五百爲斗分，二萬六百九十三爲朔餘，六百二十四萬爲日度母，二十二億七千九百二十萬四百四十七爲周天分，八萬四百四十七爲歲差</n>。<n>上<v>宋志七</v></n>

以下是各曆朔餘、日法：

```javascript
[
    [43, 81], // 三統 大於強率
    [499, 940], // 四分 大於強率
    [773, 1457], // 乾象
    [6409, 12079], // 黃初
    [2419, 4559], // 景初
    [18703, 35250], // 正曆 李銳求不出
    [3217, 6063], // 三紀
    [47251, 89052], // 玄始 李銳求不出
    [399, 752], // 元嘉
    [2090, 3939], // 大明
    [815, 1536], // 大同
    [39769, 74952], // 正光 李銳求不出
    [110647, 208530], // 興和 李銳求不出
    [607, 1144], // 劉孝孫大業
    [155272, 292635], // 天保 李銳求不出
    [153961, 290160], // 天和 李銳求不出
    [28422, 53563], // 大象 大於強率
    [96529, 181920], // 開皇 大於強率
    [659, 1242], // 皇極
    [6901, 13006], // 戊寅
    [53.06, 100], // 神龍 累強弱求不出 李銳說不合，我求得出<n>因爲乘了100</n>
    [711, 1340], // 麟德五紀
    [1613, 3040], // 大衍
    [581, 1095], // 正元
    [4457, 8400], // 宣明
    [7163, 13500], // 崇玄
    [3820.28, 7200], // 欽天 累強弱求不出 李銳求不出
    [5307, 10002], // 應天 累強弱求不出
    [1560, 2940], // 乾元 累強弱求不出
    [5359, 10100], // 儀天
    [5619, 10590], // 崇天 累強弱求不出
    [20693, 39000], // 明天
    [12575, 23700], // 奉元 累強弱求不出
    [6383, 12030], // 觀天
    [14899, 28080], // 占天
    [3868, 7290], // 紀元 累強弱求不出。陳久金：27076/51030
    [3677, 6930], // 統元
    [15917.76, 30000], // 乾道 累強弱求不出 李銳求不出
    [2992.56, 5640], // 淳熙 累強弱求不出 李銳求不出
    [20534, 38700], // 會元 累強弱求不出
    [6368, 12000], // 統天 大於強率
    [8967, 16900], // 開禧
    [1873, 3530], // 淳祐
    [5168, 9740], // 會天 累強弱求不出
    [3937, 7420], // 成天
    [2775, 5230], // 大明 累強弱求不出
    [10978, 20690], // 乙未 累強弱求不出
    [5305.93, 10000], // 授時 累強弱求不出 李銳求不出
]
```

累強弱法剛寫出來的時候把各曆都算了一遍，上面是<b>當時</b>的情況，發現欽天以後大量朔餘用累強弱之數法算不出來。後來寫了分解公因數程序，突然發現這些求不出來的全都是可以通分的，通分之後就都求出來了！看來宋曆的 朔餘 / 日法 還照顧了其他因素。而李銳公式求不出的，我通分之後依然求不出。

- <v>三統</v>遠超強率 26/49，但另有方法。用連分數逼近，求得各漸進分數： (1) 0/1 (2) 1/1 (3) 1/2 (4) 8/15 (5) 9/17 (6) 17/32 (7) 43/81，其中 17/32 大於 43/81，可以作爲強率，於是弱率爲 9/17。算調日法，得 43 = 17×2 + 9×1，81 = 32×2 + 17×1，2 彊 1 弱。可是這樣就算調出來了也毫無意義，因爲三統是以律起曆<n>用三分損益率構造日法</n>，當然跟調日法毫無關係。
- 同理，<v>四分曆</v>各漸進分數： (1) 0/1 (2) 1/1 (3) 1/2 (4) 8/15 (5) 9/17 (6) 17/32 (7) 26/49 (8) 43/81 (9) 499/940，因此可以用三統 43/81 作爲強率，弱率得 26/49，得 11 強 1 弱。四分曆也可以調出來，同樣，毫無意義。
- <v>大象曆</v>也超過了強率。劉洪濤認爲，<v>大象</v>是以<v>四分曆</v>499/940 爲強率，以何承天 9/17 爲弱率，得 `(499*1107 + 9*11257)/(940*1107 + 17* 11257) = 28422/53563`。<n><v>古代曆法計算法</v>頁 617</n>但這兩個強弱率不能用大衍求一術得到。
- <v>統天</v>超過強率，按照調日法求出來是6367，多出來的 1 是留給朔實消長的空間。
- <v>開禧</v>以弱換強：`16900=169*49+507*17=339*49+17*17=(169+17*10)*49+(507-49*10)*17`
- <v>乾道</v>用李銳公式算出來的是以弱換強之後的，但數學上我不太懂，以弱換強的話，日法都是一樣的，爲何朔餘就不一樣了？

### 一次同餘式　二元一次不定方程

`ax - by = c` 等價於 `ax ≡ c (mod b)`，有解的充要條件：`(a,b)|c`，卽 c 能被 a、b的最大公因數整除

### 最大公因數　最小公倍數

求多個整數或小數的最大公因數 gcd、最小公倍數 lcm

### 分數最小公倍數

求多組分數的最小公倍數 lcm，依次輸入各組分子、分母<n>整數分母用 1 表示。</n>

### 章蔀紀元法

依次輸入斗分、歲實分母、朔餘、日法，計算相應的章法、蔀法、紀法、元法，可以用來復原一些失傳魏晉南北曆法的參數。

## 上元積年算法

古曆入元和唐宋演紀是秦九韶<v>數書九章</v>的兩個命題。秦九韶也試圖通過大衍總數術算上元積年，但並不如意，因為總數術缺乏對餘數的調整選擇功能。<n>曲安京<v>曆法</v>頁 29</n>

### 古曆入元

依次輸入年月參數、冬至大小餘、天正經朔大小餘，大餘卽干支序數，無須 - 1。

宋以前皆有上元積年，雖有<v>戊寅</v>、<v>統天</v>的短暫停用，但直到<v>授時</v>纔徹底廢除。根據我粗畧的觀察，漢代的上元積年是回歸年、朔望月、交食週期、五星週期的同餘數，魏晉系、北系是回歸年、朔望月的同餘數，南系是回歸年、朔望月、交食週期、近點月。

<v>後漢四分</v>的上元積年是 270 多萬年，古六曆也是差不多是這樣，所以可以判定古六曆的上元積年一定是漢代的，戰國時期的古六曆應該沒有考慮五星週期，也沒有考慮年干支，直以 1520 年爲一週期。這只是我的猜測。

### 唐宋演紀

依次輸入斗分、日法、冬至大小餘、天正經朔大小餘，大餘卽干支序數，無須 - 1。這是秦九韶紀錄的<v>開禧曆</v>演紀方法，但其他宋曆似乎並不是這樣用求一術算的，對其他曆法並不好用。

### 從零開始造唐宋曆

第一步。 暴力窮舉所有符合條件的日法。

第二步。  暴力窮舉所有符合條件的上元積年，從100萬年窮舉到1億年。選取一部已知曆法作爲參照，「年」輸入參照曆法化爲小數後的歲實；「月」輸入上一步生成的日法、朔餘<n><n>選擇最接近的一箇卽可</n></n>；「冬至」輸入參照曆法年前冬至的日分<n><n>如乙丑日 0.2518 分，則是 1.2518</n></n>；「天正朔」輸入參照曆法年前天正經朔的日分。按照經驗，範圍在 0.02 之內。如計算出多個上元，則縮小範圍繼續計算。如選擇了 1256 年作爲參照，計算出 73147137，則上元爲公元 1256-73147137 年。

第三步、窮舉參數。 計算恆星年、近點月、交點月等參數。以比例關係求得分子整數部分，以0.0001遞增，窮舉得到。「參數積日」輸入參照曆法的朔閏表該年表頭相應信息。

## 備忘

- 授時曆議的後天，從成天和授時的關係來看，指的是冬至時刻。
- 關於賈俊<v>大明</v>：

> 「聖宗統和十二年，可汗州刺史賈俊進新曆，則大明曆是也。」遼大明曆術，[元](https://zh.wikipedia.org/wiki/元朝)修<v>遼史</v>時史官已不得見，因此曆象志全錄同名的南朝[宋](https://zh.wikipedia.org/wiki/刘宋)[祖沖之](https://zh.wikipedia.org/wiki/祖沖之)[大明曆](https://zh.wikipedia.org/wiki/大明曆_(祖沖之))術，以充篇幅，而兩者實不相干，爲後世史家所非議[[1\]](https://zh.wikipedia.org/zh-hant/大明曆_(賈俊)#cite_note-1)。但是由歷史文獻氣朔記錄推察，學者認爲遼大明曆很有可能本於唐[宣明曆](https://zh.wikipedia.org/wiki/宣明曆)。
>
> 嚴敦傑「遼曆志疑」指出：一、<v>遼史</v>曆象志朔考謂「遼己未歲<n>1079</n>氣朔與宣明曆合。」，又云日本承曆二年戊午歲<n>1078</n>與遼曆相近，而當時日本所行用就是宣明曆。二、宣明曆曾長期流行於[渤海國](https://zh.wikipedia.org/wiki/渤海國)、[女真](https://zh.wikipedia.org/wiki/女真)等北方民族，渤海國爲契丹所滅，因此宣明曆可能由此傳入契丹。三、嚴氏以[汪曰楨](https://zh.wikipedia.org/wiki/汪曰楨)<v>[歷代長術輯要](https://zh.wikipedia.org/w/index.php?title=歷代長術輯要&action=edit&redlink=1)</v>所推氣朔與遼曆不合者12例，改用宣明曆驗算，結果有11例與遼曆相符[[2\]](https://zh.wikipedia.org/zh-hant/大明曆_(賈俊)#cite_note-2)。邱靖嘉更進一步補充，宋江休復<v>江幾鄰雜志</v>云：「己亥曆日十一月大盡，契丹曆此月小，十二月十四日夜纔昏月蝕，戎使言：『竊謂爲己望』。時修<v>[唐書](https://zh.wikipedia.org/wiki/新唐書)</v>，問<n>劉</n>[羲叟](https://zh.wikipedia.org/wiki/劉羲叟)，云：『見用楚衍曆，差一日，宣明曆十一月當小盡。』」[陳漢章](https://zh.wikipedia.org/wiki/陳漢章)考證己亥爲[宋仁宗](https://zh.wikipedia.org/wiki/宋仁宗)嘉祐四年<n>1059</n>，是年十一月宋曆爲大月，遼曆爲小月，而宣明曆與遼曆同，足見遼大明曆與唐宣明曆比較接近，兩者可能存在淵源關係[[3\]](https://zh.wikipedia.org/zh-hant/大明曆_(賈俊)#cite_note-3)。