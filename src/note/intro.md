## 簡介

1. 本工具的使用對象是古代天文曆法研究者。對於一般文史研究者，推薦使用下面的友情鏈接<n>當然，「時間」板塊的三個工具還是挺有用的</n>。
2. 目前的古代朔閏査詢網站都是根據工具書、文獻材料手動調整的<n>參考中研院 [兩千年中西曆轉換說明書](https://sinocal.sinica.edu.tw/lusodoc.html)，廖育棟 [本網站的農曆編算](https://ytliu0.github.io/ChineseCalendar/computation_chinese.html)</n>。本工具可提供古代實行未實行的 60 餘部曆法的計算，完全遵照各曆算法進行全自動計算，無手動干預。主要有三大功能區：
    1. **朔閏表** 每年的積年、冬至大小餘、閏餘；冬至時刻的入轉日、入交泛日、入週天度。各月定朔<n>線性內插、二次三次內插</n>、平朔，定朔時刻日月所在赤道度，定望，平氣、定氣、定氣日昏中星。日月食食甚時刻、食分。
    2. **曆書** 包含天文曆、具注曆兩部份。
        1.  天文曆：每日太陽赤經、極黃經宿度，日赤緯、日出時刻、正午晷長，月赤經、月赤緯、月行九道/三道。預計 2022 年將推出五星計算。
        2.  具注曆：每年「術數年」積年、男女九宮，年干支五行、納音、魁罡之月，23 種歲神，年九宮色。每月月建、月神、吉時、月九宮色。每日干支、儒略日、公曆日期、納音五行、建除、黃道吉日黑道凶日、七星值日、二十八宿二十八禽值日，二十四節氣時刻、七十二候時刻、沒滅日時刻、土王用事時刻、卦用事時刻，人神、日遊神、血支血忌，10 種日神。
    3. **數學工具** 包含同餘、方程、天文、時間四個板塊。
        1.  同餘：大衍求一術、解一次同餘式、大衍總數術，擬秦九韶調日法、淸人調日法三種、連分數，最大公因數、章蔀紀元法，古曆入元、秦九韶演紀法，從零開始造唐宋曆。
        2.  方程：~~九章算術開方術、累減開方術，~~二分迭代法解高次方程，隙積術芻童垛、三角垛落一形垛、四角垛方垛，招差術、拉格朗日內插，會圓術、弧矢割圓術、三斜求積術。
        3.  天文：日躔月離及誤差，太陽赤黃經轉換及誤差，太陽去極度、赤緯、日出、晷長及誤差，月亮極白經、赤經、極黃緯，現代天文任意時刻太陽高度、方位角、晷長。
        4.  時間：將萬分小數轉換爲辰刻，儒略日、日期轉換，公元年、年干支轉換。
3. 如您發現任何問題，可通過評論框或郵件向我反饋。若您在研究過程中發現程序結果與文獻不符，望不吝提供線索。這個工具是根據研究需要而開發的，如果您有任何功能需求，敬請與我聯繫，我會在力所能及的範圍內儘量實現。
5. 本工具與以往的朔閏表工具書是相互補充的關係，古人算曆有可能不會完全依照術文，會根據實際情況適當調整，這種情況下計算程序就無能爲力。
6. 本工具完全開源，如您需要査詢、核査各曆的詳細參數與算法，請前往源碼倉庫。如您不嫌麻煩，可以下載源碼，在本地運行程序。更多技術特徵見開發者說明。核心計算邏輯文件大小：253KB。 **隱私聲明** 本站使用了 Google Analytics 進行流量分析；評論系統採用 Hyvor Talk；服務器託管在 Netlify 平臺。運算均在本地瀏覽器進行。
6. 可以參考《律曆初階下》：
    1. [曆法簡史](https://kqh.me/key/calendar1)
    2. [天學](https://kqh.me/key/calendar2)
    3. [天文計算](https://kqh.me/key/calendar3)
    4. [四分系](https://kqh.me/key/calendar4)
    5. [日神、時間制度](https://kqh.me/key/calendar6)
    6. [數學工具](https://kqh.me/key/calendar7)。本站參考資料見此

## 網站推薦

### 年表

- [廖育棟的網站](https://ytliu0.github.io/ChineseCalendar/index_chinese.html)年曆、氣朔時刻、中國歷史年表、儒略日干支轉換等
- 中研院 [兩千年中西曆轉換](https://sinocal.sinica.edu.tw/)
- [歷史車輪中西曆轉換器](https://www.lishichelun.com/calendar/switch)

### 實行曆法

- [和暦 (わごよみ) & 中華暦（からごよみ）](http://www.wagoyomi.info/) 〔寶藏！〕
- 廖育棟的 [時憲曆計算](http://ytliu.epizy.com/Shixian/index_chinese.html)
- [紀年轉換工具](https://kanasimi.github.io/CeJS/_test%20suite/era.htm)：世界各國曆法

### 現代天文學中曆

- [日梭萬年曆](http://www.tianqihoubao.com/calendar/calendar.htm)，似乎是中科院背景
- [壽星天文曆](http://www.nongli.net/sxwnl/)，許劍偉、鄭彥山
- [萬年天文夏曆](https://vert.neocities.org/cld/)，哂蟹齋

### 現代天文學朔閏、交食

- [NASA Eclipse](https://eclipse.gsfc.nasa.gov/)
- [Astronomy and numerical software source codes](http://www.moshier.net/#Cephes)

### 博客

- [治曆者言](https://tambingblog.wordpress.com/) 譚冰的曆法及術數文章彙編 似乎是港中文的畢業生？出版有<v>古今曆術考</v><n>香港：三聯書店，2013</n>。

## 殘曆復原

### 參數

魏<u>韓詡</u>造<v>黃初</v>，他批評<v>乾象</v>減斗分太過<n>回歸年太小</n>，不過實際上<q>「<u>韓翊</u>所造皆用<u>洪</u>法，小益斗下分，所錯無幾。」</q><n>我據占經復原<v>黃初</v>。

晉武帝泰始十年<n>274</n><u>劉智</u><v>正曆</v><n>我據占經、宋志復原。

永和八年<n>352</n><u>王朔之</u><v>通曆</v>，<v>宋志</v>：<q>「王朔之以其上元歲在甲子，善其術，欲以九萬七千歲之甲子爲開闢之始，何承天云『悼於立意者也。』」</q>但 97000 的積年完全不對，我調整爲 352 - (97000 - 864)，九萬七千歲是舉整數而言。後來看到曲安京<v>中國曆法與數學</v>，改爲 352 - 90079 試了下<n>上元甲午歲壬子日</n>，但是前後錯開兩個月，肯定不能用。

<u>姜岌</u><v>三紀甲子元</v>。我據晉志下、占經復原。

<u>趙𢾺</u><v>玄始</v><n>玄始元年 412—北涼亡</n>。我據占經、<v>疇人傳</v>卷六復原。

<v>隋志</v>這段材料很重要，576 年：

> 訖干敬禮及曆家豫刻日食疎密。六月戊申朔，太陽虧，劉孝孫言食於卯時<n>6—7 點</n>，張孟賔言食於甲時<n>5—6 點</n>，鄭元偉、董峻言食於辰時<n>8—9 點</n>，宋景業言食於巳時<n>10—11 點</n>。至日食，乃於卯甲之間<n>6 點</n>，其言皆不能中。

這裏用的是 24 小時方位制計時。

<u>宋景業</u><v>天保</v><n>天保二年 551—亡</n>，月離表據嚴敦傑<v>補北齊書曆志</v><n><v>自然科學史研究</v>1984 年第 3 期</n>補之。問題是戊申定朔在巽時弱，距巳時<n>0.417-0.45</n>還差了一個多小時。

<u>董峻</u>、<u>鄭元偉</u><v>甲寅元</v>，據嚴敦傑<v>補北齊書曆志</v>、曲安京<v>曆法</v>頁 106 補之。曲安京說<v>甲寅</v>沒有日行盈縮，看來我判斷它是北系曆法是正確的。此前用嚴敦傑的上元積年，自己補上了入轉修正，照理說不應該有，後來用曲安京積年，不用補，非常完美。

<v>張孟賔</v>、<v>劉孝孫</v>二曆以占經復原，<v>劉孝孫</v>很完整，<v>張孟賔</v>殘缺。<v>張孟賔</v>此前積年不對，我加上了 -0.379 的經朔修正，後來用曲安京積年，就不用補了。曲安京沒有復原近點月，我用「從零開始造唐宋曆」工具復原，算得甲時少彊，完美貼合記載。日躔月離此前以<v>皇極</v>補之，但改用<v>大業</v>躔離纔能與<v>隋志</v>相合。

<v>隋志</v>還說：

> 張孟賔以六百一十九爲章，四萬八千九百爲紀，九百四十八爲日法，萬千九百四十五爲斗分。元紀共命，法略旨遠。日月五星，並從斗十一起。盈縮轉度，陰陽分至，與漏刻相符，共日影俱合，循轉無窮。上拒春秋，下盡天統，日月虧食及五星所在，以二人新法考之，無有不合。

「從斗十一起」，說明<v>張孟賔</v>沒有歲差。

<v>明克讓</v><n>武成元年 559—565</n>。我用占經的<v>梁武大同</v>來補<v>明克讓</v>。<v>隋志中</v>：<q>「初，西魏入關，尚行李業興<v>正光術</v>。至武成元年，始詔克讓與麟趾學士庾季才及諸日者定新術，采<u>祖暅</u>舊議，通簡南北之術。自斯已後，頗親其謬。故周齊並時，而曆差一日。」</q>也就是說<v>明克讓</v>綜合南北算法，跟<v>天保</v>差了一天。

<v>大象</v><n>大象元年 579—583</n>。<v>通占大象曆星經</v>與大象曆配套使用，可能是張賔所作<n>許潔<v>隋唐時期的道教星象研究</v>，<v>宗教學研究</v>2009 年第 4 期，第 29 頁</n>，也許可以用來復原大象曆。<v>隋書張冑玄傳</v>：<q>「周马显造 <v>丙寅元历</v>，有阴阳转法，加减章分，进退蚀余，乃推定日，创开此数。当时术者，多不能晓。张宾因而用之，莫能考正。」</q><v>隋書</v>：<q>「小周餘、盈縮積，其曆術別推入蔀會，分用陽率 499，陰率 9。每 12 月下各有日月蝕轉分，推步加減之，乃爲定蝕大小餘，而求加時之正。」</q>

高宗顯慶年間<n>656—661</n>印度曆法<v>九執</v>，全文見占經卷一〇四，顧觀光<v>九執曆解</v><n><v>武陵山人遺書</v>，<v>中國科學技術典籍通匯</v>天文部分 843 頁</n>

術士<u>曹士蔿</u><v>符天</v><n>780-820</n>乃民間小曆，以<q>「相減相乘法」</q>代躔離表，日法用萬分，曆元用雨水，以定氣注曆。<v>崇玄</v>本於<v>大衍</v>，而巧算源自<v>符天</v>。<n>陳久金<v>符天曆研究</v>：<u>祖暅</u>的<v>符天經</v>與後來的<v>符天曆</v>毫無關係。</n>

<v>至道</v>上元積年、回歸年、朔望月用曲安京的復原成果，其他參數參照<v>乾元</v> 995 年轉 27.1173 交 7.5243 週 323.2491，用「從零開始造唐宋曆」工具復原。

<v>乾興</v>其他參數參照<v>觀天</v> 1021 年轉 17.1709 交 6.9028 週 319.5299，用「從零開始造唐宋曆」工具復原。

<v>調元</v>。<v>新五代志</v>：<q>「以宣明之氣朔合崇元之五星，二曆相參，然後符合。」</q>失傳，以我復原的<v>符天</v>代之，參數暫用<v>崇玄</v>，算法用相減相乘法。<n>算法見陳久金<v>符天曆研究</v>。</n>劉義叟見到<v>調元</v>原文，其<v>長曆</v>可信<n>見邱靖嘉<v>遼史曆象志溯源</v>，<v>中華文史論叢</v>2012 第 4 期</n>，那麼接下來的工作就是以我復原的核對<v>長曆</v>。

<v>遼志下</v>的這段記載比較胡扯：

> 遼、漢、周、宋，俱行夏時，各自爲曆。國史閏朔，頗有異同。遼初用乙未元曆，本何承天元嘉曆法；後用大明曆，本祖冲之甲子元曆法。承天日食晦朏，一章必七閏；冲之日食必朔，或四年一閏。用乙未曆，漢、周多同；用大明曆，則間與宋異。國史敍事，甲子不殊，閏朔多異，以此故也。耶律儼紀以大明法追正乙未月朔，又與陳大任紀時或牴牾。

遼金的曆法和<v>元嘉</v>、<v>祖沖之</v>風馬牛不相及。

<v>疇人傳宋二姚舜輔</v>：

> 有司以<v>觀天</v>推崇寧二年<n>1103</n>十一月朔爲丙子。頒秝之後，始悟其朔當進而失進，遂造<v>占天術</v>，改十一月朔爲丁丑，而再頒秝焉。其法上元甲子距崇寧二年癸未，積二千五百五十萬一千七百五十九，日法二萬二千八十。

從這段描述可知，<v>占天</v>應該跟<v>觀天</v>一模一樣。我算出來<v>觀天</v>丙子 7420 不進朔，<v>占天</v> 7461 亦不當進朔。十一月在秋分至春分，進朔標準應該是 7500，這個積年是有問題的。在觀天基礎上將平朔加一刻重新算上元積年。

<v>淳祐</v>、<v>會天</v>歲實、上元積年改用曲安京引用的參數。根據<v>寶祐四年會天曆</v>，1256 年年中冬至當爲癸丑 0.25—0.26 之間。歲實、上元積年改用曲安京引用的參數。1250 年<v>開禧</v>轉 15.5498 交 23.8590，<v>成天</v>轉 15.4620 交 23.7932，範圍兩者之間。

<v>楊級大明</v>用 1180 年<v>重修大明</v>轉 19.0981 交 9.1719。

<v>乙未</v>上元積年、歲差用曲安京復原成果，其餘參數根據重修大明 1180 年轉 19.0981 交 9.1719 算得。

六部太乙曆：秦漢時期的<v>甲寅太乙</v>，南北朝的<v>宋琨太乙</v>，唐代王希明的<v>開元太乙</v>，宋代的<v>景祐太乙</v>，金張行簡的<v>太乙</v>，元曉山老人的<v>太乙統宗寶鑑曆</v>。根據曲安京<v>曆法</v>第七章補。

### 天文計算

很多曆法的天文計算闕如，我用相鄰曆法來補：

#### 月離

- **乾象** 黃初
- **景初** 劉智、王朔之、三紀
- **正光** 玄始
- **天保** 甲寅、天和、大象<n>大象、張賔曆自成一系，不當用天保補。</n>、開皇
- **大明** 梁武

#### 躔離

- **大業** 張孟賔、劉孝孫
- **麟德** 神龍
- **大衍** 至德
- 欽天：月離用五紀、紀元二曆平均<n>因爲再近一些的都是遠地點入轉了，而欽天是近地點入轉</n>，並用 9 段 248 限法重造月離表。日躔用崇玄。
- **乾元** 至道
- **崇天** 乾興
- 奉元、占天：日躔用崇天、紀元二曆平均，月離用崇天、觀天二曆平均
- 淳祐、會天：用統天、開禧、成天三曆平均
- **紀元** 楊級大明
- **重修大明** 乙未、庚午

#### 夜漏、晷長、日緯

- **四分** 顓頊、太初、乾象、黃初、景初、劉智、王朔之、三紀、玄始、正光、興和、天保、甲寅、天和、大象、開皇
- **麟德** 神龍
- **大衍** 五紀、正元
- **崇玄** 欽天日躔表有赤道內外度，但日躔月曆表均無傳，只能用崇玄代。日食黃道內外差需要用赤道內外分。
- **觀天** 奉元、占天
- **重修大明** 乙未、庚午

#### 夜漏

- **大明** 梁武
- **皇極** 張孟賔、劉孝孫

#### 晷長

- **大明** 梁武、大業、戊寅、張孟賔、劉孝孫、皇極

#### 日緯

- **四分** 元嘉、大明、梁武、大業、戊寅、張孟賔、劉孝孫、皇極
- **應天** 乾元

#### 月緯

- **乾象** 黃初、景初、劉智、王朔之、三紀、玄始、正光、興和、天保、甲寅、天和、大象、開皇
- **大明** 梁武、大業、戊寅
- **皇極** 張孟賔、劉孝孫
- **麟德** 神龍

## 开发者说明

### 1. 技术特征

- 计算程序采用 JS 编写
- 前端框架采用 React
- 朔闰表、历书采用 Web Worker，实现 UI 线程与计算线程分离
- 朔闰表采用懒加载，大幅压缩渲染时间
- 采用 WebPack 打包
- 采用 [Decimal.js](https://mikemcl.github.io/decimal.js/)<span classname="decimal64">.64</span>进行小数点后 64 位大数字运算，采用 [fraction.js](https://www.npmjs.com/package/fraction.js)<span classname="decimal64">n/d</span>进行分数运算，采用 [nzh](https://blog.whyoop.com/nzh/docs) 进行阿拉伯数字、汉字转换。采用 [react-markdown](https://www.npmjs.com/package/react-markdown) 进行文档渲染。

<del>本仓库基于组件化、工程化的考量，将核心模块<n>计算逻辑</n>拆分到了单独的仓库<n>ancient-calendar</n>中，通过子模块进行依赖，从而前端展示<n>View</n>和计算逻辑<n>Model</n>可以独立开发，前端直接引用子模块的函数进行运算。</del>

由于运算都在前端进行，在进行大量运算时会卡住 UI，体验较差。为了改进这一问题，我们决定改用 Web Worker<n>前端的多线程</n>。这样就必须将 `Worker()` 构造函数的参数文件独立放在 public 目录下<n>不能参与 webpack 打包</n>，因而不能直接引用子模块，必须将子模块打包成一个文件：

1. 全局安装 webpack，webpack-CLI

```
npm install -g webpack webpack-cli
```

2. 打包 main.js

```
webpack
```

3. `$ npm run build`

### 2. 文件功能

核心计算程序在 `/src/Cal` 目录下，有 8 个板块，各文件功能说明：

- `para_` 参数
  - `para_constant` 全局常量参数
  - `para_calendars` 各历法参数
  - `para_auto-constant` 根据历法自动选择相应常量
  - `para_generate` 生成参数的临时文件
- `newm_` 朔闰表模块
  - `newm` 朔闰计算
  - `newm_quar` 四分历朔闰计算
  - `newm_index` 朔闰计算汇总调整输出
- `day_` 历书模块
  - `day` 历书计算
  - `day_luck` 历书中岁神、日神的计算
- `astronomy_` 天文模块
  - `astronomy_acrv` 日月速度改正
  - `astronomy_eclipse` 日月交食
  - `astronomy_Accum2Mansion` 黄赤道积度转换为入宿度
  - `astronomy_formula` 使用公式进行计算的历法，`astronomy_table` 使用表格进行计算的历法，`astronomy_west` 使用现代方法进行计算。包含黄赤转换、经纬转换、月亮坐标转换
  - `astronomy_other` 積度轉宿度，進朔，月行九道
  - `astronomy_bind` 路由模块，根据历法自动选择天文计算
- `modulo_` 同馀模块
  - `modulo_continued-frac` 分数连分数
  - `modulo_continued-frac1` 小数连分数
  - `modulo_denom` 调日法
  - `modulo_exhaustion` 从零开始造宋历
  - `modulo_gcdlcm` 最大公因数
  - `modulo_origin` 演纪
  - `modulo_qiuyi` 大衍求一术
- `equa_` 方程模块
  - `equa_geometry` 几何
  - `equa_high` 解高次方程
  - `equa_math` 数字格式转换
  - `equa_sn` 垛积
  - `equa_sqrt` 开方
- `time_` 时间模块
  - `time_decimal2clock` 日分转换为辰刻
  - `time_era` 年干支转换
  - `time_jd2date` 儒略日、日期转换
- `guqin` 琴律模塊
- `output_`其他
  - `output` 输出准备
  - `output_print` 本地打印入口。`const printData = outputFile(2, 1255, 1255, 0` 第一个数字为模式，`1` 为朔闰表，`2` 为历书；第二三个数字为起始年、终止年；第四个数字为自动长历模式开关，目前暂不支持
  - `output_frontend-worker` Web Worker，朔闰表、历书两个模块的前端调用入口

### 3. 命名規範

#### 天文參數 Astronomy constants

- Solar 回歸年 solar year
- Sidereal 恆星年 sidereal year
- Lunar 朔望月 Synodic month
- Anoma 近點月 anoma month
- Node 交點月 nodical month
- SunLimit 日食食限。SunLimitYang 陽曆食限，SunLimitYin 陰曆食限，SunLimitNone 不偏食限
- MoonLimit 月食食限。MoonLimit1 月全食限，MoonLimit2 必偏食限，MoonLimitNone 不偏食限
- LeapLimit 閏限 The limit for arranging a leap
- Equa 赤道 equator
- Eclp 黃道 ecliptic
- Ecli 交食 eclipse
- Lon 經度 longitude
- Lat 緯度 latitude

#### 變量 Variables

- Origin 上元以來的
- Sols 冬至 winter solstice
- Newm 朔 new moon
- Syzygy 望 syzygy
- First 天正月，卽冬至所在月 The month in which the winter solstice falls
- Zheng 正月，建正
- LeapSur 閏餘 leap surplus
- GreatSur 大餘，干支的整數部分
- SmallSur 小餘，干支的小數部分
- LeapNumTerm 無中氣置閏法的閏月
- Duskstar 昬中星
- Accum 積日。SolsAccum 上元至年前冬至積日 AnomaAccum 入轉日 NodeAccum 入交日

#### 常量 Constants

- Sc 干支 sexagenary cycle
- Stem 天干
- Branch 地支
- Name 曆法名 calendar name
- Hexagram 八卦
- Mansion 宿
- MoonGod 月神
- ManGod 人神

#### 時間長度

- Leng 長度 length
- Range 長度
- Term 十二中氣 HalfTerm 二十四節氣
- Hou 七十二候
- Zhang 章
- Bu 蔀
- Ji 紀
- Tong 統
- Yuan 元

#### 其他

- Raw 未經某種處理的變量 Variables before processing in some way
- V 速度 velocity
- Corr 修正 correction。Tcorr 在躔離計算中爲日月速度改正，在交食計算中爲食甚時刻改正。Mcorr 食分修正
- DifAccum 日盈縮積、月遲疾積
- Avg 平均的 average
- Acr  精確的 accurate
- Deg 度數 degree
- Dif 兩個數之差 The difference between constants A and B.
- SolsDif 某日距離年前冬至的日數
- ZoneDif <v>庚午元曆</v>里差<n>地理經度時差</n>
- xxx50 某常量的 50%，xxx125 某常量的 12.5%
- xxxHalf 某變量的一半 Half of a variable
- Numer 分子 numerator
- Denom 分母 denominator。單獨出現的 Denom 爲日法 LunarDenom 的簡寫
- Num 序號 number

## 更新日誌

#### 2021-01-03

立項。

#### 2-23

內測上線。**2-24** 加入 readme；加入評論；加入 GA；加入更新日誌。
**2-26** 加入合朔日月赤度、節氣日赤度。
**2-28** 採用滾動數組，減少計算次數，重構數據結構，本地端速度提高 40%；前端相應調整，採用 Web Worker 多線程。避免 UI 與計算的衝突。今天突然發現望都不對，想了半天才發現，之前都是入曆日 +1/2 朔望月近點月之差，實際上應該是朔入曆 + 朔望月/2。
**3-02** 採用懶加載策略，只加載當前屏幕的信息。現在可以秒加載了，看來絕大部分時間都消耗在渲染上。魏晉時期的日月食基本完成。
**3-15** 增加日書、轉換 tab。增加魏晉日書，轉換工具。

#### 其他部分已解決問題

兩個倉庫合併。npm run build。ContinuedFrac' is not exported from '../src/Shangshu-calendar/convert_congruence-modulo'. 打包失敗。朔閏表疊在一起 ————四分短  長  增加唯一 id，以前都是一個所以固定高度 03-28。公元年一年只顯示一次。這個文件的函數 exports 了，如果我要在本文件中調用這個函數該怎麼辦？exports 在文件末尾就可以。連分數 latex 跟調日法、大衍串在一起了。bug 自己消失了。連分數增加 i。調日法輸入，彈出來兩數不互質。曆法選項框初始値「請選擇曆法 s」，不要讓下面的動。每個 tab 有不同的使用說明。不同的 tab 有不同的封面图，也就是不同的 tab 有不同的 classname。分數 latex 怎麼放到灰色框天文部分的 bind，相當於重複計算了 4 遍？2458849.5 儒略日 1 月 0 日。乾象月緯隔幾天就我有一個消失。景初月赤緯不對，一正一負。紀元月赤經距離冬至超過一半就不行。丟失精度，算不出來：章法：把魏晉的全部過了一遍，興和、天保、甲寅、大象曆數字太大，超過達到 20 位？？不知道是不是因爲這個。但是天和就算得出。奇怪……看了下，和李銳調日法是否算得出沒有關係。分數的最小公倍數，lcmNumer。曆書：大衍、庚午的月亮跑不了——MoonLatAccumList: [0, 0, 187, 358, 505, 620, 695, 722, 695, 620, 505, 358, 187] 最後漏了一個 0。天文的月亮，乾象、大明每次點都會縮小，中了魔咒一樣 ——變量名的問題。日書加上曆法名。日書月名沒有閏月。前兩日九宮亂入。宣明沒有黃道度

#### 4-21 公測上線

版本：核心 `0.90` 前端 `1.00`

#### 4-25 `0.91 1.01`

4 月 24 日本站編入 Google 索引 **核心** 增加時刻轉辰刻。日赤緯、日出公式曆法加上了日躔，至少紀元能跟論文合。授時明天還不對。訂正躔離：重新整理月離表的邊界；修改明天躔離；唐系日躔改用不等間距內插。宋志「紹興四年<n>1193</n>十二月<n>紀元</n>小餘七千六百八十，太史不進，故十一月小盡」。一個迷思：若索引從 1 開始，小餘 8285 左右，與大統相合，若索引從 0 開始，則是 7681，雖與引文相合，但與大統差了太多。我目前還是從 1 開始索引。修改定朔望小餘問題；修改定氣問題。 **前端** 調整文件結構：拆分時間板塊；拆分朔閏表板塊；加入曆書年份限制。

#### 4-29 `0.92 1.01.1`

 **核心** 天文模塊增加交食、交食週期與交點月換算。增加魏晋南北系、大業、戊寅、麟德、大衍交食。元嘉非常奇怪，原來的交會差，單算入交日的話跟其他曆都不一樣，但是最後結果是一樣的，迷惑。現在已有的食甚改正，有些方向都是相反的，奇怪。調整魏晉系閏餘單位，本來想把古六曆閏餘改成 19，發現顓頊不好改，放棄。增加 fraction.js。 **前端** 文件改名。升級依賴。辰刻轉換由文字換成表格。修改表格 css

4-29 晚 `0.92.1 1.01.2`

 **核心** 修復四分曆跑不來的小問題：未把調用交食排除。調用交食模塊之前先用去交日篩選，大大節省算力。30 以內的阿拉伯數字轉漢字換成列表，能快一點；朔閏表月序改成漢字 **前端** 實現了``內 html 標籤：曆書九宮色添加背景色；朔閏表表頭增加樣式，交食進朔符號添加顏色

#### 5-02 `0.93`

 **核心** 重要更新：重構躔離。此前一直用的 (日盈縮積 - 月遲疾積) / (分母) 來計算日月改正，發現並不是這麼回事，大部分曆法都能適用，但是崇玄、應天、儀天、崇天、統元、大衍、乾元這七部曆法的月行改正分母並不固定，算出來大衍的差距能達到 8 刻之巨，所以只好重新錄入所有曆法的朓朒積，再直接用招差術或拉格朗日內插計算。數據已根據陳美東的日躔月離表兩篇論文訂正<n>乾元陳美東 843 改成 850，奇怪，「四十三」和「五十」怎麼會錯呢</n>。修改宣明、應天、儀天月離，此三曆較特殊，月離表分爲兩截，此前我都合爲一個。給所有曆法補上定氣積日表。大幅精簡天文模塊 bind 的代碼。入轉日、入氣日、入交日索引全部統一從 0 開始。修改望也進朔的小 bug。

#### 5-03 `0.94 1.01.3`

 **核心** 增加所有曆法的沒滅。修復大衍交食，與頁 538 算例相合，完美可靠。修復曆書月名的小問題。曆書的候土卦從 0 索引，修正土卦相差一日的小問題。修復四分曆書沒有 13 個月的小問題。精簡一些寫法。 **前端** 小優化：節氣增加底色等

#### 5-05 `0.95 1.01.4`

 **核心** 訂正天文曆：加入唐宋曆月行九道；調整結構，加上躔離、定交改正。修正乾象、大衍等月緯。日經、昏中爲夜半，日緯爲正午。變量改名。修復：唐系日躔 340 日以上 NaN，訂正躔離亂七八糟的符號，現代擬合的小 bug，優化魏晉南北系月離運算速度。整理月亮位置轉換<n>皇極大衍黃白差沒問題：黃道 44，黃白差-1.47<n>頁 60</n>，其他應該也沒什麼問題</n>。疏理黃赤轉換，補上宋曆黃轉赤反函數。增強會圓術，增強弧矢割圓，推廣到三角函數。 **前端** 調整曆書樣式

#### 5-09 `0.96 1.02`

**核心** 1、補出弧矢割圓赤轉黃，冥思苦想，畫了好幾種輔助線，最後得來全不費工夫；弧矢割圓加上了任意黃赤交角；訂正弧矢割圓緯度、日出；補上三角割圓赤轉黃；訂正三角割圓，修正球面三角的赤緯轉換，現在三角割圓總算與球面三角全等了。會圓術刪掉週天度和半徑的選項。2、加上授時月亮位置，太難了，結果依然不對。2、大調整，積度轉宿度模塊：Accum2Mansion 取消統一計算，分散在各日中，要不然實在不好切。各曆朔閏表赤道日度、昏中星，天文曆日月度應該都差不多了。宋元昏中星尚不能確定，一般情況應該沒什麼問題；後漢四分昏中星跟表比起來，二至都是對的，其他時候少 1 度。每日月亮位置，<v>中</v>頁 514：大衍算法有問題，欽天以後都改用另外的算法，我統一用宋代算法。3、簡化寫法。增加一個分析日行改正誤差的小片段<n>沒放到前端</n>。 **前端** 重新用上 react-markdown，把所有的<p className='note>全都移到 md 文件中，爲了方便翻譯。寫了一個下午文案，加上參考文獻，增加命名規範。

#### 5-10 `0.97`

**核心** 1、重寫土王、推卦，乾象景初用京氏，其餘用孟氏。增加「月在張心署之」。2、根據大衍曆議修改歲差：復原梁武大同歲差宿度；修復梁武大同跑不起來的問題；劉孝孫上元改爲虛 8。各曆朔閏表的赤度、昬中應該沒什麼問題了。3、大衍黃赤轉換改爲和崇天一樣；公式晷長取消日躔。4、補充、重寫時辰轉換，徹底清楚了。5、增加所有曆法的進朔退望，圓夢了。6、一個系統性 bug：閏月進退的 NewmOrderRaw 竟然一直用的平朔。7、清理朔閏表用不到的傳參，精簡變量；取消四分以後的大小餘。

#### 5-12 `0.98 1.03`

**核心** 1、增加四大三小提示。試了下大衍，四大情況非常常見，需要手動調整。2、天文曆修改月亮經度算法，應該不會差太多了。躔離計算增加月實行度。修改月行九道的判斷條件。修復半月離曆法的疏忽。3、增加積度宿度互換。4、修改天文常數精度。修復一個時辰轉換小疏忽。**前端** 1、網頁調整目錄結構：幾何搬到天文標籤。2、加個 contributors wall

#### 5-14 `0.99`

**核心** 1、重寫九道術、授時黃白轉換。授時依然有問題，太難了，只能先放著。2、重寫公式曆法的月亮緯度。3、修改九道對應小問題。修復四分跑不起來。修復一些曆書跑不起來。

5-17 `0.99.1 1.03.1`

**核心** 增加戊寅定朔平朔的區別，在路由文件用 isAcr 實現。**前端** 標籤懸浮變成手。@跟着小徐混

5-18 `0.99.2 1.04`

**核心** 改進四大三小提示：連上了第二年的情況。修復進朔干支序的邏輯。修復麟德不進朔的閏月調整；修改五紀正元的閏月調整標準，因爲進朔比較嚴格；閏月調整標準提到 2.75，否則統元 1145-1146 的閏月提前失效。修復符天、應天跑不起來。 **文字** 增加朔閏表可靠性驗證

#### 5-19 `0.991 1.04.1`

**核心** 這個版本主要是殘曆復原。修改甲寅、張孟賔參數，劉孝孫張孟賔躔離改用大業。修改梁武大同歲差；應天、至道、乾興、奉元、楊級、乙未、淳祐、會天歲差改用曲安京復原結果。楊級、淳祐、會天根據曲安京引用的參數重新構擬。增加至道、乾興、乙未、太乙曆法、元命苞。補上奉元、占天天文曆，曆書補上 OriginDaySc。 **文字** 殘曆復原單獨抽出來。修改朔閏表可靠性驗證

5-20 `0.991.1 1.05`

**前端** 終於實現了自動長曆功能！勾選了自動選擇之後，也可以另外手動選擇曆法，作爲參照。**核心** 進朔定朔、進朔日出分改成線性內插。修復四分、神龍跑不起來；修復統元跑不起來：沒月離表。

明天觀測精度很成問題，和紀元、統元比，入轉差了 3 日，入交差了 1.6 日。明天上元以陰曆入交。

5-20 晚 `0.991.2 1.05.1`

**核心** 1、修復定朔定氣等等缺省的情況，主要針對太乙曆。2、根據一段材料重新構擬占天。3、增補交食參數。觀天入交很奇怪，暫時重新擬一個 node。增加大統交差，似乎是陰曆入交。4、合併 NodeConst、NodeOrigin、NodeConst，AnomaConst、AnomaOrigin、AnomaConst。5、酌情改幾部南宋曆的上元宿度，改統天的宿度。6、修復兩半月離曆法在邊界的線性改正問題，比如宣明 865 二月、885 五月線性、二次差了很多，應天 968 四月癸丑 7733、981 三月。7、修復積度宿度轉換的小問題。 **前端** cal 目錄的 package.json 合併到根目錄

5-22 `0.991.3 1.05.2`

**核心** 增加 AutoNodeCycle、AutoSidereal、AutoSolar，統一一些常量。變量改名。暫且將五紀正元進朔標準降低 10 刻。修復宣明月度 NaN 的問題：黃赤轉換、九道術暫時用大衍的。修復本地曆書打印的小問題。 **前端** 標籤換個順序。 **文字** 增加一些和敦煌具注曆的核對。

#### 5-24 `0.992`

**核心** 【重構月離】近點月轉折點的特殊情況<n>卽四七日</n>不能通過內插得到，只能手動輸入，錄入唐宋損益率。增加唐宋曆月離損益率自動選擇模塊 AutoMoonTcorrDif。取消宣明應天儀天的兩組月離表，合爲一表，但加以區分對待。恍然大悟，儀天不是分成兩半，而是分成四部分，獨此一曆。戊寅以前都沒有針對四七日的特殊算法，暫且不管，皇極以後纔有。皇極稍有些特殊，我暫時統一按照後來的處理方式，但區別應該不大。修復其他相關 bug。現在四七日的線性改正都完美了，比如 900 年<v>五紀</v>五、七月就跟原來不一樣。優化一些代碼。但月實行度還不太確定各曆的相應算法。

#### 5-27 `0.993`

**核心** 又用了兩天時間來【重新梳理躔離】麟德應天乾元三曆的日躔不是標準二次內插，進行單獨處理。月離區分唐宋。現在問題應該不大了。詳見 **文字** 增補躔離說明「線性還是二次？」

#### 5-27 晚 `0.994`

**核心** 根據曲安京<v>曆法</v>頁 251 重寫大衍月緯算法，此前用的三次招差術。但是其中符號還不太敢確定。

#### 6-07 `0.995`

正式版前的最後一個版本！！

1、增加唐宋、授時交食。太複雜了，斷斷續續兩個月了。

2、精簡反減的寫法。按照術文是這樣：

```javascript
aRev = a
if (aRev > 0.25) {
  aRev = 0.5 - aRev
}
```

其實等價於 `aRev = 0.5 - abs(a - 0.5)`。

精簡數組前面加一個 0 的寫法：

```javascript
a = a.slice(-1).concat(a.slice(0, -1))
a[0] = 0
```

換成

```
a = [0, ...a]
```

精簡簡單的條件判斷

3、生成欽天、至道、乾興、奉元、占天、淳祐、會天躔離。

4、修復月實行積度的疏忽。修復崇玄月遲疾積。修復黃赤轉換小問題。

5、把生成參數的單獨抽出來一個文件。

6、天文模塊增加交點退行速度、交率交數計算。

7、增加 AutoQuar 自動選擇象限長度。

8、一些變量改名。

**文字** 增加唐宋授時步交會、欽天步月、歲實消長等。文字說明已有四萬八千字。

#### 6-12 `1.00 1.05.3`

**正式版發布！**

1. 重寫大業、戊寅、麟德交食，拆成三個模塊。修復應天、崇天、紀元、授時交食，基本可用了
2. 修復張孟賓、劉孝孫、戊寅小問題
3. 時間模塊增加：小數 ⇒ 弱半彊，時刻 ⇒ 夜籌更點，加時 ⇒ 小分
4. 重寫統天、授時歲實消長
5. 天文模塊增加歲實朔實消長
6. 增加早期授時，分爲有無消長四種
7. 加上庚午里差
8. 精簡寫法：聲明變量放在一行；把所有 *= /= 過了一遍，應該沒問題
9. 修復四分沒有黃道度的小問題。修復占天入交。明天增加一個交食晝夜限制

**前端** 表格線全部取消，清爽多了。markdown 增加表格渲染

**文字** 增補歲實消長說明。總計五萬二千字。

6-12 下午 `1.00.1 1.05.4` **核心** 給所有四分曆加上月食計算。修復天文模塊日食的問題。調整一下欽天時差。修復四分沒顯示朔小分的小問題。修復宣明二次月離。**前端** 調整九宮色 css

6-13 `1.00.2` **核心** 增強加時轉約餘。把所有 `.includes()` 過了一遍，沒問題。

6-14 `1.00.3` **核心** 修復大統交應。修復授時歲差消長。**文字** 增加大統交食驗證

#### 6-16 `1.01 1.05.5`

**核心** 增加晷影求冬至時刻。**前端** 調一下標籤選擇的樣式

#### 6-19 `1.02`

 **核心** 明晰授時系的區別：授時、大統通軌<n>實行</n>、大統曆志。將大統晨昏分換成應天晷刻。徹底解決授時系交食：交定度、月食食分、食延、TheSolsDif 定義。修改授時系限行度，躔離改正完全沒問題了。修復閏月調整問題：本來是 `LeapNumTerm >= 2`，換成 1。修改步軌漏夜半的定義。 **文字** 凡五萬九千字。

#### 6-21 `前端 1.06`

調整代碼結構：把 AutoCal 的實行年份、Bind 的 `Type, isAcr, isNewmPlus` 全部移到曆法參數中，兩個曆法參數文件合并，刪掉 `bind.mjs`。

6-23 `1.02.1` 修復授時建子 NaN 的小問題，定氣閏月也有的小問題。

6-24 `1.02.2` 天文模塊的回歸年計算換成 VSOP87 曆表。前端 `1.06.1` 曆書表格微調

6-24 `1.03` 增加李淳風乙巳元曆，只有平朔。

6-27 `1.03.1` 調整招差術輸出的取值精度

#### 6-27 `1.04`

增加琴律計算模塊。

7-04 `1.04.1` 增加所有調的品弦法，準法律側弄調還很奇怪。

7-31 `1.04.2` 調整魯曆

#### 10-22 `1.05`

增加減字譜轉唱名。

10-25 `1.05.2` 優化代碼 [Code Review on Math Lib #8](https://github.com/lzfcc/Chinese-Ancient-Calendar/issues/8)。主要是 `_math.mjs` 文件

10-25 `1.05.3` 優化代碼 [Code Review #9](https://github.com/lzfcc/Chinese-Ancient-Calendar/issues/9)。簡化解高次方程寫法

10-26 `前端 1.07` 調整函數接口：字符串 `'1,2,3'` 全部換成數組  `[1, 2, 3]` 。全部改下來頗麻煩

10-27 `1.06` 減字譜轉音高增加徵弦。增強 fret2leng，增加 leng2fret

10-28 `1.06.1` 優化代碼  [Code Review #10](https://github.com/lzfcc/Chinese-Ancient-Calendar/issues/10)

10-31 `1.06.2` 優化代碼 `guqin.mjs`

11-01 `1.06.3` 增加 [] qi shang xia

11-04 `1.06.4` 重寫品弦法

11-08 `1.07` 增加京房六十律。個人數學庫增加大分數乘法計算。

11-10 `1.07.1` 增加幾種品弦法。品弦法增加唱名。修復徽位轉音高突然跑不起來的小 bug。

11-13 `1.07.2` 再次重寫品弦法，改成數組。增加宮弦選項。增加側羽側楚。

11-16 調整文字說明，成文的遷移到赫赫金鑰。

11-17 `1.08` 增加徽位音。修復位置轉音高。11-19 品弦法增加音名。`1.08.1` 11-23 正弄調增加混合律制 11-24 `1.08.2` 增加其他混合律制。徽位轉音高，輸出音名改成固定的。

11-27 `1.09` 增加䠂大小正，據武家璧《简论楚颛顼历》。

11-28 `1.10` 增加律內音。

12-01 `1.11` 增加十九等程律、四分折中律、三分折中律 12-02 何承天新律 `1.11.1` 12-07 徽位音增加泛音

12-27 `1.12` 增加筮占模塊，暫時有一種大衍筮法。修復拉格朗日小 bug

#### 2022

3-01 `1.12.1` 調整一下授時曆的類別。這兩天又有一個流量高峰（69 人/日），感謝幫忙打廣告的陌生人

3-05 `1.13` 增加徐發《天元曆理全書》的曆法。只有基本參數，日月改正還是用的授時。

#### 2023

4-21 `1.14` 增加清華簡《筮法》構擬。周易筮法算法調整為通行算法。前端 `1.07` 更新依賴：node 18.16.0, webpack 5.80.0

#### 2024

1-26 `1.20` 增加《曆象考成後編》朔閏表、交食。

1-30 `1.21` 精簡古曆入宿度，把西曆入宿度整合進來。大幅精簡古曆判斷閏年的方法，精簡古曆的節氣，在newm_index與時憲曆合併。四分曆想精簡，失敗。

2-01 `1.22` 增加時憲曆曆書，曆書`day`分為古曆和時憲曆兩個文件。朔閏表增加節氣。

2-11 `1.23` 增加曚影計算。增加西曆赤道度。定朔望气日分用五位小數，單位改成刻。增加節氣的迭代精確時刻。修復一處四分曆不能計算的小小問題。

2-？？ `1.24` 增加《曆象考成》朔閏表、交食、曆書。

### Todo list

##### 核心

- 遙遙無期的五星計算
- 唐曆月離的第二遍修正<n>影響很小，最多 5/10000 日</n>
- 增加黃道過宮<n>不重要</n>
- 增加九服晷漏、九服食差<n>不重要</n>
- 細化曆書的日神<n>不重要</n>

##### 前端

- 雙語支持
- 新的曆法選擇框

### Known Issues

##### 核心

- 九道術、授時黃白轉換尙不可靠<n>太難了，以後再說</n>。天文曆的月亮位置估計也有點問題。
- 日月食計算應該還有一些小問題：<v>應天</v>怪怪的。
- <v>劉孝孫</v>入交不對。
- <v>觀天</v>入交。重新擬了一個交點月，暫時解決，以後再研究。
- <v>五紀</v>、<v>正元</v>月緯的比例沒找到，只能先暫時瞎填一個湊數。

##### 前端

- 現在打包文件已經超過了 244kb 的推薦大小，可能因爲這個第一次計算很慢。
- 朔閏表比如 1111 年統天、會元、開禧會重在一起
