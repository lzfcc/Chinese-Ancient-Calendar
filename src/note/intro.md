## 簡介

1.  本工具的使用對象是古代天文曆法研究者。對於一般文史研究者，推薦使用下面的友情鏈接<n>當然，「時間」板塊的三個工具還是挺有用的</n>。
2.  目前的古代朔閏査詢網站都是根據工具書、文獻材料手動調整的<n>參考中研院 [兩千年中西曆轉換說明書](https://sinocal.sinica.edu.tw/lusodoc.html)，廖育棟 [本網站的農曆編算](https://ytliu0.github.io/ChineseCalendar/computation_chinese.html)</n>。本工具可提供古代實行未實行的 60 餘部曆法<n>包括我復原的 8 部魏晉南北朝曆法、2 部隋曆、3 部唐曆、5 部宋曆、1 部金曆</n>的計算，完全遵照各曆算法進行全自動計算，無手動干預。主要有三大功能區：
    1.   **朔閏表** 每年的積年、冬至大小餘、閏餘；冬至時刻的入轉日、入交泛日、入週天度。各月定朔<n>線性內插、二次三次內插</n>、平朔，定朔時刻日月所在赤道度，定望，平氣、定氣、定氣日昏中星。日月食食甚時刻、食分。
    2.   **曆書** 包含天文曆、具注曆兩部份。
        1.  天文曆：每日太陽赤經、極黃經宿度，日赤緯、日出時刻、正午晷長，月赤經、月赤緯、月行九道/三道。預計 2022 年將推出五星計算。
        2.  具注曆：每年「術數年」積年、男女九宮，年干支五行、納音、魁罡之月，23 種歲神，年九宮色。每月月建、月神、吉時、月九宮色。每日干支、儒略日、公曆日期、納音五行、建除、黃道吉日黑道凶日、七星值日、二十八宿二十八禽值日，二十四節氣時刻、七十二候時刻、沒滅日時刻、土王用事時刻、卦用事時刻，人神、日遊神、血支血忌，10 種日神。
    3.   **數學工具** 包含同餘、方程、天文、時間四個板塊。
        1.  同餘：大衍求一術、解一次同餘式、大衍總數術，擬秦九韶調日法、淸人調日法三種、連分數，最大公因數、章蔀紀元法，古曆入元、秦九韶演紀法，從零開始造唐宋曆。
        2.  方程：~~九章算術開方術、累減開方術，~~二分迭代法解高次方程，隙積術芻童垛、三角垛落一形垛、四角垛方垛，招差術、拉格朗日內插，會圓術、弧矢割圓術、三斜求積術。
        3.  天文：日躔月離及誤差，太陽赤黃經轉換及誤差，太陽去極度、赤緯、日出、晷長及誤差，月亮極白經、赤經、極黃緯，現代天文任意時刻太陽高度、方位角、晷長。
        4.  時間：將萬分小數轉換爲辰刻，儒略日、日期轉換，公元年、年干支轉換。
3.  如您發現任何問題，可通過評論框或郵件向我反饋。若您在研究過程中發現程序結果與文獻不符，望不吝提供線索。這個工具是根據研究需要而開發的，如果您有任何功能需求，敬請與我聯繫，我會在力所能及的範圍內儘量實現。
5.  本工具與以往的朔閏表工具書是相互補充的關係，古人算曆有可能不會完全依照術文，會根據實際情況適當調整，這種情況下我們的計算程序就無能爲力。
6.  本工具完全開源，如您需要査詢、核査各曆的詳細參數與算法，請前往源碼倉庫。如您不嫌麻煩，可以下載源碼，在本地運行程序。更多技術特徵見開發者說明。全站文件大小：16.3MB，核心計算邏輯：246KB。 **隱私聲明** 本站使用了 Google Analytics 進行流量分析；評論系統採用 Hyvor Talk；服務器託管在 Netlify 平臺。運算均在本地瀏覽器進行。

## 網站推薦

### 年表

- [廖育棟的網站](https://ytliu0.github.io/ChineseCalendar/index_chinese.html)年曆、氣朔時刻、中國歷史年表、儒略日干支轉換等
- 中研院 [兩千年中西曆轉換](https://sinocal.sinica.edu.tw/)
- [歷史車輪中西曆轉換器](https://www.lishichelun.com/calendar/switch)

### 實行曆法

- [和暦(わごよみ)　& 中華暦（からごよみ）](http://www.wagoyomi.info/) 〔寶藏！〕
- [時憲曆計算](http://ytliu.epizy.com/Shixian/index_chinese.html)
- [紀年轉換工具](https://kanasimi.github.io/CeJS/_test%20suite/era.htm)：世界各國曆法

### 現代天文學中曆

- [日梭萬年曆](http://www.tianqihoubao.com/calendar/calendar.htm)，似乎是中科院背景
- [壽星天文曆](http://www.nongli.net/sxwnl/)，許劍偉、鄭彥山
- [萬年天文夏曆](https://vert.neocities.org/cld/)，哂蟹齋

### 現代天文學朔閏、交食

- [NASA Eclipse](https://eclipse.gsfc.nasa.gov/)
- [Astronomy and numerical software source codes](http://www.moshier.net/#Cephes)

### 博客

- [治曆者言](https://tambingblog.wordpress.com/) 譚冰的曆法及術數文章彙編 似乎是港中文的畢業生？出版有<v>古今曆術考</v><n>香港：三聯書店，2013</n>。

## 曆法更迭一覽

### 1、

1. **三代**皆觀象授時。<u>堯</u>時一年爲 365 日。

2. **春秋晚期**產生推步曆法，此時的算法不可考。春秋時期的實行曆譜可以參考最新研究：郜積意<v>經學與曆學的貫通——春秋朔閏表與經文歷日考證</v><n><v>學術月刊</v>2020 年 1 期</n>「晉魯曆不同，非周正夏正之差。魯曆與列國曆法互異，以置閏有殊，故月每差一月；以朔法不一，故日每差一日。」

3. **戰國**

   1. 戰國早期推步曆法走向成孰，產生了<v>殷曆</v>、<v>雨水元夏曆</v><n>如果有的話</n>。楚國也許用建丑<v>殷曆</v>。
   2. 戰國中期有<v>魯曆</v>、<v>顓頊曆</v>。
   3. 戰國晚期有<v>黃帝曆</v>、<v>周曆</v>、<v>夏曆</v>。<n>古六曆合天時間見廖育棟 [古六曆的計算方法](https://ytliu0.github.io/ChineseCalendar/guliuli_chinese.html)</n>

4. **秦至漢武帝** <v>顓頊</v>。根據出土材料，可以瞭解到顓頊曆經過了多次調整，分爲如下階段<n>據朱桂昌<v>顓頊日曆表</v>，中華書局 2012，並且我自己調整了一個階段</n>。目前方案合於惠帝三年簡<n>張培瑜等<v>中國古代曆法</v>，中國科學技術出版社 2008，頁 247</n>。有一條不合：秦王政廿年前 237，七月甲寅，<n>進餘 3/4</n>卻是乙卯。
   1. <n>秦獻公十九年前 366—秦武王四年前 307</n>建寅，以寅月<n>冬至所在月爲子月</n>爲正月、爲年首，與漢代以後絕大多數曆法相同。
   2. <n>秦昭王元年前 306—秦莊襄王三年前 247</n>建寅，以寅月爲正月，以十月爲年首，卽一年十二個月的順序爲 10-11<n>冬至月</n>-12-1-⋯-9。這就是標準的<v>顓頊曆</v>。
   3. <n>秦始皇元年前 246—秦二世三年前 207</n>小餘增加 3/4 日。
   4. <n>漢高帝元年前 206—呂后三年前 184</n>小餘在上一階段基礎上減去 210/940 日。<n>四分曆法一月爲 29+499/940 日，940 卽日法</n>
   5. <n>呂后四年前 183—文帝後元元年前 163</n>變閏章，之前是固定冬至置閏法的閏章，現在是無中氣置閏法的閏章，但是閏月依然放在年末，卽後九月。
   6. 在上一階段基礎上退餘 25/940 日<n>文帝後元 2 年前 162—武帝元封 7 年前 104 年 4 月</n>文帝後元二年。
   
5. **漢武帝至章帝** <u>鄧平</u><v>太初</v>、<v>曆術甲子篇</v><n>太初元年前 104 年 5 月—章帝元和二年 85 年正月</n>。這期間行<v>太初曆</v>，但可能也用<v>曆術甲子篇</v><n>見<v>史記</v>，爲古四分曆，我在<v>殷曆</v>基礎上減去朔餘3/4，以爲太初元年冬至朔旦夜半</n>作爲推步參考。太初改曆的內容：1、曆元從立春改爲年前朔旦冬至。2、正月爲歲首。3、行<u>鄧平</u>曆。4、歲末置閏改爲無中置閏。5、藉半日法：用途是<q>「月或朔見」</q>，其實就是承認後天半日。<n>見<v>中國古代曆法</v></n>

6. **漢章帝以後** <v>後漢四分</v><n>章帝元和二年 85 年 2 月—漢末</n>。

7. **三國兩晉**

   1. 蜀<n>221-263</n>以漢統自居，沿用<v>後漢四分</v>。
   2. <u>劉洪</u><v>乾象</v><n>吳黃武二年 223—280 吳亡</n>。<q>「二年春正月⋯⋯改四分，用乾象歷。」</q><n><v>三國志卷四七</v></n>
   3. <u>楊偉</u><v>景初</v><n>魏明帝景初元年 237—終晉沿用<v>景初</v>—劉宋<v>元嘉</v>行用之前</n>。

8. **南朝**

   1. <u>何承天</u><v>元嘉</v><n>宋元嘉廿二年 445—509</n>。
   2. 祖沖之<v>大明</v><n>梁武帝天監九年 510—陳亡 589</n>。經過<u>祖沖之</u>之子<u>祖暅</u>力爭，得以行用。

9. **北朝**<n>參考 [廖育棟](https://ytliu0.github.io/ChineseCalendar/NorthSouth_Calendars_chinese.html)</n>
   1. **後秦** <n>384—417</n><u>姜岌</u><v>三紀甲子元</v>。[姜岌<v>三紀甲子元曆</v>行用年份考](https://tambingblog.wordpress.com/2013/10/10/姜岌<v>三紀甲子元曆</v>行用年份考/)
   2. **北涼** <n>397—439</n><u>趙𢾺</u><v>玄始</v><n>玄始元年 412—北涼亡</n>。
   3. **北魏** <n>386—534</n>
      1. <v>景初</v><n>建都平城 398—451</n>。
      2. <v>玄始</v><n>文成帝興安元年 452—522</n>
      3. <u>張龍祥</u><u>李業興</u>等九家綜合而成<v>正光</v><n>孝明帝正光四年 523—558</n>。
   4. **東魏** <n>534—550</n><u>李業興</u><v>興和</v><n>興和二年 540—亡</n>。算法全襲正光，僅參數不同。
   5. **北齊** <n>550—577</n><u>宋景業</u><v>天保</v><n>天保二年 551—亡</n>。
   6. **西魏** <n>535—557</n>沿用<v>正光</v>。
   7. **北周** <n>557—581</n>
      1. <v>明克讓</v><n>武成元年 559—565</n>。
      2. <u>甄鸞</u><v>天和</v><n>天和元年 566—578</n>。
      3. <u>馬顯</u>丙寅元<v>大象</v><n>大象元年 579—583</n>。
   
10. **隋** <n>581—618</n>

    1. <u>張賔</u><v>開皇</v><n>隋開皇四年 584—開皇十六年 596</n>，以<v>元嘉</v>、<v>大象</v>爲基礎，得以行用。劉孝孫批評<v>張賔曆</v>粗疏，劉孝孫被罷。劉孝孫死後，楊素等舉薦<u>張冑玄</u>。
    2. <u>張冑玄</u><v>大業</v><n>開皇十七年 597—亡</n>。另有<v>張孟賓</v><n><u>張孟賔</u>和<u>張賔</u>是兩個人</n>、<v>甲子元劉孝孫</v>，二人同爲張子信門生。劉焯採<v>劉孝孫</v>，稍損益以爲<v>皇極</v>，與<v>大業</v>頗有參差，最終<v>大業</v>得以行用。這一時期的紛紜可以參考王荣彬 [隋初改历之争](https://www.mmzy.org.cn/qunyan/pmjl/201811/81247.aspx)。

11. **唐**

    1. <u>傅仁均</u><v>戊寅元</v><n>高祖武德二年 619—664</n>。
    2. <u>李淳風</u><v>麟德</v><n>高宗麟德二年665—728</n>。
    3. <u>一行</u><v>大衍</v><n>玄宗開元十七年 729—757</n>。有所謂<q>「<v>大衍</v>寫<v>九執</v>」</q>公案。
    4. <v>至德</v><n>乾元元年 758—上元三年 762</n>。算法全襲<v>大衍</v>，節氣推後二日。
    5. <u>郭獻之</u><v>五紀</v><n>肅宗寶應元年 762—783</n>
    6. <v>正元</v><n>德宗興元元年 784—806</n>。<v>五紀</v>、<v>正元</v>綜合<v>大衍</v>、<v>麟德</v>，唯唯而已。
    7. <u>徐昂</u><v>觀象</v>穆宗元和二年 807—821。「察斂啓閉之候，循用舊法，測驗不合。」沒有任何線索，只能用<v>正元</v>來補。
    8. <u>徐昂</u><v>宣明</v><n>822—892</n>。<v>宣明</v>晷漏、交會稍增損，更立新術以步五星，其餘沿襲<v>大衍</v>。
    9. <u>邊岡</u><v>崇玄</v><n>昭宗景福二年 893—950</n>。 

12. **五代** <n>907—960</n>

    1. **梁、唐、漢**沿用<v>崇玄</v>。
    2. **晉**<u>馬重績</u><v>乙未元調元</v><n>天福五年 940—946</n>
    3. **周** <n>951—960</n><u>王樸</u><v>欽天</v><n>後周顯德三年 956—周亡，宋初 960—963 沿用</n>沿用。

13. **契丹遼** <n>907—1125</n><n>參 [廖育棟](https://ytliu0.github.io/ChineseCalendar/LiaoJinYuan_Calendars_chinese.html)</n>

    1. <u>馬重績</u><v>調元曆</v><n>應曆十一年 961 司天王白、李正等進曆—993</n>。
    2. <u>賈俊</u><v>大明</v><n>統和十二年994—亡</n>。
    
14. **金** <n>1115—1234</n>

    1. <u>楊級</u><v>大明</v><n>天會十五年 1137—1181</n>
    2. <u>趙知微</u><v>重修大明</v><n>大定廿二年1182—亡，蒙古沿用至 1281<v>授時</v></n>

15. **宋** <n>960—1279</n>

    1. 王處訥<v>應天</v><n>964—982</n>建隆四年 963 成。宋代行用時間見<v>中國古代曆法</v>第606頁
    2. 吳昭素、徐瑩、董昭吉各上新曆，最後用<u>吳昭素</u><v>乾元</v><n>983—1000</n>。
    3. <u>史序</u><v>儀天</v><n>1001—1023</n>。
    4. <u>宋行古</u><v>崇天</v><n>1024—1064，中間用<v>明天</v>，後又用<v>崇天</v>1068—1074</n>。
    5. <v>明天</v><n>1065—1067</n>。歷史背景見董煜宇<v>从奉元历改革看北宋天文管理的绩效</v><n><v>自然科學史研究</v>2008年2期</n>
    6. <u>沈括</u>、<u>衛樸</u><v>奉元</v><n>1075—1093</n>不存，以<v>觀天</v>代之。
    7. <v>觀天</v><n>1094—1102</n>。
    8. <v>占天</v><n>1103—1105</n>失傳。
    9. <v>紀元</v><n>1106—1127</n>
    10. 失載<n>1128—1135</n>，以<v>紀元</v>代之。
    11. <v>統元</v><n>1136—1167</n>
    12. <v>乾道</v><n>1168—1176</n>
    13. <v>淳熙</v><n>1177—1190</n>
    14. <v>會元</v><n>1191—1198</n>
    15. <v>統天</v><n>1199—1207、1208—1251</n><v>開禧</v>期間與<v>統天</v>並推。
    16. <v>開禧</v><n>1208—1251</n>
    17. <v>淳祐</v><n>1252—1252</n>失傳。
    18. <v>會天</v><n>1253—1270</n>失傳。
    19. <v>成天</v><n>1271—1276</n>
    20. <v>本天</v><n>1277—1279</n>失傳。

16. **元** <n>1206—1370</n><u>郭守敬</u>等<v>授時</v><n>1281—1367</n>

17. **明** <n>1368—1644</n><v>大統</v><n>1368—1662</n>。

18. **清** <n>1644—1911</n>時憲曆

    1. <v>西洋新法曆書</v><n>1645—1679</n>
    2. <v>康熙永年曆法</v><n>1680—1726</n>
    3. <v>曆象考成</v><n>1727—1733</n>
    4. <v>曆象考成後編</v><n>1734—1913</n>

<v>大統</v>存在版本的區別，主要是閏應、轉應、交應三應及月食時差、定用分、旣內外分算法。我根據相關資料理出下表，詳見李亮<v>明代曆法的計算機模擬分析與綜合研究</v>3.3 節。

|        | 授時<n>曆經</n>                      | 大統<n>通軌</n>                                     | 大統<n>曆志</n>                              |
| ------ | --------------------------------- | ------------------------------------------------ | ----------------------------------------- |
| 曆元   | 至元辛巳                          |                                                  | 洪武甲子                                  |
| 閏應   | 20.1850                           | 20.2050                                          | 18.20708                                  |
| 轉應   | 13.1904                           | 13.0205                                          | 20.9690                                   |
| 交應   | 26.018786                         | 26.0388                                          | 11.510508                                 |
| 時差   | 卯酉前後分^2/47800                | (10000-卯酉前後分)/100                           | 不用時差                                  |
| 定用分 |                                   | 授時的6/7                                        |                                           |
| 旣內分 | sqrt((10-旣分)旣分)*5740/定限行度 | sqrt((15-月食分秒)月食分秒)*4920/定限行度        | sqrt((月食分秒-10)月食分秒)*4920/定限行度 |
| 晨昏   | 大都                              | 除了正統十四年後的一小段時間用北京，其餘都用南京 |                                           |

元明實行曆書用的是授時曆經和大統通軌。梅文鼎對大統通軌並不很認同，在編修<v>大統曆志</v>時刻意向<v>授時曆經</v>靠攏。<n>李亮頁 68</n>看了下<v>大統通軌</v>晨昏立成<n>頁 128</n>，冬至晨分二千六百八一七〇，日出就是 0.29317，比宋代曆法早 0.6 刻，<v>授時</v>大都是 0.309204。

### 2、

漢代以後皆行寅正，但也有幾次改正朔事件：

1. 王莽始建國元年 9，改行建丑，將去年十二月改爲今年正月。劉玄更始元年23，復行建寅，將年末的丑月改爲十三月，也就是說公元24年正式用建寅。
2. 魏明帝景初元年 237，改行建丑，將三月改爲四月。但<q>「郊祀、迎氣，祭祠、烝嘗，巡狩、蒐田，分至啓閉，班宣時令，皆以建寅爲正。」</q>景初三年正月，明帝崩，復行建寅。<n><v>宋書志中</v></n>
3. 武周時期 689 十二月行建寅，以子月爲年首<n>如同<v>顓頊</v>建寅，以亥月爲年首</n>：正月—十二月—一月—二月⋯⋯十月。689 年只有 11 個月<n>其中一個月是閏月</n>。長安元年 701 二月復行以寅月爲年首。700 年有 15 個月<n>其中一個月是閏月</n>。
4. 肅宗 761 十二月改行建子。此年只有 10 個月。762 年四月復行建寅。此年有 14 個月，有 2 個四月<n>卯月巳月</n>和 2 個五月<n>辰月午月</n>。<n>見廖育棟 [中國歷代朔閏表](https://ytliu0.github.io/ChineseCalendar/table_chinese.html)</n>

## 曆法發展大勢

- 曆法史的第一次重大變革是戰國初期古四分曆出現，標誌著曆法從觀象授時走向推步。
- 第二次是<v>太初曆</v>，開創了諸多重要議題。
- 第三次是漢末<v>乾象</v>，歲實朔策突破四分曆框架，加上月行遲疾、月行三道，發明定朔推算的方法，用以步交食。
- 第四次是祖沖之<v>大明</v>，增歲差<n>恆星年與回歸年之差</n>，破章法<n>改變19年7閏的古閏章</n>，此後每曆都有不同的章法。
- 第五次是劉焯<v>皇極</v>，這一次稍顯複雜。後魏末年，張子信避亂海島，發現日行盈縮，門人劉孝孫、張孟賔用之於曆，推日食超於鄭元偉董峻之<v>甲寅</v>、宋景業之<v>天保</v>。次年北齊亡於北周，劉孝孫、張孟賔曆未得行用。現在見到最早的日行遲疾表是張冑玄<v>大業</v>，但是與後世日躔表完全不同，<v>大業</v>的日行遲疾只能直接加在定朔上，不能用於推算定氣。<v>皇極</v>會古通今，引入<q>「日行盈縮、交道表裏、五星遲疾」</q><n><v>疇人傳</v>序</n>，有了成孰的日躔表，可以計算定氣，發明二次差內插，此後唐宋曆法都不出<v>皇極</v>框架。唐宋一些節點性質的曆法都各有發明。如<v>麟德</v><q>「廢章蔀紀元，而用總法」</q><n><v>疇人傳</v>序</n>，閏章的槩念徹底退出曆法。<v>大衍</v>將內插法運用得爐火純青，發明不等間距二次內插，晷影差分表甚至達到五次，將月亮視差固定爲表格，發明不同緯度的晷漏求法<n><v>中國古代曆法</v>第552頁</n>。<v>崇玄</v>引入<v>符天</v>的<q>「相減相乘法」</q>，計算五星遲疾等。<v>明天</v>將所有計算全部公式化。<v>統天</v>用歲實消長、朔實消長。
- 第六次是<v>授時</v>，幾乎快到陰陽曆的終點了。<v>授時</v>全面用公式，這一點源於<v>明天</v>；各項參數都用小數點，不用傳統的分數，廢調日法，源於天竺曆法；歲實消長、取消上元積年源於<v>統天</v>——可謂集大成。
- 第七次是清代<v>時憲</v>，底層更換爲西法，用定氣注曆。

有了以上認識，我們可以將古曆分爲以下系統<n>是按照類型來分，而非行用時代</n>：

- 四分系：從古六曆到<v>後漢四分曆</v>
- 魏晉系：從<u>劉洪</u><v>乾象</v>到<u>姜岌</u><v>三紀</v>
- 北系：從<v>玄始</v>到張賔<v>開皇</v>
- 南系：從<v>元嘉</v>到初唐<v>戊寅</v>
- 隋系：<v>劉孝孫</v>、<v>張孟賔</v>、<v>皇極</v>、<v>麟德</v>
- 唐系：<v>大衍</v>到<v>欽天</v>
- 北宋系：<v>崇玄</v>到<v>觀天</v>
- 南宋系：<v>紀元</v>爲代表
- 授時系：<v>授時</v>、<v>大統</v>
- 時憲系：清代四部曆書

賛曰：<b>四分質樸，魏晉古茂，北系鈍拙，南系超捷，隋系煌煌，唐系赫赫，北宋明明，南宋唯唯，授時集大成，時憲脫胎換骨。</b>北系沒有歲差，恢復了古曆的統法蔀法，與同時期的南系相比非常落後。<v>乾象</v>創調日法<n>詳見後</n>，我稱其爲<u>古法</u>。隋至唐初是三系交錯的時候，這期間行用的四部曆法：<v>開皇</v>—<v>大業</v>—<v>戊寅</v>—<n><v>皇極</v>、</n><v>麟德</v>分別是北系<n><v>開皇</v>源自<v>大象</v></n>—南系<n><v>大業</v>師法祖沖之，又用日行遲疾</n>—南系<n><v>戊寅</v>源自<v>大業</v></n>—隋系<n><v>麟德</v>以<v>皇極</v>爲基礎</n>，最終隋系獲勝，過渡到<v>大衍</v>開創的唐系。唐系大量吸收天竺系精神，到唐末<v>崇玄</v>始用公式，直接引導了宋系的公式化進程。北宋亮點是其公式化大發展；南宋除了<v>統天</v>則幾乎一無是處，全部沿用<v>紀元</v>的算法。<u>古法</u>至於宋系而衰亂，僅年甲子、日甲子、朔望月、回歸年參與上元演紀，積年動輒千萬年，古法實際只剩空殼，但宋人不思進取，直到<v>授時</v>纔廢除<u>古法</u>，是爲一恨；<v>大衍</v>開創了高次內插的傳統，但是也告別了迭代的道路，此又是一恨。

## 殘曆復原

### 參數

魏<u>韓詡</u>造<v>黃初</v>，他批評<v>乾象</v>減斗分太過<n>回歸年太小</n>，不過實際上<q>「<u>韓翊</u>所造皆用<u>洪</u>法，小益斗下分，所錯無幾。」</q><n>我據占經復原<v>黃初</v>。

晉武帝泰始十年<n>274</n><u>劉智</u><v>正曆</v><n>我據占經、宋志復原。

永和八年<n>352</n><u>王朔之</u><v>通曆</v>，<v>宋志</v>：<q>「王朔之以其上元歲在甲子，善其術，欲以九萬七千歲之甲子爲開闢之始，何承天云『悼於立意者也。』」</q>但 97000 的積年完全不對，我調整爲 352 - (97000 - 864)，九萬七千歲是舉整數而言。後來看到曲安京<v>中國曆法與數學</v>，改爲 352 - 90079 試了下<n>上元甲午歲壬子日</n>，但是前後錯開兩個月，肯定不能用。

<u>姜岌</u><v>三紀甲子元</v>。我據晉志下、占經復原。

<u>趙𢾺</u><v>玄始</v><n>玄始元年 412—北涼亡</n>。我據占經、<v>疇人傳</v>卷六復原。

<v>隋志</v>這段材料很重要，576 年：

> 訖干敬禮及曆家豫刻日食疎密。六月戊申朔，太陽虧，劉孝孫言食於卯時<n>6—7 點</n>，張孟賔言食於甲時<n>5—6 點</n>，鄭元偉、董峻言食於辰時<n>8—9 點</n>，宋景業言食於巳時<n>10—11 點</n>。至日食，乃於卯甲之間<n>6 點</n>，其言皆不能中。

這裏用的是 24 小時方位制計時。

<u>宋景業</u><v>天保</v><n>天保二年 551—亡</n>，月離表據嚴敦傑<v>補北齊書曆志</v><n><v>自然科學史研究</v>1984 年第 3 期</n>補之。問題是戊申定朔在巽時弱，距巳時<n>0.417-0.45</n>還差了一個多小時。

<u>董峻</u>、<u>鄭元偉</u><v>甲寅元</v>，據嚴敦傑<v>補北齊書曆志</v>、曲安京<v>曆法</v>頁 106 補之。曲安京說<v>甲寅</v>沒有日行盈縮，看來我判斷它是北系曆法是正確的。此前用嚴敦傑的上元積年，自己補上了入轉修正，照理說不應該有，後來用曲安京積年，不用補，非常完美。

<v>張孟賔</v>、<v>劉孝孫</v>二曆以占經復原，<v>劉孝孫</v>很完整，<v>張孟賔</v>殘缺。<v>張孟賔</v>此前積年不對，我加上了 -0.379 的經朔修正，後來用曲安京積年，就不用補了。曲安京沒有復原近點月，我用「從零開始造唐宋曆」工具復原，算得甲時少彊，完美貼合記載。日躔月離此前以<v>皇極</v>補之，但改用<v>大業</v>躔離纔能與<v>隋志</v>相合。

<v>隋志</v>還說：

> 張孟賔以六百一十九爲章，四萬八千九百爲紀，九百四十八爲日法，萬千九百四十五爲斗分。元紀共命，法略旨遠。日月五星，並從斗十一起。盈縮轉度，陰陽分至，與漏刻相符，共日影俱合，循轉無窮。上拒春秋，下盡天統，日月虧食及五星所在，以二人新法考之，無有不合。

「從斗十一起」，說明<v>張孟賔</v>沒有歲差。

<v>明克讓</v><n>武成元年 559—565</n>。我用占經的<v>梁武大同</v>來補<v>明克讓</v>。<v>隋志中</v>：<q>「初，西魏入關，尚行李業興<v>正光術</v>。至武成元年，始詔克讓與麟趾學士庾季才及諸日者定新術，采<u>祖暅</u>舊議，通簡南北之術。自斯已後，頗親其謬。故周齊並時，而曆差一日。」</q>也就是說<v>明克讓</v>綜合南北算法，跟<v>天保</v>差了一天。

<v>大象</v><n>大象元年 579—583</n>。<v>通占大象曆星經</v>與大象曆配套使用，可能是張賔所作<n>許潔<v>隋唐時期的道教星象研究</v>，<v>宗教學研究</v>2009 年第 4 期，第 29 頁</n>，也許可以用來復原大象曆。<v>隋書張冑玄傳</v>：<q>「周马显造 <v>丙寅元历</v>，有阴阳转法，加减章分，进退蚀余，乃推定日，创开此数。当时术者，多不能晓。张宾因而用之，莫能考正。」</q><v>隋書</v>：<q>「小周餘、盈縮積，其曆術別推入蔀會，分用陽率 499，陰率 9。每 12 月下各有日月蝕轉分，推步加減之，乃爲定蝕大小餘，而求加時之正。」</q>

高宗顯慶年間<n>656—661</n>印度曆法<v>九執</v>，全文見占經卷一〇四，顧觀光<v>九執曆解</v><n><v>武陵山人遺書</v>，<v>中國科學技術典籍通匯</v>天文部分 843 頁</n>

術士<u>曹士蔿</u><v>符天</v><n>780-820</n>乃民間小曆，以<q>「相減相乘法」</q>代躔離表，日法用萬分，曆元用雨水，以定氣注曆。<v>崇玄</v>本於<v>大衍</v>，而巧算源自<v>符天</v>。<n>陳久金<v>符天曆研究</v>：<u>祖暅</u>的<v>符天經</v>與後來的<v>符天曆</v>毫無關係。</n>

<v>至道</v>上元積年、回歸年、朔望月用曲安京的復原成果，其他參數參照<v>乾元</v> 995 年轉 27.1173 交 7.5243 週 323.2491，用「從零開始造唐宋曆」工具復原。

<v>乾興</v>其他參數參照<v>觀天</v> 1021 年轉 17.1709 交 6.9028 週 319.5299，用「從零開始造唐宋曆」工具復原。

<v>調元</v>。<v>新五代志</v>：<q>「以宣明之氣朔合崇元之五星，二曆相參，然後符合。」</q>失傳，以我復原的<v>符天</v>代之，參數暫用<v>崇玄</v>，算法用相減相乘法。<n>算法見陳久金<v>符天曆研究</v>。</n>劉義叟見到<v>調元</v>原文，其<v>長曆</v>可信<n>見邱靖嘉<v>遼史曆象志溯源</v>，<v>中華文史論叢</v>2012第4期</n>，那麼接下來的工作就是以我復原的核對<v>長曆</v>。

<v>遼志下</v>的這段記載比較胡扯：

> 遼、漢、周、宋，俱行夏時，各自爲曆。國史閏朔，頗有異同。遼初用乙未元曆，本何承天元嘉曆法；後用大明曆，本祖冲之甲子元曆法。承天日食晦朏，一章必七閏；冲之日食必朔，或四年一閏。用乙未曆，漢、周多同；用大明曆，則間與宋異。國史敍事，甲子不殊，閏朔多異，以此故也。耶律儼紀以大明法追正乙未月朔，又與陳大任紀時或牴牾。

遼金的曆法和<v>元嘉</v>、<v>祖沖之</v>風馬牛不相及。

<v>疇人傳宋二姚舜輔</v>：

> 有司以<v>觀天</v>推崇寧二年<n>1103</n>十一月朔爲丙子。頒秝之後，始悟其朔當進而失進，遂造<v>占天術</v>，改十一月朔爲丁丑，而再頒秝焉。其法上元甲子距崇寧二年癸未，積二千五百五十萬一千七百五十九，日法二萬二千八十。

從這段描述可知，<v>占天</v>應該跟<v>觀天</v>一模一樣。我算出來<v>觀天</v>丙子 7420 不進朔，<v>占天</v> 7461 亦不當進朔。十一月在秋分至春分，進朔標準應該是 7500，這個積年是有問題的。在觀天基礎上將平朔加一刻重新算上元積年。

<v>淳祐</v>、<v>會天</v>歲實、上元積年改用曲安京引用的參數。根據<v>寶祐四年會天曆</v>，1256 年年中冬至當爲癸丑 0.25—0.26 之間。歲實、上元積年改用曲安京引用的參數。1250 年<v>開禧</v>轉 15.5498 交 23.8590，<v>成天</v>轉 15.4620 交 23.7932，範圍兩者之間。

<v>楊級大明</v>用 1180 年<v>重修大明</v>轉 19.0981 交 9.1719。

<v>乙未</v>上元積年、歲差用曲安京復原成果，其餘參數根據重修大明 1180 年轉 19.0981 交 9.1719算得。

六部太乙曆：秦漢時期的<v>甲寅太乙</v>，南北朝的<v>宋琨太乙</v>，唐代王希明的<v>開元太乙</v>，宋代的<v>景祐太乙</v>，金張行簡的<v>太乙</v>，元曉山老人的<v>太乙統宗寶鑑曆</v>。根據曲安京<v>曆法</v>第七章補。

### 天文計算

很多曆法的天文計算闕如，我用相鄰曆法來補：

#### 月離

-  **乾象** 黃初
-  **景初** 劉智、王朔之、三紀
-  **正光** 玄始
-  **天保** 甲寅、天和、大象<n>大象、張賔曆自成一系，不當用天保補。</n>、開皇
-  **大明** 梁武

#### 躔離

-  **大業** 張孟賔、劉孝孫
-  **麟德** 神龍
-  **大衍** 至德
-  欽天：月離用五紀、紀元二曆平均<n>因爲再近一些的都是遠地點入轉了，而欽天是近地點入轉</n>，並用 9 段 248 限法重造月離表。日躔用崇玄。
-  **乾元** 至道
-  **崇天** 乾興
-  奉元、占天：日躔用崇天、紀元二曆平均，月離用崇天、觀天二曆平均
-  淳祐、會天：用統天、開禧、成天三曆平均
-  **紀元** 楊級大明
-  **重修大明** 乙未、庚午

#### 夜漏、晷長、日緯

-  **四分** 顓頊、太初、乾象、黃初、景初、劉智、王朔之、三紀、玄始、正光、興和、天保、甲寅、天和、大象、開皇
-  **麟德** 神龍
-  **大衍** 五紀、正元
-  **崇玄** 欽天日躔表有赤道內外度，但日躔月曆表均無傳，只能用崇玄代。日食黃道內外差需要用赤道內外分。
-  **觀天** 奉元、占天
-  **重修大明** 乙未、庚午

#### 夜漏

-  **大明** 梁武
-  **皇極** 張孟賔、劉孝孫

#### 晷長

-  **大明** 梁武、大業、戊寅、張孟賔、劉孝孫、皇極

#### 日緯

-  **四分** 元嘉、大明、梁武、大業、戊寅、張孟賔、劉孝孫、皇極
-  **應天** 乾元

#### 月緯

-  **乾象** 黃初、景初、劉智、王朔之、三紀、玄始、正光、興和、天保、甲寅、天和、大象、開皇
-  **大明** 梁武、大業、戊寅
-  **皇極** 張孟賔、劉孝孫
-  **麟德** 神龍

## 參考資料

這個網站是古代曆法研究者的共同智慧結晶，在此表示感謝<n>太多了，我就只列作者和篇名</n>：

### 古籍

- 各史曆志
- 開元占經
- 寶祐四年會天曆
- 馮立昇主編<v>疇人傳合編校注</v>，中州古籍，2012
- 鄧文寬<v>敦煌天文曆法文獻輯校</v>
- 梅文鼎<v>梅氏叢書輯要</v>
- 李銳<v>李氏遺書</v>
- 李亮等編<v>海外珍稀中國科學技術典籍集成</v>，2010

### 專書、論文集

- 劉洪濤<v>古代曆法計算法</v>
- 張培瑜等<v>中國古代曆法</v>
- 陳美東<v>古曆新探</v>
- 曲安京<v>中國曆法與數學</v>
- 曲安京<v>中國數理天文學</v>
- <v>秦九韶與數書九章</v>

#### 古曆的計算機模擬

目前發現了三篇博士論文，也就是說我夠三個博士了⋯⋯⋯⋯

- 邢钢 <v>[中国早期历法的计算机模拟分析与综合研究](https://d.wanfangdata.com.cn/thesis/ChJUaGVzaXNOZXdTMjAyMTA1MTkSB1k4MTk5MjQaCDQ5NnBqM3Ux)</v>，中國科學技術大學博士論文，2005 年
- 李亮<v>明代历法的计算机模拟分析与综合研究</v>，中國科學技術大學博士論文，2011 年
- 滕艳辉<v>宋代朔闰与交食研究</v>，西北大學博士論文，2012 年

### 論文

#### 躔離氣朔

- 陈美东：日躔表之研究
- 陈美东：月离表初探
- 徐传胜：<v>乾象历</v>月离表数理分析
- 尚晓清：<v>大衍历</v>定朔算法及程序说明
- 滕艳辉：<v>纪元历</v>定朔算法模型及分析
- 滕艳辉等：<v>纪元历</v>等8部宋代历法的定朔推步及精度分析
- 马莉萍：中国古代历法中合朔时的太阳位置
- 王荣彬：中国古代历法的中心差算式之造术原理
- 李勇：中国古历定朔推步综述
- 李勇：中国古历经朔数据的恢复及应用
- 滕艳辉：宋代历法中的置闰算法
- 李勇：明嘉靖六年<v>大统历</v>历书的气朔推步精度
- 滕艳辉：统天历的岁实消长与气朔算法分析
- 刘娅娅：朱载堉对授时历岁余计算的检验与修正
- 张祺：梅文鼎和江永的回归年消长法

#### 天文計算

- 陈美东：中国古代有关历表及其算法的公式化
- 王锦瑞：<v>明天历</v>岁差与上元积年
- 陈美东：中国古代太阳视赤纬计算法
- 江晓原：中国古代对太阳位置的测定和推算
- 陈美东：中国古代昼夜漏刻长度的计算法
- 纪志刚：麟德历晷影计算方法研究
- 陈美东：中国古代月亮极黄纬计算法
- 陈久金：九道术解
- 周靖：月行九道考
- 曲安京：<v>授时历</v>的白赤道坐标变换法

#### 交食

- 刘金沂：隋唐历法中入交定日术的几何解释
- 滕艳辉：<v>戊寅元历</v>的日月食推算方法
- 刘金沂：麟德历交食计算法
- 滕艳辉：<v>崇天历</v>的日食推步术
- 袁敏：<v>明天历</v>日食算法分析
- 滕艳辉：<v>纪元历</v>日食算法及精度分析
- 李勇：<v>授时历</v>交食推步研究
- 唐泉：<v>授时历</v>和<v>回回历法</v>中的日食时差算法
- 李勇：授時曆與仲康日食推算
- 李勇：中国元明时期交食推步的比较研究
- 陈美东：中国古代的月食食限及食分计算法
- 曲安京：中国古代日食食限与食分算法
- 滕艳辉：宋代的日食食限算法
- 曲安京：中国古代的日食时差算法
- 唐泉：中国古代的日食食分算法
- 曲安京：中国古代的月食时差算法
- 李鉴澄：中国历代日月交食周期的研究
- 马莉萍：中国古代交食的宿度记录及其算法

#### 曆法數學

- 陈久金：调日法研究
- 李继闵：关于调日法的数学原理
- 刘钝：李锐顾观光调日法工作述评
- 李继闵：再评清代学者的调日法研究
- 曲安京：中国古代的二次求根公式与反函数
- 曲安京：唐宋历法演纪上元实例及算法分析
- 曲安京：东汉到刘宋时期历法上元积年计算
- 王翼勋：开禧历上元积年的计算
- 王翼勋：秦九韶演纪积年法初探
- 王锦瑞：<v>明天历</v>天文常数系统中的缺陷解析

#### 招差術

- 李兆华：朱世杰招差术探原
- 李兆华：朱世杰的垛积术与四次内插法
- 李兆华：<v>平立定三差详说</v>的一点注记
- 曲安京：<v>皇极历</v>中的漏刻差分表
- 刘钝：<v>皇极历</v>中等间距二次插值方法术文释义及其物理意义
- 武家璧：<v>大衍历</v>日躔表的数学结构及其内插法
- 曲安京：<v>大衍历</v>晷影差分表的重构
- 王荣彬：中国古代历法三次差插值法的造术原理
- 陈美东：<v>崇玄</v><v>仪天</v><v>崇天</v>三历晷长计算法及三次差内插法的应用

#### 普通曆法

- 刘次沅：<v>史记历术甲子篇</v>探讨
- 严敦杰：补北齐书历志
- 黃一農：中國史曆表朔閏訂正舉隅—以唐麟德曆行用時期爲例
- 劉金沂：李淳風的曆象志和乙巳元曆
- 钮卫星：符天历历元问题再研究
- 陈久金：符天历研究
- 孔庆典：七元甲子术研究
- 陈久金：回人马依泽对宋初天文学的贡献
- 邱靖嘉：<v>遼史曆象志</v>溯源——兼評晚清以來傳統曆譜的系統性缺陷
- 邱靖嘉：<v>辽史</v>所见祖冲之<v>大明历</v>的文献价值发覆
- 郭津嵩：撒馬爾干的中國曆法——耶律楚材的西征庚午元曆及其里差法考辨

#### 具注曆

- 李勇：中国古历中的步发敛
- 朱双双：中国古历没灭术研究
- 何啓龍：<v>授時曆</v>具注曆日原貌考
- 金身佳：敦煌写本宅经P.3594九方色图试释
- 宁宇：敦煌写本时日宜忌文书之思想主题探赜
- 邓文宽：敦煌古历丛识
- 邓文宽：敦煌文献S2620号唐年神方位图试释
- 華瀾：敦煌曆日探研
- 邓文宽：跋吐鲁番文书中的两件唐历
- 何伟凤：黑水城出土元代历日研究

#### 數學

- 甘向阳：<v>九章算术</v>刘徽注中的算法分析工作与算法分析思想
- 陈巍：<v>五经算术</v>的知识谱系初探
- 沈康身：<v>数书九章</v>大衍类算题中的数论命题
- 汪晓勤：<v>数书九章</v>大衍类算题的若干注记
- 一次同余式组的程序求解
- 陈维海：用BASIC程序实现求高次方程实根的斯特姆秦九韶方法
- 朱一文：秦九韶「历家虽用用而不知」解
- 侯钢：秦九韶大衍总数术中问数化定数算法解析
- 王翼勋：从大衍术到大衍求一术
- 段耀勇：刘徽开方与增乘开方法
- 梅荣照：贾宪的增乘开方法_高次方程数值解的关键一步
- 李兆华：增乘开方法与贾宪三角形
- 傅宗：隙积术和会圆术——沈括<v>梦溪笔谈</v>评注一则

#### 現代天文

- 李文：地球椭球模型中太阳位置计算的改进
- 张富、张丽娟、邱本志：一种计算太阳低仰角蒙气差的有理函数逼近方法
- 丁豔、袁隆基、趙培濤、仝軍令：太陽視日軌跡跟蹤算法研究

## 开发者说明

### 1. 技术特征

- 计算程序采用 JavaScript 编写
- 前端框架采用 React
- 本地框架为 Node。在本地运行本程序，需要安装 Node 13.2 以上版本
- 朔闰表、历书采用 Web Worker，实现 UI 线程与计算线程分离
- 朔闰表采用懒加载，大幅压缩渲染时间
- 采用 WebPack 打包
- 采用 [Decimal.js](https://mikemcl.github.io/decimal.js/)<span classname="decimal64">.64</span>进行小数点后 64 位大数字运算，采用 [fraction.js](https://www.npmjs.com/package/fraction.js)<span classname="decimal64">n/d</span>进行分数运算，采用 [nzh](https://blog.whyoop.com/nzh/docs) 进行阿拉伯数字、汉字转换。采用 [react-markdown](https://www.npmjs.com/package/react-markdown) 进行文档渲染。

<del>本仓库基于组件化、工程化的考量，将核心模块<n>计算逻辑</n>拆分到了单独的仓库<n>ancient-calendar</n>中，通过子模块进行依赖，从而前端展示<n>View</n>和计算逻辑<n>Model</n>可以独立开发，前端直接引用子模块的函数进行运算。</del>

由于运算都在前端进行，在进行大量运算时会卡住 UI，体验较差。为了改进这一问题，我们决定改用 Web Worker<n>前端的多线程</n>。这样就必须将 `Worker()` 构造函数的参数文件独立放在 public 目录下<n>不能参与 webpack 打包</n>，因而不能直接引用子模块，必须将子模块打包成一个文件：

1. 全局安装 webpack，webpack-CLI

```
$ npm install -g webpack webpack-cli
```

2. 打包 main.js

```
$ webpack ./src/Cal/output_frontend-worker.mjs -o ./public
```

3. $ npm run build

### 2. 文件功能

核心计算程序在 `/src/Cal` 目录下，有 8 个板块，各文件功能说明：

- `para_` 参数
    - `para_constant` 全局常量参数
    - `para_calendars` 各历法参数 
    - `para_auto-constant` 根据历法自动选择相应常量
    - `para_generate` 生成参数的临时文件
- `newm_` 朔闰表模块
    - `newm` 朔闰计算
    - `newm_quar` 四分历朔闰计算
    - `newm_index` 朔闰计算汇总调整输出
- `day_` 历书模块
    - `day` 历书计算
    - `day_luck` 历书中岁神、日神的计算
- `astronomy_` 天文模块
    - `astronomy_acrv` 日月速度改正
    - `astronomy_eclipse` 日月交食
    - `astronomy_Accum2Mansion` 黄赤道积度转换为入宿度
    - `astronomy_formula` 使用公式进行计算的历法，`astronomy_table` 使用表格进行计算的历法，`astronomy_west` 使用现代方法进行计算。包含黄赤转换、经纬转换、月亮坐标转换
    - `astronomy_other` 積度轉宿度，進朔，月行九道
    - `astronomy_bind` 路由模块，根据历法自动选择天文计算
- `modulo_` 同馀模块
    - `modulo_continued-frac` 分数连分数
    - `modulo_continued-frac1` 小数连分数
    - `modulo_denom` 调日法
    - `modulo_exhaustion` 从零开始造宋历
    - `modulo_gcdlcm` 最大公因数
    - `modulo_origin` 演纪
    - `modulo_qiuyi` 大衍求一术
- `equa_` 方程模块
    - `equa_geometry` 几何
    - `equa_high` 解高次方程
    - `equa_math` 数字格式转换
    - `equa_sn` 垛积
    - `equa_sqrt` 开方
- `time_` 时间模块
    - `time_decimal2clock` 日分转换为辰刻
    - `time_era` 年干支转换
    - `time_jd2date` 儒略日、日期转换
- `output_`其他
    - `output` 输出准备
    - `output_print` 本地打印入口。`const printData = outputFile(2, 1255, 1255, 0` 第一个数字为模式，`1` 为朔闰表，`2` 为历书；第二三个数字为起始年、终止年；第四个数字为自动长历模式开关，目前暂不支持
    - `output_frontend-worker` Web Worker，朔闰表、历书两个模块的前端调用入口

### 3. 命名規範

#### 天文參數 Astronomy constants

- Solar 回歸年 solar year
- Sidereal 恆星年 sidereal year
- Lunar 朔望月 Synodic month
- Anoma 近點月 anoma month
- Node 交點月 node month
- SunLimit 日食食限。SunLimitYang 陽曆食限，SunLimitYin 陰曆食限，SunLimitNone 不偏食限
- MoonLimit 月食食限。MoonLimit1 月全食限，MoonLimit2 必偏食限，MoonLimitNone 不偏食限
- LeapLimit 閏限 The limit for arranging a leap
- Equa 赤道 equator
- Eclp 黃道 ecliptic
- Ecli 交食 eclipse
- Longi 經度 longitude
- Lati 緯度 latitude

#### 變量 Variables

- Origin 上元以來的
- Winsols 冬至 winter solstice
- Newm 朔 new moon
- Syzygy 望 syzygy
- First 天正月，卽冬至所在月 The month in which the winter solstice falls
- Zheng 正月，建正
- LeapSur 閏餘 leap surplus
- GreatSur 大餘，干支的整數部分
- SmallSur 小餘，干支的小數部分
- LeapNumTerm 無中氣置閏法的閏月
- Duskstar 昬中星
- Accum 積日。OriginAccum 上元至年前冬至積日 AnomaAccum 入轉日 NodeAccum 入交日

#### 常量 Constants

- Sc 干支 sexagenary cycle 
- Stem 天干
- Branch 地支
- CalName 曆法名 calendar name
- Hexagram 八卦
- Mansion 宿
- MoonGod 月神
- ManGod 人神

#### 時間長度

- Leng 長度 length
- Range 長度
- Term 十二中氣 HalfTerm 二十四節氣
- Hou 七十二候
- Zhang 章
- Bu 蔀
- Ji 紀
- Tong 統
- Yuan 元

#### 其他

- Raw 未經某種處理的變量 Variables before processing in some way 
- V 速度 velocity
- Corr 修正改正 correction。Tcorr 在躔離計算中爲日月速度改正，在交食計算中位食甚時刻改正。Mcorr 食分修正
- DifAccum 日盈縮積、月遲疾積
- Avg 平均的 average
- Acr  精確的 accurate
- Deg 度數 degree
- Dif 兩個數之差 The difference between constants A and B. 
- WinsolsDif 某日距離年前冬至的日數
- ZoneDif <v>庚午元曆</v>里差<n>地理經度時差</n>
- xxx50 某常量的 50%，xxx125 某常量的 12.5%
- xxxHalf 某變量的一半 Half of a variable
- Numer 分子 numerator
- Denom 分母 denominator。單獨出現的 Denom 爲日法 LunarDenom 的簡寫
- Num 序號 number

## 更新日誌

#### 2021-01-03

立項。

#### 2-23

內測上線。**2-24** 加入readme；加入評論；加入 GA；加入更新日誌。 
**2-26** 加入合朔日月赤度、節氣日赤度。
**2-28** 採用滾動數組，減少計算次數，重構數據結構，本地端速度提高 40%；前端相應調整，採用 Web Worker 多線程。避免 UI 與計算的衝突。今天突然發現望都不對，想了半天才發現，之前都是入曆日+1/2朔望月近點月之差，實際上應該是朔入曆+朔望月/2。
**3-02** 採用懶加載策略，只加載當前屏幕的信息。現在可以秒加載了，看來絕大部分時間都消耗在渲染上。魏晉時期的日月食基本完成。
**3-15** 增加日書、轉換tab。增加魏晉日書，轉換工具。

#### 其他部分已解決問題

兩個倉庫合併。npm run build 。ContinuedFrac' is not exported from '../src/Shangshu-calendar/convert_congruence-modulo'. 打包失敗。朔閏表疊在一起 ————四分短  長  增加唯一id，以前都是一個所以固定高度 03-28。公元年一年只顯示一次。這個文件的函數exports了， 如果我要在本文件中調用這個函數該怎麼辦？exports在文件末尾就可以。連分數latex跟調日法、大衍串在一起了。bug自己消失了。連分數增加i。調日法輸入，彈出來兩數不互質。曆法選項框初始値「請選擇曆法s」，不要讓下面的動。每個tab有不同的使用說明。不同的tab有不同的封面图，也就是不同的tab有不同的classname。分數latex怎麼放到灰色框天文部分的bind，相當於重複計算了4遍？2458849.5 儒略日 1月0日。乾象月緯隔幾天就我有一個消失。景初月赤緯不對，一正一負。紀元月赤經距離冬至超過一半就不行。丟失精度，算不出來：章法：把魏晉的全部過了一遍，興和、天保、甲寅、大象曆數字太大，超過達到20位？？不知道是不是因爲這個。但是天和就算得出。奇怪……看了下，和李銳調日法是否算得出沒有關係。分數的最小公倍數，lcmNumer。曆書：大衍、庚午的月亮跑不了——MoonLatiAccumList: [0, 0, 187, 358, 505, 620, 695, 722, 695, 620, 505, 358, 187]最後漏了一個0。天文的月亮，乾象、大明每次點都會縮小，中了魔咒一樣 ——變量名的問題。日書加上曆法名。日書月名沒有閏月。前兩日九宮亂入。宣明沒有黃道度

#### 4-21 公測上線

版本：核心 `0.90` 前端 `1.00`

#### 4-25 `0.91 1.01`

4 月 24 日本站編入 Google 索引 **核心** 增加時刻轉辰刻。日赤緯、日出公式曆法加上了日躔，至少紀元能跟論文合。授時明天還不對。訂正躔離：重新整理月離表的邊界；修改明天躔離；唐系日躔改用不等間距內插。宋志「紹興四年<n>1193</n>十二月<n>紀元</n>小餘七千六百八十，太史不進，故十一月小盡」。一個迷思：若索引從 1 開始，小餘 8285 左右，與大統相合，若索引從 0 開始，則是 7681，雖與引文相合，但與大統差了太多。我目前還是從 1 開始索引。修改定朔望小餘問題；修改定氣問題。 **前端** 調整文件結構：拆分時間板塊；拆分朔閏表板塊；加入曆書年份限制。

#### 4-29 `0.92 1.01.1`

 **核心** 天文模塊增加交食、交食週期與交點月換算。增加魏晋南北系、大業、戊寅、麟德、大衍交食。元嘉非常奇怪，原來的交會差，單算入交日的話跟其他曆都不一樣，但是最後結果是一樣的，迷惑。現在已有的食甚改正，有些方向都是相反的，奇怪。調整魏晉系閏餘單位，本來想把古六曆閏餘改成 19，發現顓頊不好改，放棄。增加 fraction.js。 **前端** 文件改名。升級依賴。辰刻轉換由文字換成表格。修改表格 css

4-29 晚 `0.92.1 1.01.2`

 **核心** 修復四分曆跑不來的小問題：未把調用交食排除。調用交食模塊之前先用去交日篩選，大大節省算力。30 以內的阿拉伯數字轉漢字換成列表，能快一點；朔閏表月序改成漢字 **前端** 實現了``內 html 標籤：曆書九宮色添加背景色；朔閏表表頭增加樣式，交食進朔符號添加顏色

#### 5-02 `0.93`

 **核心** 重要更新：重構躔離。此前一直用的 (日盈縮積 - 月遲疾積) / (分母) 來計算日月改正，發現並不是這麼回事，大部分曆法都能適用，但是崇玄、應天、儀天、崇天、統元、大衍、乾元這七部曆法的月行改正分母並不固定，算出來大衍的差距能達到 8 刻之巨，所以只好重新錄入所有曆法的朓朒積，再直接用招差術或拉格朗日內插計算。數據已根據陳美東的日躔月離表兩篇論文訂正<n>乾元陳美東843改成850，奇怪，「四十三」和「五十」怎麼會錯呢</n>。修改宣明、應天、儀天月離，此三曆較特殊，月離表分爲兩截，此前我都合爲一個。給所有曆法補上定氣積日表。大幅精簡天文模塊 bind 的代碼。入轉日、入氣日、入交日索引全部統一從 0 開始。修改望也進朔的小 bug。

#### 5-03 `0.94 1.01.3`

 **核心** 增加所有曆法的沒滅。修復大衍交食，與頁 538 算例相合，完美可靠。修復曆書月名的小問題。曆書的候土卦從 0 索引，修正土卦相差一日的小問題。修復四分曆書沒有 13 個月的小問題。精簡一些寫法。 **前端** 小優化：節氣增加底色等

#### 5-05 `0.95 1.01.4`

 **核心** 訂正天文曆：加入唐宋曆月行九道；調整結構，加上躔離、定交改正。修正乾象、大衍等月緯。日經、昏中爲夜半，日緯爲正午。變量改名。修復：唐系日躔340 日以上 NaN，訂正躔離亂七八糟的符號，現代擬合的小bug，優化魏晉南北系月離運算速度。整理月亮位置轉換<n>皇極大衍黃白差沒問題：黃道44，黃白差-1.47<n>頁60</n>，其他應該也沒什麼問題</n>。疏理黃赤轉換，補上宋曆黃轉赤反函數。增強會圓術，增強弧矢割圓，推廣到三角函數。 **前端** 調整曆書樣式

#### 5-09 `0.96 1.02`

**核心** 1、補出弧矢割圓赤轉黃，冥思苦想，畫了好幾種輔助線，最後得來全不費工夫；弧矢割圓加上了任意黃赤交角；訂正弧矢割圓緯度、日出；補上三角割圓赤轉黃；訂正三角割圓，修正球面三角的赤緯轉換，現在三角割圓總算與球面三角全等了。會圓術刪掉週天度和半徑的選項。2、加上授時月亮位置，太難了，結果依然不對。2、大調整，積度轉宿度模塊：Accum2Mansion取消統一計算，分散在各日中，要不然實在不好切。各曆朔閏表赤道日度、昏中星，天文曆日月度應該都差不多了。宋元昏中星尚不能確定，一般情況應該沒什麼問題；後漢四分昏中星跟表比起來，二至都是對的，其他時候少1度。每日月亮位置，<v>中</v>頁 514：大衍算法有問題，欽天以後都改用另外的算法，我統一用宋代算法。3、簡化寫法。增加一個分析日行改正誤差的小片段<n>沒放到前端</n>。 **前端** 重新用上 react-markdown，把所有的<p className='note>全都移到md文件中，爲了方便翻譯。寫了一個下午文案，加上參考文獻，增加命名規範。

#### 5-10 `0.97`

**核心** 1、重寫土王、推卦，乾象景初用京氏，其餘用孟氏。增加「月在張心署之」。2、根據大衍曆議修改歲差：復原梁武大同歲差宿度；修復梁武大同跑不起來的問題；劉孝孫上元改爲虛8。各曆朔閏表的赤度、昬中應該沒什麼問題了。3、大衍黃赤轉換改爲和崇天一樣；公式晷長取消日躔。4、補充、重寫時辰轉換，徹底清楚了。5、增加所有曆法的進朔退望，圓夢了。6、一個系統性bug：閏月進退的NewmOrderRaw竟然一直用的平朔。7、清理朔閏表用不到的傳參，精簡變量；取消四分以後的大小餘。

#### 5-12 `0.98 1.03`

**核心** 1、增加四大三小提示。試了下大衍，四大情況非常常見，需要手動調整。2、天文曆修改月亮經度算法，應該不會差太多了。躔離計算增加月實行度。修改月行九道的判斷條件。修復半月離曆法的疏忽。3、增加積度宿度互換。4、修改天文常數精度。修復一個時辰轉換小疏忽。**前端** 1、網頁調整目錄結構：幾何搬到天文標籤。2、加個contributors wall

#### 5-14 `0.99`

**核心** 1、重寫九道術、授時黃白轉換。授時依然有問題，太難了，只能先放著。2、重寫公式曆法的月亮緯度。3、修改九道對應小問題。修復四分跑不起來。修復一些曆書跑不起來。

5-17 `0.99.1 1.03.1`

**核心** 增加戊寅定朔平朔的區別，在路由文件用 isAcr 實現。**前端** 標籤懸浮變成手。@跟着小徐混

5-18 `0.99.2 1.04`

**核心** 改進四大三小提示：連上了第二年的情況。修復進朔干支序的邏輯。修復麟德不進朔的閏月調整；修改五紀正元的閏月調整標準，因爲進朔比較嚴格；閏月調整標準提到 2.75，否則統元 1145-1146 的閏月提前失效。修復符天、應天跑不起來。 **文字** 增加朔閏表可靠性驗證

#### 5-19 `0.991 1.04.1`

**核心** 這個版本主要是殘曆復原。修改甲寅、張孟賔參數，劉孝孫張孟賔躔離改用大業。修改梁武大同歲差；應天、至道、乾興、奉元、楊級、乙未、淳祐、會天歲差改用曲安京復原結果。楊級、淳祐、會天根據曲安京引用的參數重新構擬。增加至道、乾興、乙未、太乙曆法、元命苞。補上奉元、占天天文曆，曆書補上OriginDaySc。 **文字** 殘曆復原單獨抽出來。修改朔閏表可靠性驗證

5-20 `0.991.1 1.05`

**前端** 終於實現了自動長曆功能！勾選了自動選擇之後，也可以另外手動選擇曆法，作爲參照。**核心** 進朔定朔、進朔日出分改成線性內插。修復四分、神龍跑不起來；修復統元跑不起來：沒月離表。

明天觀測精度很成問題，和紀元、統元比，入轉差了 3 日，入交差了 1.6 日。明天上元以陰曆入交。

5-20 晚 `0.991.2 1.05.1`

**核心** 1、修復定朔定氣等等缺省的情況，主要針對太乙曆。2、根據一段材料重新構擬占天。3、增補交食參數。觀天入交很奇怪，暫時重新擬一個 node。增加大統交差，似乎是陰曆入交。4、合併 NodeCorr、NodeOrigin、NodeConst，AnomaCorr、AnomaOrigin、AnomaConst。5、酌情改幾部南宋曆的上元宿度，改統天的宿度。6、修復兩半月離曆法在邊界的線性改正問題，比如宣明 865二月、885五月線性、二次差了很多，應天968四月癸丑7733、981三月。7、修復積度宿度轉換的小問題。 **前端** cal 目錄的 package.json 合併到根目錄

5-22 `0.991.3 1.05.2`

**核心** 增加 AutoNodeCycle、AutoSidereal、AutoSolar，統一一些常量。變量改名。暫且將五紀正元進朔標準降低10刻。修復宣明月度 NaN 的問題：黃赤轉換、九道術暫時用大衍的。修復本地曆書打印的小問題。 **前端** 標籤換個順序。 **文字** 增加一些和敦煌具注曆的核對。

#### 5-24 `0.992`

**核心** 【重構月離】近點月轉折點的特殊情況<n>卽四七日</n>不能通過內插得到，只能手動輸入，錄入唐宋損益率。增加唐宋曆月離損益率自動選擇模塊 AutoMoonTcorrDif。取消宣明應天儀天的兩組月離表，合爲一表，但加以區分對待。恍然大悟，儀天不是分成兩半，而是分成四部分，獨此一曆。戊寅以前都沒有針對四七日的特殊算法，暫且不管，皇極以後纔有。皇極稍有些特殊，我暫時統一按照後來的處理方式，但區別應該不大。修復其他相關bug。現在四七日的線性改正都完美了，比如 900 年<v>五紀</v>五、七月就跟原來不一樣。優化一些代碼。但月實行度還不太確定各曆的相應算法。

#### 5-27 `0.993`

**核心** 又用了兩天時間來【重新梳理躔離】 麟德應天乾元三曆的日躔不是標準二次內插，進行單獨處理。月離區分唐宋。現在問題應該不大了。詳見 **文字** 增補躔離說明「線性還是二次？」

#### 5-27 晚 `0.994`

**核心** 根據曲安京<v>曆法</v>頁 251 重寫大衍月緯算法，此前用的三次招差術。但是其中符號還不太敢確定。

#### 6-07 `0.995`

正式版前的最後一個版本！！

1、增加唐宋、授時交食。太複雜了，斷斷續續兩個月了。

2、精簡反減的寫法。按照術文是這樣：

```javascript
aRev = a
if (aRev > 0.25) {
  aRev = 0.5 - aRev
}
```

其實等價於 `aRev = 0.5 - abs(a - 0.5)`。

精簡數組前面加一個 0 的寫法：

```javascript
a = a.slice(-1).concat(a.slice(0, -1))
a[0] = 0
```

換成

```
a = [0, ...a]
```

精簡簡單的條件判斷

3、生成欽天、至道、乾興、奉元、占天、淳祐、會天躔離。

4、修復月實行積度的疏忽。修復崇玄月遲疾積。修復黃赤轉換小問題。

5、把生成參數的單獨抽出來一個文件。

6、天文模塊增加交點退行速度、交率交數計算。

7、增加 AutoQuar 自動選擇象限長度。

8、一些變量改名。

**文字** 增加唐宋授時步交會、欽天步月、歲實消長等。文字說明已有四萬八千字。

#### 6-12 `1.00 1.05.3`

**正式版發布！**

1. 重寫大業、戊寅、麟德交食，拆成三個模塊。修復應天、崇天、紀元、授時交食，基本可用了
2. 修復張孟賓、劉孝孫、戊寅小問題
3. 時間模塊增加：小數 ⇒ 弱半彊，時刻 ⇒ 夜籌更點，加時 ⇒ 小分
4. 重寫統天、授時歲實消長
5. 天文模塊增加歲實朔實消長
6. 增加早期授時，分爲有無消長四種
7. 加上庚午里差
8. 精簡寫法：聲明變量放在一行；把所有 *= /= 過了一遍，應該沒問題
9. 修復四分沒有黃道度的小問題。修復占天入交。明天增加一個交食晝夜限制

**前端** 表格線全部取消，清爽多了。markdown 增加表格渲染

**文字** 增補歲實消長說明。總計五萬二千字。

6-12下午 `1.00.1 1.05.4` **核心** 給所有四分曆加上月食計算。修復天文模塊日食的問題。調整一下欽天時差。修復四分沒顯示朔小分的小問題。修復宣明二次月離。**前端** 調整九宮色 css

6-13 `1.00.2` **核心** 增強加時轉約餘。把所有 `.includes()` 過了一遍，沒問題。

6-14 `1.00.3` **核心** 修復大統交應。修復授時歲差消長。**文字** 增加大統交食驗證

#### 6-16 `1.01 1.05.5` 

**核心** 增加晷影求冬至時刻。**前端** 調一下標籤選擇的樣式

#### 6-19 `1.02`

 **核心** 明晰授時系的區別：授時、大統通軌<n>實行</n>、大統曆志。將大統晨昏分換成應天晷刻。徹底解決授時系交食：交定度、月食食分、食延、 TheWinsolsDif 定義。修改授時系限行度，躔離改正完全沒問題了。修復閏月調整問題：本來是 `LeapNumTerm >= 2`，換成 1。修改步軌漏夜半的定義。 **文字** 凡五萬九千字。

#### 6-21 `前端 1.06`

調整代碼結構：把 AutoCal 的實行年份、Bind 的 `Type, isAcr, isNewmPlus` 全部移到曆法參數中，兩個曆法參數文件合并，刪掉 `bind.mjs`。

6-23 `1.02.1` 修復授時建子 NaN 的小問題，定氣閏月也有的小問題。

6-24 `1.02.2` 天文模塊的回歸年計算換成 VSOP87 曆表。前端 `1.06.1` 曆書表格微調

6-24 `1.03` 增加李淳風乙巳元曆，只有平朔。

6-27 `1.03.1` 調整招差術輸出的取值精度

#### 6-27 `1.04`

增加琴律計算模塊。

7-04 `1.04.1` 增加所有調的調弦法，準法律側弄調還很奇怪。

7-31 `1.04.2` 調整魯曆

#### 10-22 `1.05`

增加減字譜轉唱名。

10-25 `1.05.2` 優化代碼 [Code Review on Math Lib #8](https://github.com/lzfcc/Chinese-Ancient-Calendar/issues/8)。主要是 `_math.mjs` 文件

10-25 `1.05.3` 優化代碼 [Code Review #9](https://github.com/lzfcc/Chinese-Ancient-Calendar/issues/9)。簡化解高次方程寫法

10-26 `前端 1.07` 調整函數接口：字符串 `'1,2,3'` 全部換成數組  `[1, 2, 3]` 。全部改下來頗麻煩

10-27 `1.06` 減字譜轉音高增加徵弦。增強fret2leng，增加leng2fret

10-28 `1.06.1` 優化代碼  [Code Review #10](https://github.com/lzfcc/Chinese-Ancient-Calendar/issues/10)

10-31 `1.06.2` 優化代碼 `guqin.mjs`

11-01 `1.06.3` 增加 [] qi shang xia

11-04 `1.06.4` 重寫調弦法

### Todo list

##### 核心

- 現代天文學交食
- 唐曆月離的第二遍修正<n>影響很小，最多 5/10000 日</n>
- 增加黃道過宮<n>不重要</n>
- 增加九服晷漏、九服食差<n>不重要</n>
- 細化曆書的日神<n>不重要</n>
- 細化演紀術。增加增乘開方術。<n>不重要</n>
- 遙遙無期的五星計算
- 遙遙無期的時憲曆、回回曆

##### 前端

- 雙語支持
- 新的曆法選擇框

### Known bugs

##### 核心

- 九道術、授時黃白轉換尙不可靠<n>太難了，以後再說</n>。天文曆的月亮位置估計也有點問題。
- 日月食計算應該還有一些小問題：<v>應天</v>怪怪的
- <v>劉孝孫</v>入交不對。
- <v>觀天</v>入交。重新擬了一個交點月，暫時解決，以後再研究
- <v>五紀</v>、<v>正元</v>月緯的比例沒找到，只能先暫時瞎填一個湊數

##### 前端

- 現在打包文件已經超過了 244kb 的推薦大小，可能因爲這個第一次計算很慢。
- 朔閏表比如 1111 年統天、會元、開禧會重在一起