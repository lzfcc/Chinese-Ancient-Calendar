## 內插

### 招差術

 `第一行輸入框` 在「數列」框中輸入一組離散値，數量 = 次數 + 1，以第一箇數爲起算點。「次數」爲進行幾次內插，卽幾次多項式。n 爲所求的數，第一箇離散値的 n 爲 1。內插公式的一般形式：f(x<sub>0</sub>+x) = f(x<sub>0</sub>) + Δ<sup>1</sup>x + Δ<sup>2</sup> 1/2! x (x-1) +...+ Δ<sup>p</sup> 1/p! x (x-1) ... (x-p+1)。初始値爲<v>大衍曆</v>晷影五次差分表

 `第二行輸入框` 已知差分<n>由低次到高次排列</n>，求 y(n)。次數爲差分的箇數。第一箇數的 n 是 0，上面的是 1。

### 拉格朗日內插

數列中依次輸入各組 x, y 値。拉格朗日不等間距內插公式：y = Σ(n,1) yiLi, Li = Π(n,j=1,j≠i) (x-xj)/(xi-xj)。<v>大衍</v>不等間距內插公式應該是和拉格朗日內插等價的。

<v>大衍</v>「凡推日月度及軌漏、交蝕，依定氣；注曆，依常氣」。

### 晷長 ⇒ 冬夏至時刻

<v>授時曆議</v>最開始就是測影求冬至時刻，根據冬至前後數日正午的三個點，用多組測量結果平均，得到冬至時刻。祖沖之、郭守敬採用線性插值<n>左圖</n>，用如下算式求得冬至時刻：

```javascript
const Dif1 = l1 - l3
const Dif2 = l2 - l3
const result = (d3 - d1 - Dif1 / Dif2) / 2 + 0.5
```

具體推導過程見 [@三种不同的红色](https://www.zhihu.com/question/35894763/answer/65018958)。

<img src="https://pic.imgdb.cn/item/60c98a01844ef46bb2de3746.jpg" width='700'>

但實際上晷長變化是一個近似二次函數<n>右圖</n>，於是我們用拉格朗日內插求極大值的方法<n>二分法</n>來求冬至時刻。祖沖之-郭守敬算法會產生兩個誤差，一個是線性插值帶來的算法誤差，另一個是測量誤差，我們的方法可以消除算法誤差，可實際上沒什麼必要，實際使用中只精確到刻，卽小數點後 2 位，算法誤差不會帶來什麼影響。況且，他們選取的點都是以二至對稱的，所以誤差其實很小。

例如，祖沖之<v>宋書曆志下</v>：

> 據大明五年<n>461 年</n>十月十日，影一丈七寸七分半，十一月二十五日，一丈八寸一分太，二十六日，一丈七寸五分強，折取其中，則中天冬至，應在十一月三日。求其蚤晚，令後二日影相減，則一日差率也。倍之爲法，前二日減，以百刻乘之爲實，以法除實，得冬至加時在夜半後三十一刻，在元嘉歴後一日，天數之正也。

線性插值算得 `(10.8175-10.775)/(10.8175-10.7508333) * 0.5 = 0.31874984`。輸入 `0.5,10.775,45.5,10.8175,46.5,10.7508333` ，算得二次內插極值 `f (23.321281682195) = 11.540491757111`，線性插值誤差爲 `0.00253184 = 0.253刻`，完全可以接受。該年<v>大明</v>冬至乙酉 3160。

以下是<v>授時曆議</v>所有數據，日期用儒略日最後四位，卽減去 2180000，便於計算：

```javascript
// 至元十四年<n>1277</n>冬至
7826.5,7.94855,7833.5,7.9541,7834.5,7.9455 // f (7830.337642585551) = 7.9658416636678
7821.5,7.86355,7838.5,7.87935,7839.5,7.855 // f (7830.330890052356) = 7.9730725165537
7821.5,7.86355,7838.5,7.87935,7840.5,7.83045 // f (7830.347896627651) = 7.9681202222409
7813.5,7.59865,7814.5,7.6377,7847.5,7.5851 // f (7830.333308480895) = 7.937381700585
7803.5,7.0971,7857.5,7.076,7858.5,7.01565 // f (7830.320788807215) = 7.8813177398298
7670.5,1.308,7990.5,1.30385,7991.5,1.29205 // f (7830.323408937259) = 2.2459510672011
// 至元十五年<n>1278</n>夏至
8008.5,1.17775,8017.5,1.178,8018.5,1.18055 // f (8012.9449339207) = 1.1727667351933
7856.5,7.1343,8168.5,7.07595,8169.5,7.1406 // f (8012.9514166438) = 2.0639527562544
7853.5,7.29725,7854.5,7.24545,7855.5,7.1909。8170.5,7.19575,8171.5,7.2505,8172.5,7.30335
7848.5,7.5417,7849.5,7.49595,7850.5,7.4486;8175.5,7.45205,8176.5,7.50035,8177.5,7.54495
// 十五年冬至
8185.5,7.83185;8205.5,7.83635,8206.5,7.80825 // f (8195.5834068844) = 7.9689903356554
8178.5,7.58815,8179.5,7.63015;8211.5,7.63665,8212.5,7.5953,8213.5,7.55045
// 拆：
8178.5,7.58815,8179.5,7.63015;8211.5,7.63665
8178.5,7.58815,8179.5,7.63015;8212.5,7.5953
8178.5,7.58815,8179.5,7.63015;8213.5,7.55045 // f (8195.5749154341) = 7.9575399678137
//
8174.5,7.40375;8216.5,7.412,8217.5,7.36145 // f (8195.5832219016) = 7.9283291038122
8045.5,1.44525,8046.5,1.4638;8345.5,1.4481
8017.5,1.178,8372.5,1.1863,8373.5,1.1783
// 十六年<n>1279</n>夏至
8362.5,1.23695,8363.5,1.22935;8392.5,1.2264
8335.5,1.63905;8419.5,1.60995,8420.5,1.6311
8316.5,2.1305;8439.5,2.11955,8440.5,2.14865 // f (8378.1890954669) = 1.2346924902037
8315.5,2.1611;8440.5,2.14865,8441.5,2.19155 // f (8378.1459269389) = 0.82179481617178
8302.5,2.60345;8453.5,2.5899,8454.5,2.6259 // f (8378.1889697314) = 1.2432420970491
8287.5,3.21955;8467.5,3.15965,8468.5,3.20265
8274.5,3.85015;8480.5,3.7823,8481.5,3.83105
// 十六年冬至
8545.5,7.674;8576.5,7.658,8577.5,7.61425 // f (8560.8089908599) = 7.9906410895563
8539.5,7.45025;8540.5,7.4545;8541.5,7.5025。8579.5,7.532;8580.5,7.48525;8581.5,7.4365;8582.5,7.38715
// 拆
8539.5,7.45025;8540.5,7.4545。8579.5,7.532
8539.5,7.45025;8540.5,7.4545。8580.5,7.48525
8539.5,7.45025;8540.5,7.4545。8581.5,7.4365 // f (8559.033810143) = 7.4928497574134
8539.5,7.45025;8540.5,7.4545。8582.5,7.38715 // f (8555.6101281269) = 7.4855805546617
//
8537.5,7.3015。8583.5,7.332;8584.5,7.28425 // f (8560.8218455321) = 7.8617609541097
8535.5,7.19225;8536.5,7.2469。8585.5,7.22725
8528.5,6.7745;8529.5,6.83725;8530.5,6.89775。8592.5,6.8145
8522.5,6.387。8598.5,6.42975;8599.5,6.3625 // f (8560.8193548387) = 7.6801693640029
8513.5,5.7825。8608.5,5.758;8609.5,5.6915 // f (8560.8131256952) = 7.3271360761165
8511.5,5.64925。8609.5,5.6915;8610.5,5.625 // f (8560.8188436178) = 7.2936924676944
```

用 6—9 組數據測定某至，用 5 個至算得回歸年長度。

上面數據錄了兩個小時，還有錯，不想再看了，以後再說。用 1277、1279 年冬至，算得 365.242055。當年理論值 365.242234。1277 年冬至時刻是 0.332323 = 7:58:32，實際値 8:40。

## 備忘

文科生可以看下這個，@HFLSMathClub： [数学基本符号介绍](https://zhuanlan.zhihu.com/p/254963486)