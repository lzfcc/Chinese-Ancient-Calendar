## 天文計算說明

下爲常用名詞解釋，英語是我代碼中的命名規則：

-  **歲實** 回歸年。不同時期大約長度：四分曆 365.25，魏晉系 365.246，唐系 365.244— .245，宋系 365.243 — .244，授時 365.2425。
-  **週天** 恆星年，祖沖之<v>大明</v>將歲差引入曆法<n>約 45 年差 1 度，誤差較大</n>，李淳風<v>麟德</v>不用歲差，此後一直沿用<n>大約 70 餘年差 1 度</n>。
-  **月** 一個朔望月<n>一般在 29.53059—29.5306  日之間</n>。日法：朔望月分母，從李淳風<v>麟德</v>開始用總法，所有參數的分母都是日法。
-  **轉**  **曆** 與近點月<n>約 27.5545 日</n>有關，「入轉日」卽在一個近點月中的日數。有 8 部曆法以遠地點<n>月速最慢</n>入轉，其餘都是近地點<n>月速最快</n>入轉。魏晉南北曆法的「曆」指與近點月相關的參數，「曆法」卽近點月長度。
-  **交** 與交點月 <n>約 27.21222 日</n>有關，「入交日」卽在一個交點月中的日數。古曆都以降交點入交，卽「正交」，升交點稱「中交」，兩個交點之間稱「半交」。降交點到升交點，月在黃道南，稱「陽曆」「外道」；升交點到降交點，月在黃道北，稱「陰曆」「內道」，所以看到「陰陽曆」的說法，不要與現在說的陰陽曆混淆了。唐代之前有「交前」「交後」的說法，我目前理解爲「交前」卽交在前，指交點在月亮前方，「交後」卽交在後，指交點在月亮後方。
-  **日躔**  **月離**  指日月運動速度的快慢，後來泛指日月運行。日月都是在近地點最快，遠地點最慢。
-  **赤度**  **黃度** 赤道經度，黃道經度。古代天文模型與現代天文學不同，黃經不是現代意義上的黃經，而是黃道與赤經圈相交得到的黃道度數，可稱爲「極黃經」，同樣，白經其實是「極白經」。
-  **白道** 授時曆開始纔有的說法，此前都直說「月道」，白道是月行九道<n>詳見下</n>中的一個。
-  **內外度** 緯度。黃道內外度卽黃緯，赤道內外度卽赤緯。 **去極度** 象限度 - 內外度 = 去極度，卽到天頂的距離。
-  **昏中星** 太陽落山後約 2.5 刻<n>夜漏開始時刻</n>正南的星宿。

進二位 = × 100，退位 = /10

## 歲差

現代的歲差常數是 0.014162 度/年。

大衍曆議論歲差：<n><v>新唐志</v>卷二十七上</n>

> 大同九年<n>543</n>，虞𠠎等議：「姜岌、何承天俱以月蝕衝步日所在。承天雖移岌三度，然其冬至亦上岌三日。承天在斗十三四度，而岌在斗十七度。其實非移。祖沖之謂為實差，以推今冬至，日在斗九度<n>瀚案：算得大明543冬至在斗9.213</n>，用求中星不合。自岌至今，將二百年，而冬至在斗十二度。然日之所在難知，驗以中星，則漏刻不定。漢世課昏明中星，為法已淺。今候夜半中星，以求日衝，近於得密。而水有清濁，壺有增減，或積塵所擁，故漏有遲疾。臣等頻夜候中星，而前後相差或至三度。大畧冬至遠不過斗十四度，近不出十度。」又以九年三月十五日夜半，月在房四度蝕。九月十五日夜半，月在昴三度蝕。以其衝計，冬至皆在斗十二度。自姜岌、何承天所測，下及大同，日已却差二度。而淳風以為晉、宋以來三百餘歲，以月蝕衝考之，固在斗十三四度間，非矣。
>
> 劉孝孫甲子元歷，推太初<n>-103</n>冬至在牽牛初，下及晉太元、宋元嘉皆在斗十七度。開皇十四年<n>594</n>，在斗十三度。而劉焯歷仁壽四年<n>605</n>冬至，日在黃道斗十度，於赤道斗十一度也。其後孝孫改從焯法，而仁壽四年冬至，日亦在斗十度。焯卒後，冑玄以其前歷上元起虛五度，推漢太初，猶不及牽牛，乃更起虛七度，故太初在斗二十三度，永平在斗二十一度，並與今歷合。而仁壽四年<n>605</n>，冬至在斗十三度，以驗近事，又不逮其前歷矣。戊寅歷，太初元年辛酉冬至，進及甲子，日在牽牛三度。永平十一年，得戊午冬至，進及辛酉，在斗二十六度。至元嘉，中氣上景初三日，而冬至猶在斗十七度。欲以求合，反更失之。又曲循孝孫之論，而不知孝孫已變從皇極，故為淳風等所駁。歲差之術，由此不行。
>
> ⋯⋯又皇極歷歲差皆自黃道命之，其每歲周分，常當南至之軌，與赤道相較，所減尤多。計黃道差三十六度，赤道差四十餘度，雖每歲遯之，不足為過。然立法之體，宜盡其原，是以開元歷皆自赤道推之，乃以今有術從變黃道。

<v>數</v>頁188：虞𠠎<v>大同</v>公元前 2300 堯時四正昬中：冬至奎 10，春分井 31，夏至房1，秋分女 2。頁 190：<v>大衍</v>到<v>明天</v>以前都是公元前 2300 冬至日赤在虛 1 ，經檢驗，我的赤度昬中算對了。

## 躔離

### 槩念、符號

太陽運動很簡單，週期項影響不大，用一次傅立葉函數就能比較準確地擬合，但有一個問題是，基本上所有的古曆都以冬至爲近日點<n>日速最快</n>，實際上並不是這麼回事，在 1250 年左右纔是正好以冬至爲近日點，往前往後誤差都會越來越大，只有<v>儀天曆</v>對日躔表有意識地做出了修正。月亮運動相當複雜，週期項非常多，而古曆都僅僅以一個近點月爲週期，我們只能用非常粗糙的近似修正來模擬古曆模型，這也是一個一次傅立葉函數。

表格各欄依次爲：

- 日盈縮積，距冬至日數這麼多天，太陽實際上走了多少度
- 月遲疾積，入近點月這麼多天，月亮實際走了多少度
- `日行改正 = 日盈縮積 / (月實行速-日實行速)`
- `月行改正 = -月遲疾積 / (月實行速-日實行速)`

`平朔 + 日行改正 + 月行改正 = 定朔`，`平氣 - 日盈縮積 = 定氣`，`入交定分 = 入交泛分 + 太陽改正 + 0.078507*月亮改正`。

自<v>乾象</v>始有月行遲疾，自<v>大業</v>始有日行盈縮，月離表、日躔表卽用來記錄每日、每氣的日月實行情況。表格的數據是離散的，所以要用內插法來計算特定時刻的日月實行。自<v>乾象</v>到<v>大業</v>、<v>戊寅</v>皆用線性內插，<v>皇極</v>始用二次差內插，到<v>授時</v>用三次公式。

- <v>隋志中</v>說張賔<v>開皇</v><q>「減朓就朒」</q>，我猜<q>「朓朒」「朏朒」</q>一詞就是張賔開始用的，隨後劉焯<v>皇極</v>沿用，成爲盈縮積的替代說法。晦而月見西方謂之朓，朔而月見東方謂之朒。

古代沒有負數運算的槩念，所以遇到負數都要轉換爲正數，朓朒的正負問題詳見張培瑜等<v>中國古代曆法</v>470 頁。但是要區別對待不同曆法的正負問題非常麻煩，所以我程序中所有曆法的正負都是這樣的：

<img src="https://pic.imgdb.cn/item/60950477d1a9ae528f3cfb1c.jpg">

依次爲：盈縮積、實行速、損益率、列差<n>圖很不精確，只是意思意思</n>。

另外，「四七日」指的是近點月中 6.8886、13.7772、20.6656、27.5545 這四個七日（向上取整），這四點是轉折點，當日損益率需要分段處理（《皇極》、《欽天》處理爲 6 8/9, 13 7/9, 20 6/9, 27 5/9）。

### 分母

精確的日月改正算法是：(日盈縮積 - 月朓朒積) / (月實行速 - 日實行速) 。這其實是一個簡單的 `t = v / s` 問題，不用考慮符號正負。古曆日月改正的算法可以統一爲這樣<n>加〔六角括號〕的是不同曆法或有或無</n>：

1. 日盈縮積或月朓朒積 = 整日朓朒積 + 該日損益率 * 比例
2. 月實行速 = 整日月實行速 + 〔列差*比例〕
3. 改正數 = (〔日盈縮積〕- 月朓朒積) / (月實行速<n>或月平行速</n> - 〔日平行速〕)

理想的分母是 `月實行速 - 日實行速`，但是不同時期的曆法所選分母各不相同，魏晉曆法基本上是 `月實行速-日平行速`，北系是 `月平行速`，大業是 `月實行-日平行`，隋唐宋系反而退步，都是 `月平行`，授時曆 `月實行`。<n>另可見<v>中國古代曆法</v>第434頁</n>

後來突然想到，之所以分母要用 `月平行速`，而不用 `月平行-日平行`，是因為古曆太陽改正都比實際偏大許多，分母更大的話能夠抵消一部分誤差。各曆太陽朏朒極值：麟德 2.767，大衍降到 2.42，此後一直在 2.4—2.42 之間，南宋後期會元達到最低的 2.3，後來三部南宋曆是 2.36，授時又返回 2.4，而實際上只有 1.98。若用這樣的比例抵銷，`2.14 * 12.36875/13.36875 = 1.98`，最常見的 2.4 等於 2.22。所以看起來是退步了，但實際效果應該相差不多。

### 線性還是二次？

《崇天》日躔：

> 求經朔弦望入氣朏朒定數：各以所入氣小餘乘其日損益率，如樞法而一，即得。

明確說「其日」，則是二次插值。每部曆法都會根據日躔術和二十四節氣表編製全年每日的立成表，這就是「其日」的意思，在具體編製每年曆書時只用査立成表進行線性內差卽可（這是我猜的），但曆志中無一保存了唐宋曆的立成表，只能自己根據日躔術來寫程序。各曆二次插值具體形式有所不同。對於《皇極》二次公式，劉鈍（《皇極曆中等間距二次插值方法術文釋義及其物理意義》）、曲安京（《曆法》頁 240）有不同理解。原文「前少者⋯⋯乃別差加之」，劉鈍改爲「半別差減之」，而「前多者，卽以總差加末率」，劉鈍補上「半別差減之」；曲安京則完全未改動原文，指出這是《皇極》的失誤之處。結合《皇極》其他三種二次插值術（求月朔弦望應平會日所入遲速、推朔弦望定日術、求月入交去日道）來看，劉鈍校改之後的纔是術文原貌。對於崇玄，曲安京說原文是「日差」，但可能是「半日差」之誤。王榮彬認為儀天、崇玄完全一致（王榮彬《中國古代曆法的中心差算式之造術原理》），而崇玄又與崇天完全一致（曲安京《曆法》頁 241）。以上觀之，日躔等間距二次差公式有這四種形式：

符號：`Δ1` 爲本氣升降分、損益率，`Δ2` 爲後氣升降分、損益率，`(Δ1-Δ2) / n` 是總差、合差、差率，`(Δ1-Δ2) / n^2` 是別差、日差。

1. 麟德：氣初日消息數 `(Δ1+Δ2)/2n + (Δ1-Δ2)/n`
2. 皇極：氣初日遲速數 `(Δ1+Δ2)/2n + (Δ1-Δ2)/n -(Δ1-Δ2)/2n^2`
3. 應天乾元：氣初日盈縮分 `Δ1/n + (Δ1-Δ2)/2n`
4. 崇玄儀天崇天以後：`Δ1/n + (Δ1-Δ2)/2n - (Δ1-Δ2)/2n^2` 

其中 1、3 等價，2、4 等價，在 1、3 的基礎上考慮半日差卽爲 2、4。經驗算，算法 4 與招差術結果相等，可以用招差術替代日躔術；對於算法 1、3，只能另外單獨編寫程序。

《儀天》採用公式進行計算，其公式是完全精確的（王榮彬《中國古代曆法的中心差算式之造術原理》），所以理論上來講可以用《儀天》公式來代替其他各曆的表格，只需修改系數即可。《儀天》象限採用定氣，卽 88.9、93.7 兩種，盈縮積、朏朒積在二分 88.9 日達到極值；而表格法宋曆都用的平氣，在 91.3 日達到極值，我把象限統一爲 91.3 日。以《紀元》爲例驗算，公式算法與表格算法存在不可忽視的差別，看來並不能用公式代替表格，只能用招差術。這是表格各氣二次差不同造成的，《儀天》公式默認的前提是一象限中各氣二次差相等。

至於不等間距內插的曆法，經驗算，《大衍》、《宣明》公式與拉格朗日內插等價，所以程序中直接調用拉格朗日內插。

再看月離表的算法。<v>皇極</v>一直到<v>崇玄</v>，月亮改正都用等間距二次內插，並且都進行了第二遍修正，交食用二次內插，注曆用線性內插。但是第二遍修正太難了（《中》皇極、大衍相關部分寫了第二遍修正的算法），我暫時忽略，只用招差術進行第一遍二次修正。到了宋曆，月離全都僅僅是線性內插，一下簡單不少，如《崇天》：

> 求朔弦望入轉朏朒定數：置所入轉餘，乘其日損益率，樞法而一，所得，以損益其下朏朒積為定數。其四七日下余如初數下，以初率乘之，初數而一，以損益朏朒為定數。

宋曆無一採用二次內插進行月離改正。

此前我一直把《皇極》以後的定朔躔離改正分為二次和一次，二次改正=二次日躔+二次月離，一次改正=一次日躔+一次月離。經過以上梳理，眉目終於清楚了：

- 【唐曆】交食：二次改正 = 二次日躔 + 二次月離。定朔：一次改正 = 二次日躔 + 一次月離
- 【宋曆】交食、定朔：二次改正 = 二次日躔 + 一次月離
- 【授時】交食、定朔：三次改正 = 三次日躔 + 三次月離

《授時》編製曆書時用立成表來線性內插，立成是用三次內插函數編製的，一近點月分 336 限，所以可以用線性來代替三次內插。程序直接用公式計算，方便快捷，省去錄入立成之苦。《授時》月離立成大槩受到五代王樸《欽天》啓發，《欽天》月行離爲 248 限，直接用立成取代了以往的每日月離表，用線性內差，省去計算之煩。可惜《欽天》躔離表沒有流傳下來，我將《崇玄》月離表處理了一下，分爲 248 限，來線性內插。

## 日軌

### 黃赤轉換

古代天文模型是以赤道爲基準，所謂「赤道者，常道也，其數常定，紘帶天中，儀極攸準」，太陽的黃道度要根據赤道轉換而來。只有<v>授時</v>求出來的直接就是黃道度，反而需要將黃度轉爲赤度。

度數從冬至起算，二至到二分：赤大於黃；二分到二至：黃大於赤。只有<v>紀元</v>有黃轉赤公式，其餘只能赤轉黃，我用與<v>紀元</v>相同的求反函數思路，復原出各宋系曆法的黃轉赤公式。最後一欄的赤緯是直接根據赤道度或黃道度算出來的，下面的赤緯是根據距離冬至日數算出來的，要考慮日躔，而表格法曆法在製表時已經考慮了日躔，所以此處不能加上表格法曆法的赤緯。小數點後 4 位的精度是 0.36”

> 宋代的姚瞬辅。他在编订<纪元历>时，利用求根公式给出了二次函数的反函数，将唐代边岗的双二次函数改造成了一套漂亮的二次复合函数，这个大体上等价于对三角函数用泰勒级数展开以后的前4次项结果。在误差上，当角度大于40度时，他的算法的精度比泰勒级数还要好。

### 會圓術

輸入圓的半徑 r、弓形的高「矢」h、週天度。會圓術求法：半弦長 <code>c = sqrt (r^2 - (r-h)^2)</code>。尤其需要注意的是，會圓術的標準是週天度 365.25，直徑 121.75，卽「週三徑一」，這個單位系是以 3 爲標準，而非圓周率 π<n>鄧可卉<v>授時曆中的弧矢割圓術再探</v>，<v>自然科學史研究</v>2007(2)</n>，所以在與三角函數對照時，需要進行參照系轉換，詳見源代碼。可以發現，弧-矢之間的轉換誤差大約在 1 度以內，而弦長誤差多達 5 度餘，這是單位系不同造成的。在弧矢割圓術中，以弧作爲入口，用會圓術轉換爲弦長，最後再以弧作爲出口，將弦長轉換爲弧長，單獨來看，弦長的誤差相當大，但是在同一個單位系之中，這是自洽的。

傅宗<v>隙積術和會圓術</v>：

<img src="https://pic.imgdb.cn/item/609533e4d1a9ae528fb89250.png" width='800'>

### 弧矢割圓術

<img src="https://pic.imgdb.cn/item/60953023d1a9ae528f948bb3.png" width='270'>

圖<n><v>中國古代曆法</v>頁 627</n>中 AOE 是赤道，AOD 是黃道，BD 是已知的黃道度，求 CE 長<n>卽赤道度</n>、BC 長<n>赤緯</n>。

<v>授時</v>用弧矢割圓術進行太陽黃赤轉換。<v>授時</v>黃赤轉換用幾何模型，此前的曆法都是經驗公式。由於會圓術的誤差，弧矢割圓術的誤差甚至比<v>紀元</v>的經驗公式還略差。弧矢割圓術是近似三角形、勾股定理、會圓術的組合，前兩者都是精確公式，只有會圓術是近似公式，那麼從理論上來講，如果用三角函數代替會圓術，就能得到和球面三角完全一致的結果，實際上也是這樣的。

授時只有黃度轉赤度的方法，我另外推導出了赤度轉黃度的方法：從 C 向上作垂線，與 OB 相較於點 T，T 超出了球體。從 P 向上作垂線，交 OD 於 Q。有了這兩條輔助線，就可以從赤轉黃了。

此處與上面授時黃赤轉換的區別是這裏可以隨意輸入黃赤交角。第一行「球面三角」是球面三角黃赤轉換的公式，第二行「三角割圓」是用三角函數代替會圓術的弧矢割圓術。弧矢割圓術在黃赤度數和黃赤交角在 45—50 度附近誤差達到最大，約 0.4 度。

### 三斜求積術

輸入三角形三邊邊長，求面積。秦九韶三斜求積術與希倫公式等價。

### 積度轉宿度

先秦時期的赤道宿度已不可俱考，但是出土材料能提供很多線索。到太初改曆，赤道宿度就固定下來了：

```javascript
    [12, '角'], // 1 東宮 總75
    [9, '亢'], // 2
    [15, '氐'], // 3
    [5, '房'], // 4
    [5, '心'], // 5
    [18, '尾'], // 6
    [11, '箕'], // 7
    [26, '斗'], // 8 北宮 總98
    [8, '牛'], // 9
    [12, '女'], // 10
    [10, '虛'], // 11
    [17, '危'], // 12
    [16, '室'], // 13
    [9, '壁'], // 14
    [16, '奎'], // 15 西宮 總80
    [12, '婁'], // 16
    [14, '胃'], // 17
    [11, '昴'], // 18
    [16, '畢'], // 19
    [2, '觜'], // 20
    [9, '參'], // 21
    [33, '井'], // 22 南宮 總112
    [4, '鬼'], // 23
    [15, '柳'], // 24
    [7, '星'], // 25
    [18, '張'], // 26
    [18, '翼'], // 27
    [17, '軫'], // 28
```

<v>太初</v>的赤度一直沿用到唐初。<v>大衍</v>重新制定了一份赤度表：

```javascript
    [12, '角'], // 1 東蒼龍
    [9, '亢'], // 2
    [15, '氐'], // 3
    [5, '房'], // 4
    [5, '心'], // 5
    [18, '尾'], // 6
    [11, '箕'], // 7
    [26, '斗'], // 8 北玄武
    [8, '牛'], // 9
    [12, '女'], // 10
    [10, '虛'], // 11
    [17, '危'], // 12
    [16, '室'], // 13
    [9, '壁'], // 14
    [16, '奎'], // 15 西白虎
    [12, '婁'], // 16
    [14, '胃'], // 17
    [11, '昴'], // 18
    [17, '畢'], // 19
    [1, '觜'], // 20
    [10, '參'], // 21
    [33, '井'], // 22 南朱雀
    [3, '鬼'], // 23
    [15, '柳'], // 24
    [7, '星'], // 25
    [18, '張'], // 26
    [18, '翼'], // 27
    [17, '軫'], // 28
```

改動主要在西方。<v>大衍</v>的赤度表一直沿用到宋代。<v>明天</v>重新定出一份赤道宿度表：

> 自漢太初後至唐開元治曆之初，凡八百年間，悉無更易。今雖測驗與舊不同，亦歲月未久。新曆兩備其數，如淳風從舊之意。

以從舊之誼，<v>明天</v>還是沿用<v>大衍</v>的赤度表。直到北宋最後一部曆法<v>紀元</v>又做出調整：

```javascript
    [12, '角'], // 1 東蒼龍
    [9.25, '亢'], // 2
    [16, '氐'], // 3
    [5.75, '房'], // 4
    [6.25, '心'], // 5
    [19.25, '尾'], // 6
    [10.5, '箕'], // 7
    [25, '斗'], // 8 北玄武
    [7.25, '牛'], // 9
    [11.25, '女'], // 10
    [9, '虛'], // 11
    [15.5, '危'], // 12
    [17, '室'], // 13
    [8.75, '壁'], // 14
    [16.5, '奎'], // 15 西白虎
    [12, '婁'], // 16
    [15, '胃'], // 17
    [11.25, '昴'], // 18
    [17.25, '畢'], // 19
    [0.5, '觜'], // 20
    [10.5, '參'], // 21
    [33.25, '井'], // 22 南朱雀
    [2.5, '鬼'], // 23
    [13.75, '柳'], // 24
    [6.75, '星'], // 25
    [17.25, '張'], // 26
    [18.75, '翼'], // 27
    [17, '軫'], // 28
```

就這樣用了一百多年。直到<v>授時</v>給出了新的觀測結果：

```javascript
    [12.1, '角'], // 1 東蒼龍
    [9.2, '亢'], // 2
    [16.3, '氐'], // 3
    [5.6, '房'], // 4
    [6.5, '心'], // 5
    [19.1, '尾'], // 6
    [10.4, '箕'], // 7
    [25.2, '斗'], // 8 北玄武
    [7.2, '牛'], // 9
    [11.35, '女'], // 10
    [8.7, '虛'], // 11
    [15.4, '危'], // 12
    [17.1, '室'], // 13
    [8.6, '壁'], // 14
    [16.6, '奎'], // 15 西白虎
    [11.8, '婁'], // 16
    [15.6, '胃'], // 17
    [11.3, '昴'], // 18
    [17.4, '畢'], // 19
    [0.05, '觜'], // 20
    [10.1, '參'], // 21
    [33.3, '井'], // 22 南朱雀
    [2.2, '鬼'], // 23
    [13.3, '柳'], // 24
    [6.3, '星'], // 25
    [17.25, '張'], // 26
    [18.75, '翼'], // 27
    [17.3, '軫'], // 28
```

<v>紀元</v>觀測精度已達到了 0.05 度。如果單從數字改變幅度來看的話，影響最深的是<v>太初</v>和<v>紀元</v>的赤度表。

而黃道觀測結果就更迭得頻繁得多，想看具體情況，可以看我的源代碼。

這個工具提供了各曆的宿度轉換，需要根據年代選用當時的曆法：<v>太初</v>前 104 — <v>麟德</v>665— <v>大衍</v>729 —<v>應天</v>964—<v>明天</v>1065—<v>紀元</v>1106 或<v>重修大明</v>1180—<v>授時</v>1281 

#### 斗分

「斗分」是什麼意思呢？歲實<n>回歸年長度</n>= 365 + 斗分 / 度法<n>當然，不同曆法有不同的名字</n>。<v>黃初</v>作者韓詡認爲<v>乾象</v>「減斗分太過，後當先天」，大槪就是比較早的出現「斗分」一詞的材料了。爲何要叫「斗分」？中國古代一週的度數是歲實，所以每部曆法都有各自的圓周度數，而我們看<v>太初</v>的赤度表，發現其中都是整數，沒有小數，這是怎麼回事？一般而言，小數點要加到斗宿的後面，所以叫 <b>斗分</b> ，曆法術語表述爲「經斗去分」。到了祖沖之將歲差引入曆法後，各曆上元日所在赤度一般在虛，所以小數點加在虛宿後面，卽「經虛去分」。因此唐代以後，「斗分」一詞就不再用了，否則就要叫「虛分」了。

#### 備忘

- <v>皇極</v>日所在宿度直接是黃道度。「劉焯歷仁壽四年<n>605</n>冬至，日在黃道斗十度，於赤道斗十一度也。」我算出來是斗 13，奇怪。

#### 黃道過宮

以後補充。直到時憲曆，宮纔固定是十二中氣，此前都沒有對應起來。

## 步晷漏

假設 1 尺 = 20 cm，小數點後 4 位是精度就是 20μm。日出時刻 = 夜半漏 + 2.5 刻<n>一日百刻。</n>球面三角的日出、晷長有兩行，上行計入蒙氣差、日視半徑等修正因素，作爲誤差 1 標準，下行未加入修正，作爲誤差 2 標準。陳美東<v>中國古代太陽視赤緯計算方法</v>：各曆法赤緯誤差<n>度</n>：四分 0.7，麟德 0.13，大衍 0.06，宣明、儀天 0.45，崇玄 0.09，崇天 0.23、明天 0.2，觀天 0.21，紀元、授時 0.11。各曆漏刻誤差<n>分鐘</n>：授時 0.7、乾元、紀元、重修大明、庚午 3.8，四分、景初、元嘉 4.4，崇玄 4.6，大明 4.7，皇極 5.6，大業戊寅 6.1，麟德 4.6，明天、觀天 4.9，大衍 5.1，崇天 6.2，宣明 7.7，儀天 7.9。

藤豔輝<v>紀元曆日食算法及精度分析</v>距離冬至 31.816049 日，紀元日出 2126.2566/7290 = 29.1667572，我之前是直接用黃經，是 29.227518，差了 1 天多，改用距冬至日數，加上日躔，29.1664，只有 0.08 秒的區別。所以其他計算也應該要加上日躔。

### 觀測地點

各曆觀測地點及緯度<n>北極出地高度</n>，現代採用 360°，曆測採用古度：

- 四分、景初、元嘉、大明。洛陽34.6667<n>現代</n>
- 皇極、大業、戊寅、麟德、宣明：長安34.2833，
- 大衍、宣明、崇玄、應天、儀天、崇天：陽城34.4047<n>現代</n>，34.475<n>大衍宣明曆測</n>
- 欽天：岳臺 34.9<n>曆測</n>
- 乾元、明天、觀天、紀元、重修大明、庚午：俊儀34.8125<n>現代</n>34.8<n>麟德曆測「唐貞觀初，李淳風於浚儀縣古岳臺測北極出地高三十四度八分」</n>
- 授時：大都39.9500<n>現代</n>40.95<n>曆測</n>

我暫時沒找到各曆對地理緯度的確切記載，以後要補上。

### 晝漏夜漏

晝夜的槩念也很迷惑。大部分曆法的昏明時長是 2.5 刻，`晝漏 = 日出至日入 + 2*昏明`，`夜漏 = 日至日出 - 2*昏明`，`夜半漏 = 夜漏 / 2`。各曆名詞各有不同。

- 「晨初餘數」是唐曆的槩念，在數據庫搜只有<v>唐志</v>有。`晨初餘數 = 日出 - 昏明`，只是單位換成了日法，因爲這時天矇矇亮，晨剛開始，所以叫晨初。
- <v>宣明</v>：`昏明小餘 = 夜半定漏`
- <v>欽天</v>晝夜分以日入日出爲界：`晝分 = 日入 - 日出`，`夜分 = 1 - 晝分`，單位是日法。
- 應天、乾元 `晨半分 = 日出 - 昏明`，`昏分 = 1 - 晨分`，`晝半分 = 日出`，`夜分 = 1 - 晝分`

大體而言，看到「晨昏」二字，就是日出日入加減了昬明 2.5 刻的，看到「晝夜」二字，就是日出日入。

## 月亮位置

<img src="https://pic.imgdb.cn/item/609a3a5dd1a9ae528f07863c.png" width='250'>

黃赤白道示意圖<n><v>數</v>頁 347</n>

需要輸入此刻入降交點<n>正交</n>交點月的日數、距離冬至的日數。距離冬至日數會加上日躔、轉換爲黃道度，再進行接下來的計算。正交至半交：白大於黃，半交至正交：黃大於白。一交點月約 27.21222 日。<v>大衍</v>月黃緯表用到了三次內插，前半段<code>Δ = 171, -24, -8</code>後半段<code>Δ = -75, -40, 8</code>。<v>宋曆</v>第一行赤道度以九道術求得，第二行以黃赤轉換公式求得；<v>授時</v>赤道度則直接以弧矢割圓術求得。赤白差一欄，除了紀元，都是赤道-白道，紀元較爲特殊，日月同名：赤白差=黃赤差+黃白差，異名：赤白差=黃赤差-黃白差

### 月行九道

<v>大衍</v>開始有月行九道法，以步黃道月道之差<n>四季爲節氣，而非月份</n>：

```
   | 春  夏  秋  冬 
------------------
陽 | 朱  靑  黑  白   
陰 | 黑  白  朱  靑
```

再加上與黃道交會，一共就是九道。<v>崇天曆</v>：

> 推月行九道：凡合朔所交，冬在陰曆，夏在陽曆，月行靑道；<n>冬、夏至後，靑道半交在春分之宿，當黃道東；立冬、立夏後，靑道半交在立春之宿，當黃道東南：至所衝之宿亦如之。</n>冬在陽曆，夏在陰曆，月行白道；<n>冬、夏至後，白道半交在秋分之宿，當黃道西；立冬、立夏後，白道半交在立秋之宿，當黃道西北：至所衝之宿亦如之。</n>春在陽曆，秋在陰曆，月行朱道；<n>春、秋分後，朱道半交在夏至之宿，當黃道南；立春、立秋後，朱道半交在立夏之宿，當黃道西南：至所衝之宿亦如之。</n>春在陰曆，秋在陽曆，月行黑道。<n>春、秋分後，黑道半交在冬至之宿，當黃道北；立春、立秋後，黑道半交在立冬之宿，當黃道東北：至所衝之宿亦如之。</n>

九道術前身是<u>劉洪</u><v>乾象</v>月行三道術，只有陰陽黃三道。漢代也有九道術，但是跟唐宋九道術沒什麼關係，漢代九道用來推算月行遲疾。<n><v>數</v>頁 336</n><u>陳久金</u>的示意圖：

<img src="https://pic.imgdb.cn/item/6095052ad1a9ae528f424d26.png" width='500'>

<v>數</v>頁 341：

<img src="https://pic.imgdb.cn/item/6099f0f8d1a9ae528f5344bb.jpg" width='650'>

## 交食

### 交點月

我的獨創發明：<code>Node = Lunar * EcliCycle / (1/2 + EcliCycle)</code>，以<v>皇極</v>驗之，可見<v>皇極</v>之交點月正以此公式化之。<v>大明</v>以前無交點月，只有交食週期，我藉此全部統一爲用交點月進行計算，非常方便。可輸入小數或分數，算出來的小數可通過「同餘」標籤中的「連分數」化爲漸進分數

### 日食

<v>大業</v>、<v>戊寅</v>、<v>皇極</v>、<v>麟德</v>要根據月份來判斷，這裏爲了簡化輸入，我改爲用節氣判斷季節，這不準確。入交日在正交、半交附近發生交食，交點月的一半約爲 13.6061。

漢代以前，只能根據交食週期確定是否有可能出現日月食。魏晉時期，可以計算食分多少，判斷交食程度。到<v>大業</v>，開始考慮視差的影響。古代判斷交食都是用黃白經差，沒有用月黃緯輔助判斷。

古曆日食時差是基於定朔時刻 `r` 的一元函數，`R = | 0.5 - r |`，則 `時差 = kR(0.5 - R)`。但理論上還應該考慮太陽黃經，如果授時曆加上一個黃經的線性函數，就能很好地與理論曲線脗合。

### 唐宋授時步交會

本文是一個提綱，主要目的是明晰各曆槩念的區別、各算法的自變量，這是最要命的。相關論文也有，但是看得不明不白，只好自己根據宋志原文重新理一遍。

爲節省篇幅，「入交」表示加時入交日及餘分（或餘秒）。日月改正包含以距離爲單位的先後積和以時間爲單位的朏朒積，我統一稱爲日月改正，讀者需加以區分（凡言積度，則爲先後積；凡言入交，則爲朏朒積）。需要注意各名詞的細微區別，可能一字之差就完全不同。`月改正(定朔入轉)` 表示以定朔入轉爲自變量的月改正，`午前後分(定餘)` 表示午前後分以定餘爲自變量。「朔」指「朔望」。比例指 `交率/交數 ≒ 0.0785`，各曆比例不同。日月改正爲太陽改正、月亮改正相加減。

南宋各曆全同紀元。

距冬至日 = 崇天：中積 = 明天：中日

#### 一、入交

「定朔入轉」的概念也困擾我很久，終於在《授時》找到解釋：

> 置經朔弦望入轉日及分，以定朔弦望加減差加減之，為定朔弦望加時入轉；以定朔弦望日下分減之，為夜半入轉。

《大統》：

> 置經朔弦望遲疾曆，以定朔弦望加減差加減之。在疾曆，便為定朔弦望加時入轉日；在遲曆，用加轉中。置定朔弦望加時入轉日，以定朔弦望小餘減之，為夜半入轉日。

定朔入轉 = 經朔入轉 ±日月改正。此前一直以為和定朔入交一樣，整數日有進退，否則因經為定。

天正經朔入交（應天：中盈度，乾元：平交朔日）

經朔夜半入交 = 經朔入交 - 小餘。

定朔夜半入交：整數日有進退的，加減一日，否則因經為定。

明天求去交度分的算法很獨特。

#### 二、入陰陽曆（紀元除外）

朔入交常日 = 經朔入交 ± 日改正（應天：朔交初度分，乾元：朔交分）

【乾元儀天崇天觀天】朔入交定日 = 朔入交常日 ± 比例 × 月改正（乾元：度定分）

入陰陽曆()：

- 【應天】朔入交常日 ± 月改正（卽紀元的定朔入交泛日）
- 【乾元儀天崇天觀天】朔入交定日

【紀元】食甚泛餘 = 定朔 ± 日月改正(朔入氣入轉) * 損益率(定朔入轉)

不論陰陽，近交初為交初，在二十六日、二十七日為交初；近交中為交中，在十三日、十四日為交中。交初交中主要用來判斷食差符號。

【紀元】定朔入交泛日 = 經朔入交 ± 日月改正

【崇天觀天】月入陰陽曆積度 = 入陰陽曆 * 月平行速

【紀元】定朔入交積度 = 定朔入交泛日 * 月平行速

【紀元】定朔入交定積度 = 定朔月行入交積度 ± 月改正(定朔入轉)。

#### 三、時差

只有紀元、授時有月食時差，其他都以定望爲食甚。

【應天乾元儀天崇天】午前後分(定朔)

【應天乾元儀天】時差(午前後分, 半晝分) 

【崇天】時差(午前後分) 【觀天】時差(定朔)

【紀元】中前後分(泛餘) 

【紀元】時差(中前後分)

【應天乾元儀天崇天】食甚定餘 = 定朔 ± 時差

【應天乾元儀天崇天】距午分 = 午前後分 + 時差（應天：距中分，乾元：距午刻分，崇天：午前後定分、距午定分。注意，這裏是都加不減，紀元分加減：應天「以差皆加午前後分，爲距中分」乾元「皆加午前、後分，為距日分；刻法而一，為距午刻分」崇天「以時差加午前後分，為午前後定分」，授時「以中前後分各加時差，爲距午定分」。宣明是食甚時刻，之前皇極等等大概是定朔）

《儀天》有一句很難懂：「置月行去交黃赤道差，視月道差，如黃赤道交者，依其加減；不如黃赤道交者，返其加減；定朔、望小餘為食甚餘，亦返其加減去交定分。」暫時存之。

【明天】食甚 =  (經朔 ± 月改正) * 月平行速/月實行速 ± 日改正	

【紀元】食甚定餘 = 泛餘 ± 時差。

【明天觀天紀元】午前後分(明天觀天：食甚，紀元：定餘)

#### 四、其他算法

##### 入食限

【應天乾元儀天】粗略判斷，陽曆不日食。交前後分(入陰陽曆)

##### 日行積度

【明天紀元】食甚距冬至日 = 經朔距冬至日 + 食甚 - 經朔（明天：朔加時中日 = 朔中日 + 加時小餘 - 經朔小餘，紀元：食甚入氣 = 經朔入氣 + 食甚 - 經朔）

【明天紀元】食甚日行積度 = 食甚距冬至日 ± 日改正(食甚) （明天：朔加時定日）

#### 五、氣差

氣差（應天、儀天：黃道差，乾元：晷差，明天：南北差）

【應天乾元儀天崇天】氣差(定朔距冬至日, 距午分)   （應天：朔定積，崇天：朔中積，那就當成定朔，觀天：盈縮限度及分）

【觀天】氣差(定朔距冬至日, 午前後分)

【明天紀元】氣差(食甚日行積度, 午前後分)

#### 六、刻差

刻差（應天、儀天：赤道差，乾元：離差，明天：東西差）

【應天乾元儀天崇天】刻差(定朔距冬至日, 距午分)

【觀天】刻差(定朔距冬至日, 午前後分)

【明天紀元】刻差(食甚日行積度, 午前後分)

【應天乾元儀天明天紀元】食差 = 氣差 ± 刻差（明天：食差總數） 【崇天觀天】食差 = 氣差 ± 刻差 ± 時差

#### 七、食分

【應天乾元儀天】距交分 = 交前後分 ± 食差（乾元：定交分，儀天：去交定分），判斷是否返入內外道，是否入食限

【崇天觀天】交前後分 = 入交定日 ± 食差，判斷是否返入內外道，是否入食限

【明天】 去交定分 = 去交分 ± 食差，判斷是否反減食差，是否返入內外道，是否入食限

【紀元】朔入交定日 = 入交常日 ± 食差 ± k0。望入交定日 = 入交常日 ± 比例*月改正(望入轉)（卽乾元儀天的入交定日）

【紀元】入陰陽曆(入交定日)

【紀元】交前後分(入陰陽曆)

【應天乾元儀天】日食分(距交分, 定餘)

【應天乾元儀天】月食分(距交分)

【崇天明天觀天紀元】食分(交前後分，明天：去交定分)

#### 八、食延

【應天】定用分(食分, 月實行速)

【乾元】定用分(食分)

【儀天】定用刻(食分, 去交定分)

【崇天明天觀天】日食定用分(食分, 月實行速)

【崇天明天觀天】月食定用分(交前後分，明天：去交定分, 月實行速)

【紀元】定用分(交前後分, 食甚入轉損益率)

#### 九、帶食

⋯⋯

【紀元】帶食差(食甚小餘, 日出入分)⋯⋯

### 備忘

- <v>中</v>頁 538 大衍日食算例。

## 古人眼中的宇宙

#### 日食的政治意義

以古代的天文水平，不可能精確計算日食這樣複雜的三體運動，所以<u>一行</u><v>大衍曆議</v>說：「使日蝕皆不可以常數求，則無以稽歷數之疎密。若皆可以常數求，則無以知政教之休咎。」一行認爲不能求得的這部分是因爲天意。北宋<v>明天</v>作者<u>周琮</u>說：<q>「今以日行之所盈縮、月行之所遲疾，皆損益之，或進退其日，以爲定朔，則舒亟之度，乃勢數使然，非失政之致也。」</q><q>「日食當朔，月食當望，蓋自然之理。夫日之食，蓋天之垂誡，警悟時政，若道化得中，則變咎爲祥。國家務以至公理天下，不可私移晦朔，宜順天誡。」</q>宋人認識到交食是一種自然現象，並非因爲<q>「失政」</q>，但日食依然是不好的事情，所以每逢日食，君主就要修身理政，以<q>「變咎爲祥」</q>。如果預測不準，那就會讓君主錯過上天的警示。<v>明志一</v>：「十九年三月癸巳朔，臺官言日當食，已而不食。帝喜，以爲天眷，然實由推步之疏也。」

### 月相

《宋志十三》末尾：「又月之晦明，自昔弗燭厥理，獨揚雄云：「月未望則載魄於西，既望則終魄於東，其溯於日乎？」京房云：「月有形無光，日照之乃光。」始知月本無光，溯日以為光。本朝沈括用彈況月，粉塗其半，以象對日之光，正側視之，始盡圓缺之形。」漢人就知道了月光是由太陽照射產生的，沈括模擬出圓缺變化的原理。

## 現代天文計算

### 任意時刻太陽高度、方位角、晷長

輸入年前冬至時刻<n><n>例如計算 2020 年 12 月 29 日、2021 年 6 月 29 日，均輸入 2020 年 12 月 21 日冬至時刻。可通過廖育棟網站、壽星天文曆、日梭天文曆、中國天文年曆等査詢</n></n>、該日距冬至的整數日數<n><n>冬至當日爲 0</n></n>、想要計算的時刻、地理緯度、影桿的高度<n><n>北京約 39 度</n></n>、公元年。程序自動將距冬至日數轉換爲眞黃經、赤緯。方位角正負：子線或午線以右以東爲負，以左以西爲正，本程序計算出的方位角不大於 90°