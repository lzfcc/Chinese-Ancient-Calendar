## 古曆名詞與術語

### 名詞

-  **歲實** 回歸年。不同時期大約長度：四分曆 365.25，魏晉系 365.246，唐系 365.244— .245，宋系 365.243 — .244，授時 365.2425。
-  **週天** 恆星年，祖沖之<v>大明</v>將歲差引入曆法<n>約 45 年差 1 度，誤差較大</n>，李淳風<v>麟德</v>不用歲差，此後一直沿用<n>大約 70 餘年差 1 度</n>。
-  **月** 一個朔望月<n>一般在 29.53059—29.5306  日之間</n>。日法：朔望月分母，從李淳風<v>麟德</v>開始用總法，所有參數的分母都是日法。
-  **轉**  **曆**  **變** 與近點月<n>約 27.5545 日</n>有關，「入轉日」卽在一個近點月中的日數。有 8 部曆法以遠地點<n>月速最慢</n>入轉，其餘都是近地點<n>月速最快</n>入轉。魏晉南北曆法的「曆」指與近點月相關的參數，「曆法」卽近點月長度。
-  **交** 與交點月 <n>約 27.2122 日</n>有關，「入交日」卽在一個交點月中的日數。古曆都以降交點入交，卽「正交」，升交點稱「中交」，兩個交點之間稱「半交」。降交點到升交點，月在黃道南，稱「陽曆」「陽道」「外道」；升交點到降交點，月在黃道北，稱「陰曆」「陰道」「內道」，所以看到「陰陽曆」的說法，不要與現在說的陰陽曆混淆了。
-  **日躔**  **月離**  指日月運行，又特指日月速度改正。日月都是在近地點最快，遠地點最慢。
-  **赤度**  **黃度** 赤道經度，黃道經度。古代天文模型與現代天文學不同，黃經不是現代意義上的黃經，而是黃道與赤經圈相交得到的黃道度數，可稱爲「極黃經」，同樣，白經其實是「極白經」。太陽在黃道上運行，因此太陽的極黃經與黃經相等。
-  **月道** **白道** 授時曆開始纔稱白道，此前都直說月道，白道是月行九道<n>詳見下</n>中的一道。
-  **內外度** 緯度。黃道內外度卽黃緯，赤道內外度卽赤緯。 **去極度** 象限度 - 內外度 = 去極度，卽到天頂的距離。
-  **昏旦中星** 昏明時刻正南的星宿。

### 數學術語

- 看到減的時候要留意誰減誰。某甲「反減」「覆減」乙的意思是 `乙 - 甲`。「相減」默認就是以大減小
- 「進二位」「進二等」意思是 `× 100`，「退位」指 `/ 10`
- 因同乘
- 「甲少於乙10已下」意思是 `甲 >= 乙 - 10`，同理，「甲少於乙10已上」意思是 `甲 <= 乙 - 10`

### 天文術語

- 積年 * 回歸年【庚午】通積分

- 距冬至日數 = 【崇天】中積 = 【明天】中日

- 黃道月道同名異名十分迷惑：

  - <v>五紀</v>「凡春分後陰曆交後，秋分後陽曆交後，爲月道同名，餘皆爲異名。」似乎說只有交後纔算同名，則同名只有四分之一的情況。又說「月道同名者，交前爲加，交後爲減；異名者，交前爲減，交後爲加。」則同名異名皆有交前交後。
  - <v>觀天</v>：「凡日以赤道內爲陰，外爲陽；月以黃道內爲陰，外爲陽。故月行宿度，入春分，交後行陰曆，秋分，交後行陽曆——皆爲同名；入春分，交後行陽曆，秋分，交後行陰曆——皆爲異名。」
  - <v>紀元</v>、<v>重修大明</v>：「月行正交入夏至後宿度，內爲同名，入冬至後宿度，內爲異名。⋯⋯其在同名者，⋯⋯半交後，正交前，以差減；正交後，半交前，以差加。」原本的句讀是「入夏至後宿度內爲同名」，我覺得應該斷開。這裏的正交應該指兩個升降交點，半交指四分之一交點月，則同名旣有交前又有交後。

  還是<v>觀天</v>說得最清楚，暫時統一按<v>觀天</v>處理：秋分到次年春分太陽在陽曆，春分到秋分太陽在陰曆，交初到交中月亮在陽曆，交中到交初月亮在陰曆。<v>觀天</v>只舉交後而言，但交前交後照理說都一樣的，否則春分交前陰曆之類就旣不同名也不異名。

- 交前交後也非常迷惑。唐宋曆的「交前」卽在交點之前，「交後」卽在交點之後。而隋以前一般用「先交」「後交」，似乎是「先交」=先於交點=交點在後=「交前」，「後交」= 後於交點 = 交點在前=「交後」。

- 「去交度乘數除數」只在以下幾部唐曆見過。乘上日法，發現崇玄又和其他幾個不合。

  - <v>大衍</v> `3040 * 11/2643 = 12.6523`
  - <v>五紀</v>交度乘數十一，除數千一百六十五 `1340 * 11/1165 = 12.6523`
  - <v>正元</v> `1095 * 11/945 = 12.746`，應該沒問題，如果要跟其他接近的話就改成 `1095 * 11/952 = 12.6523`
  - <v>宣明</v>去交度乘數十一，除數七千三百三 `8400 * 11/7303 = 12.6523`
  - <v>崇玄</v>去交度乘數十一，除數八千六百三十二 `13500 * 11/8632 = 17.203429`，改成 `13500 * 11/11632 = 12.7665`，`13500 * 11/11732 = 12.6577`，`13500 * 11/11737 = 12/6523`

  <v>大衍</v>云「大抵去交十三度已上，雖入蝕限，爲涉交數微，光景相接，或不見蝕。」看來唯一的作用就是用來判斷是否超出 13 度⋯⋯這個値是 1.028 日。這無關緊要，我們只需要根據日分來計算卽可。
  
- 「無同率」。<v>大衍</v>入氣差積有一句「其二至之前一氣，皆後無同差，不可相并，各因前末爲初率。」其他地方還有「其後無同率」。例如 `[10, 13, 13, 10]` ，前後都是 13，所以相互之間沒有差，這時就要減去前面的 10 來作爲差。

- 唐宋食分都是用太半少來表示，<v>觀天</v>：「其分就近約之爲太、半、少。」少半太是 0.25-0.5-0.75，旣然是就近，那可以理解爲 0—0.125 爲某度，0.125—0.375 爲某度少，0.375—0.625 爲某度半，0.625—0.875 爲某度太，0.875—1 爲某 +1 度。另一種可能性是 0—0.25 爲某度，0.25—0.5 爲某度少，0.5—0.75 爲某度半，0.75—1 爲某度太。在時間模塊有相應轉換工具。

### 現代天文

- 眞太陽日：太陽中心兩次經過南天子午線的時間。
- 平太陽日：由於日行盈縮、黃赤道差，真太陽日並不均勻，真太陽日的平均時長是平太陽日，即 24h。時差：真太陽日與平太陽日之差。（《中國》頁 322）
- 恆星日：恆星旋轉一週的時間，比太陽日短 3m56s。一回歸年之中，太陽轉了 365.2422 週，而恆星轉了 366.2422 週。
- 昏旦中星其實就是昏明時刻的恆星時。

## 歲差與歲實消長

### 歲差

現代歲差常數是 0.014162 度/年。

大衍曆議論歲差：<n><v>新唐志</v>卷二十七上</n>

> 大同九年<n>543</n>，虞𠠎等議：「姜岌、何承天俱以月蝕衝步日所在。承天雖移岌三度，然其冬至亦上岌三日。承天在斗十三四度，而岌在斗十七度。其實非移。祖沖之謂爲實差，以推今冬至，日在斗九度<n>瀚案：算得大明543冬至在斗9.213</n>，用求中星不合。自岌至今，將二百年，而冬至在斗十二度。然日之所在難知，驗以中星，則漏刻不定。漢世課昏明中星，爲法已淺。今候夜半中星，以求日衝，近於得密。而水有清濁，壺有增減，或積塵所擁，故漏有遲疾。臣等頻夜候中星，而前後相差或至三度。大畧冬至遠不過斗十四度，近不出十度。」又以九年三月十五日夜半，月在房四度蝕。九月十五日夜半，月在昴三度蝕。以其衝計，冬至皆在斗十二度。自姜岌、何承天所測，下及大同，日已却差二度。而淳風以爲晉、宋以來三百餘歲，以月蝕衝考之，固在斗十三四度間，非矣。
>
> 劉孝孫甲子元歷，推太初<n>-103</n>冬至在牽牛初，下及晉太元、宋元嘉皆在斗十七度。開皇十四年<n>594</n>，在斗十三度。而劉焯歷仁壽四年<n>605</n>冬至，日在黃道斗十度，於赤道斗十一度也。其後孝孫改從焯法，而仁壽四年冬至，日亦在斗十度。焯卒後，冑玄以其前歷上元起虛五度，推漢太初，猶不及牽牛，乃更起虛七度，故太初在斗二十三度，永平在斗二十一度，並與今歷合。而仁壽四年<n>605</n>，冬至在斗十三度，以驗近事，又不逮其前歷矣。戊寅歷，太初元年辛酉冬至，進及甲子，日在牽牛三度。永平十一年，得戊午冬至，進及辛酉，在斗二十六度。至元嘉，中氣上景初三日，而冬至猶在斗十七度。欲以求合，反更失之。又曲循孝孫之論，而不知孝孫已變從皇極，故爲淳風等所駁。歲差之術，由此不行。
>
> ⋯⋯又皇極歷歲差皆自黃道命之，其每歲周分，常當南至之軌，與赤道相較，所減尤多。計黃道差三十六度，赤道差四十餘度，雖每歲遯之，不足爲過。然立法之體，宜盡其原，是以開元歷皆自赤道推之，乃以今有術從變黃道。

<v>數</v>頁188：虞𠠎<v>大同</v>公元前 2300 堯時四正昬中：冬至奎 10，春分井 31，夏至房1，秋分女 2。頁 190：<v>大衍</v>到<v>明天</v>以前都是公元前 2300 冬至日赤在虛 1 ，經檢驗，我的赤度昬中算對了。

### 歲實消長

<v>統天</v>發明歲實消長，<v>授時</v>繼之。<v>統天</v>百年減 2.1167 分，比實際高了 35 倍，授時百年減 1 分，比實際高了 16 倍，這樣三百年下來就有很大的誤差了，我暫時把授時調低 15 倍，等有需要的時候再改回原曆的値。

此二曆的歲實消長是根據以往所有曆法的參數歸算出來的。我們把<v>乾象</v>以後的 55 部曆法按照這樣全部計算一遍：`(0.2425 - 斗分) / ((1281 - 制曆年) / 100)`，得出每百年消長數，最後求平均值，算出 `-0.0005841`，卽每百年減 5.8 分。顯然，古曆的回歸年都比實際偏大很多，這是爲了推算古代天象，預留了一些增量。可是增加得太多了，真的會準確嗎？

這是各曆制曆時間與斗分：

```javascript
[206, 0.24617996604416703, "乾象"], 
[237, 0.24688008681499696, "景初"], 
[274, 0.246666666666667, "正曆(擬)"], 
[352, 0.24677452385827792, "通曆(擬)"], 
[384, 0.24683802529580134, "三紀"], 
[412, 0.2443055555555702, "玄始(擬)"], 
[443, 0.2467105263157805, "元嘉"], 
[463, 0.24281481856627352, "大明"], 
[522, 0.24372937293730956, "正光"], 
[535, 0.24437096122778712, "明克讓(擬大同代)"], 
[540, 0.24418742586004782, "興和"], 
[550, 0.2445900253592299, "天保"], 
[566, 0.24428815004262106, "天和(擬)"], 
[573, 0.2443146514228829, "劉孝孫(擬)"], 
[576, 0.2442690333530777, "張孟賓(擬)"], 
[576, 0.24447130450352006, "甲寅(擬)"], 
[579, 0.24376539408865483, "大象(擬)"], 
[584, 0.24342463092460775, "開皇(擬)"], 
[604, 0.243034709193239, "大業"], 
[608, 0.2445437784066371, "皇極"], 
[626, 0.24461115807270062, "戊寅"], 
[626, 0.24461115807270062, "戊寅(平朔)"], 
[664, 0.24477611940295674, "麟德"], 
[664, 0.24477611940295674, "麟德(進朔)"], 
[705, 0.2448, "神龍(擬)"], 
[724, 0.24440789473686664, "大衍"], 
[762, 0.24477611940295674, "五紀"], 
[784, 0.24474885844750816, "正元"], 
[822, 0.24464285714287826, "宣明"], 
[892, 0.24451851851853235, "崇玄"], 
[956, 0.2445, "欽天"], 
[962, 0.24445110977802642, "應天"], 
[981, 0.24489795918367463, "乾元"], 
[995, 0.24466477809255593, "至道一(擬)"], 
[995, 0.244705882352946, "至道二(擬)"], 
[1001, 0.24455445544555232, "儀天"], 
[1021, 0.24450549450551762, "乾興(擬)"], 
[1024, 0.24457034938620836, "崇天"], 
[1063, 0.24358974358972318, "明天"], 
[1074, 0.2435864978903055, "奉元(擬)"], 
[1092, 0.24355777223610175, "觀天"], 
[1103, 0.24358974358972318, "占天(擬)"], 
[1100, 0.24362139917695913, "紀元"], 
[1127, 0.24359464627150373, "楊級大明(擬)"], 
[1135, 0.243578643578644, "統元"], 
[1167, 0.2436, "乾道"], 
[1176, 0.24361702127657736, "淳熙"],
[1180, 0.24359464627150373, "重修大明"], 
[1180, 0.24359594006767793, "乙未(擬)"], 
[1191, 0.24372093023254138, "會元"], 
[1207, 0.24307692307689877, "開禧"], 
[1250, 0.2427762039660024, "淳祐(擬)"], 
[1253, 0.2429158110883236, "會天(擬)"], 
[1271, 0.242722371967659, "成天"], 
[1220, 0.24359464627150373, "庚午"]
```

祖沖之<v>大明</v>簡直是一股清流，是<v>統天</v>以前的最佳值，463 年的理論値是 .2422843592，只多了 40 多秒。可見祖沖之完完全全是根據實測確定斗分。

## 躔離

### 槩念、符號

太陽運動很簡單，週期項影響不大，用一次傅立葉函數就能比較準確地擬合，但有一個問題是，基本上所有的古曆都以冬至爲近日點<n>日速最快</n>，實際上並不是這麼回事，在 1250 年左右纔是正好以冬至爲近日點，往前往後誤差都會越來越大，只有<v>儀天曆</v>對日躔表有意識地做出了修正。月亮運動相當複雜，週期項非常多，而古曆都僅僅以一個近點月爲週期，我們只能用非常粗糙的近似修正來模擬古曆模型，這也是一個一次傅立葉函數。

表格各欄依次爲：

- 日盈縮積，距冬至日數這麼多天，太陽實際上走了多少度
- 月遲疾積，入近點月這麼多天，月亮實際走了多少度
- `日行改正 = 日盈縮積 / (月實行速-日實行速)`
- `月行改正 = -月遲疾積 / (月實行速-日實行速)`

`平朔 + 日行改正 + 月行改正 = 定朔`，`平氣 - 日盈縮積 = 定氣`，`入交定分 = 入交泛分 + 太陽改正 + 0.078507*月亮改正`。

自<v>乾象</v>始有月行遲疾，自<v>大業</v>始有日行盈縮，月離表、日躔表卽用來記錄每日、每氣的日月實行情況。表格的數據是離散的，所以要用內插法來計算特定時刻的日月實行。自<v>乾象</v>到<v>大業</v>、<v>戊寅</v>皆用線性內插，<v>皇極</v>始用二次差內插，到<v>授時</v>用三次公式。

- <v>隋志中</v>說張賔<v>開皇</v><q>「減朓就朒」</q>，我猜<q>「朓朒」「朏朒」</q>一詞就是張賔開始用的，隨後劉焯<v>皇極</v>沿用，成爲盈縮積的替代說法。晦而月見西方謂之朓，朔而月見東方謂之朒。

古代沒有負數運算的槩念，所以遇到負數都要轉換爲正數，朓朒的正負問題詳見張培瑜等<v>中國古代曆法</v>470 頁。但是要區別對待不同曆法的正負問題非常麻煩，所以我程序中所有曆法的正負都是這樣的：

<img src="https://pic.imgdb.cn/item/60950477d1a9ae528f3cfb1c.jpg">

依次爲：盈縮積、實行速、損益率、列差<n>圖很不精確，只是意思意思</n>。

另外，「四七日」指的是近點月中 6.8886、13.7772、20.6656、27.5545 這四個七日<n>向上取整</n>，這四點是轉折點，當日損益率需要分段處理<n><v>皇極</v>、<v>欽天</v>處理爲 6 8/9, 13 7/9, 20 6/9, 27 5/9</n>。有個標點本斷爲「四、七日」，哈哈。

另外，平朔一般稱「經朔」，<v>欽天</v>稱「常朔」，<v>庚午</v>稱「中朔」。

### 分母

精確的日月改正算法是：(日盈縮積 - 月朓朒積) / (月實行速 - 日實行速) 。這其實是一個簡單的 `t = v / s` 問題，不用考慮符號正負。古曆日月改正的算法可以統一爲這樣<n>加〔六角括號〕的是不同曆法或有或無</n>：

1. 日盈縮積或月朓朒積 = 整日朓朒積 + 該日損益率 * 比例
2. 月實行速 = 整日月實行速 + 〔列差*比例〕
3. 改正數 = (〔日盈縮積〕- 月朓朒積) / (月實行速<n>或月平行速</n> - 〔日平行速〕)

理想的分母是 `月實行速 - 日實行速`，但是不同時期的曆法所選分母各不相同，魏晉曆法基本上是 `月實行速-日平行速`，北系是 `月平行速`，大業是 `月實行-日平行`，隋唐宋系反而退步，都是 `月平行`，授時曆 `月實行`。<n>另可見<v>中國古代曆法</v>第434頁</n>

後來突然想到，之所以分母要用 `月平行速`，而不用 `月平行-日平行`，是因爲古曆太陽改正都比實際偏大許多，分母更大的話能夠抵消一部分誤差。各曆太陽朏朒極值：麟德 2.767，大衍降到 2.42，此後一直在 2.4—2.42 之間，南宋後期會元達到最低的 2.3，後來三部南宋曆是 2.36，授時又返回 2.4，而實際上只有 1.98。若用這樣的比例抵銷，`2.14 * 12.36875/13.36875 = 1.98`，最常見的 2.4 等於 2.22。所以看起來唐以後相比魏晉退步了，但實際效果應該相差不多。

### 線性還是二次？

<v>崇天</v>日躔：

> 求經朔弦望入氣朏朒定數：各以所入氣小餘乘其日損益率，如樞法而一，卽得。

明確說「其日」，則是二次插值。每部曆法都會根據日躔術和二十四節氣表編製全年每日的立成表，這就是「其日」的意思，在具體編製每年曆書時只用査立成表進行線性內差卽可<n>這是我猜的</n>，但曆志中無一保存了唐宋曆的立成表，只能自己根據日躔術來寫程序。各曆二次插值具體形式有所不同。對於<v>皇極</v>二次公式，劉鈍<n><v>皇極曆中等間距二次插值方法術文釋義及其物理意義</v></n>、曲安京<n><v>曆法</v>頁 240</n>有不同理解。原文「前少者⋯⋯乃別差加之」，劉鈍改爲「半別差減之」，而「前多者，卽以總差加末率」，劉鈍補上「半別差減之」；曲安京則完全未改動原文，指出這是<v>皇極</v>的失誤之處。結合<v>皇極</v>其他三種二次插值術<n>求月朔弦望應平會日所入遲速、推朔弦望定日術、求月入交去日道</n>來看，劉鈍校改之後的纔是術文原貌。對於崇玄，曲安京說原文是「日差」，但可能是「半日差」之誤。王榮彬認爲儀天、崇玄完全一致<n>王榮彬<v>中國古代曆法的中心差算式之造術原理</v></n>，而崇玄又與崇天完全一致<n>曲安京<v>曆法</v>頁 241</n>。以上觀之，日躔等間距二次差公式有這四種形式：

符號：`Δ1` 爲本氣升降分、損益率，`Δ2` 爲後氣升降分、損益率，`(Δ1-Δ2) / n` 是總差、合差、差率，`(Δ1 - Δ2) / n^2` 是別差、日差。

1. 麟德：氣初日消息數 `(Δ1+Δ2)/2n + (Δ1-Δ2)/n`
2. 皇極：氣初日遲速數 `(Δ1+Δ2)/2n + (Δ1-Δ2)/n -(Δ1-Δ2)/2n^2`
3. 應天乾元：氣初日盈縮分 `Δ1/n + (Δ1-Δ2)/2n`
4. 崇玄儀天崇天以後：`Δ1/n + (Δ1-Δ2)/2n - (Δ1-Δ2)/2n^2` 

其中 1、3 等價，2、4 等價，在 1、3 的基礎上考慮半日差卽爲 2、4。經驗算，算法 4 與招差術結果相等，可以用招差術替代日躔術；對於算法 1、3，只能另外單獨編寫程序。

<v>儀天</v>採用公式進行計算，其公式是完全精確的<n>王榮彬<v>中國古代曆法的中心差算式之造術原理</v></n>，所以理論上來講可以用<v>儀天</v>公式來代替其他各曆的表格，只需修改系數卽可。<v>儀天</v>象限採用定氣，卽 88.9、93.7 兩種，盈縮積、朏朒積在二分 88.9 日達到極值；而表格法宋曆都用的平氣，在 91.3 日達到極值，我把象限統一爲 91.3 日。以<v>紀元</v>爲例驗算，公式算法與表格算法存在不可忽視的差別，看來並不能用公式代替表格，只能用招差術。這是表格各氣二次差不同造成的，<v>儀天</v>公式默認的前提是一象限中各氣二次差相等。

至於不等間距內插的曆法，經驗算，<v>大衍</v>、<v>宣明</v>公式與拉格朗日內插等價，所以程序中直接調用拉格朗日內插。

再看月離表的算法。<v>皇極</v>一直到<v>崇玄</v>，月亮改正都用等間距二次內插，並且都進行了第二遍修正，交食用二次內插，注曆用線性內插。但是第二遍修正太難了<n><v>中</v>皇極、大衍相關部分寫了第二遍修正的算法</n>，我暫時忽略，只用招差術進行第一遍二次修正。到了宋曆，月離全都僅僅是線性內插，一下簡單不少，如<v>崇天</v>：

> 求朔弦望入轉朏朒定數：置所入轉餘，乘其日損益率，樞法而一，所得，以損益其下朏朒積爲定數。其四七日下余如初數下，以初率乘之，初數而一，以損益朏朒爲定數。

宋曆無一採用二次內插進行月離改正。

此前我一直把<v>皇極</v>以後的定朔躔離改正分爲二次和一次，二次改正=二次日躔+二次月離，一次改正=一次日躔+一次月離。經過以上梳理，眉目終於清楚了：

- 【唐曆】交食：二次改正 = 二次日躔 + 二次月離。定朔：一次改正 = 二次日躔 + 一次月離
- 【宋曆】交食、定朔：二次改正 = 二次日躔 + 一次月離
- 【授時】交食、定朔：三次改正 = 三次日躔 + 三次月離

### 欽天步月

<v>授時</v>編製曆書時用立成表來線性內插，立成是用三次內插函數編製的，一近點月分 336 限，所以可以用線性來代替三次內插。程序直接用公式計算，方便快捷，省去錄入立成之苦。<v>授時</v>月離立成大槩受到五代<u>王樸</u><v>欽天</v>的啓發，<v>欽天</v>月行析爲 248 限，用二次內插編製立成，用立成取代以往的每日月離表，編製曆書時直接用線性內差。

上文說過月離朓朒的計算，在唐代，只有交食用二次內插，一般注曆用線性內插，到宋代，乾脆交食也只用線性內差了。<u>王樸</u>批評道：

> 自古朓朒之法，率皆平行之數；入曆旣有前次，而又衰稍不倫。降及諸曆，則疎遠而多失。

「衰稍不倫」大概指線性內差誤差很大。248 限的好處是省去「<v>皇極</v>舊術，則迂迴而難用」的計算之煩，又能夠非常接近二次內插的效果，達到「衰稍有倫」的理想狀態。<v>欽天</v>的算法爲曆法史上的唯一，「今以月離朓朒，隨曆校定，日躔朓朒，臨用加減。」先計算日躔朓朒，加在經朔入轉上，得「入離定日」，再來計算月離朓朒。這樣從理論上來講比直接用經朔入轉準確，卽「入曆旣有前次」，不明白的是爲什麼後世不延用。<v>欽天</v>近點月分 248 限，程節 800，算來 `248 * 800 = 198400` ，和轉分 `198393.09` 差一些，但這點誤差落在了小數點後 5 位，不會造成任何影響。

可惜<v>欽天</v>躔離表沒有流傳下來，我只好將五紀、紀元月離表平均，用二次招差術歸算爲 248 限立成，進行線性內插。看到<v>疇人傳</v>說歐陽公不懂曆法，看到躔離表太繁雜，索性刪掉，可恨可恨啊！

### 授時步月離

這是<v>授時</v>的月遲疾積度<n>唐宋稱朓朒</n>函數 `f(限) = (11.11限 - 0.0281限^2 -0.000325限^3)/100`：

![](https://pic.imgdb.cn/item/60b86a638355f7f718e6e4f1.jpg)

月亮改正在四個象限都是對稱的，<v>授時</v>近點月 27.5546 日分 336 限，每限 0.082，一象限爲 6.888625 日 84 象限，取該函數 0—84 的這一段。從圖像可知該函數極值 `f(81.748) = 5.429`，所以在 81.748—84 之間還有一點塌陷。朓朒極值 `5.429度 / 13.36875度每日 = 0.4061日`

又想到，之所以宋代只有<v>明天</v>用公式計算月離，其他都用表格，因爲遲疾差積在轉折點附近有比較大的停留，而二次函數不能擬合這種停留。直到<v>授時</v>發明三次內插，纔能完美替代表格。太陽盈縮差積的停留不那麼明顯，用二次函數就能比較好地擬合，與三次函數的誤差不會太大，所以宋代<v>儀天</v>、<v>明天</v>、<v>觀天</v>都用公式代替表格。<v>紀元</v>爲了追求精確，又回到表格的老路上。

## 日軌

### 黃赤轉換

古代天文模型是以赤道爲基準，所謂「赤道者，常道也，其數常定，紘帶天中，儀極攸準」，太陽的黃道度要根據赤道轉換而來。只有<v>授時</v>求出來的直接就是黃道度，反而需要將黃度轉爲赤度。

度數從冬至起算，二至到二分：赤大於黃；二分到二至：黃大於赤。只有<v>紀元</v>有黃轉赤公式，其餘只能赤轉黃，我用與<v>紀元</v>相同的求反函數思路，復原出各宋系曆法的黃轉赤公式。最後一欄的赤緯是直接根據赤道度或黃道度算出來的，下面的赤緯是根據距離冬至日數算出來的，要考慮日躔，而表格法曆法在製表時已經考慮了日躔，所以此處不能加上表格法曆法的赤緯。小數點後 4 位的精度是 0.36”

> <v>纪元历</v>利用求根公式给出了二次函数的反函数，将唐代边岗的双二次函数改造成了一套漂亮的二次复合函数，这个大体上等价于对三角函数用泰勒级数展开以后的前4次项结果。在误差上，当角度大于40度时，他的算法的精度比泰勒级数还要好。

### 會圓術

輸入圓的半徑 r、弓形的高「矢」h、週天度。會圓術求法：半弦長 <code>c = sqrt (r^2 - (r-h)^2)</code>。尤其需要注意的是，會圓術的標準是週天度 365.25，直徑 121.75，卽「週三徑一」，這個單位系是以 3 爲標準，而非圓周率 π<n>鄧可卉<v>授時曆中的弧矢割圓術再探</v>，<v>自然科學史研究</v>2007(2)</n>，所以在與三角函數對照時，需要進行參照系轉換，詳見源代碼。可以發現，弧-矢之間的轉換誤差大約在 1 度以內，而弦長誤差多達 5 度餘，這是單位系不同造成的。在弧矢割圓術中，以弧作爲入口，用會圓術轉換爲弦長，最後再以弧作爲出口，將弦長轉換爲弧長，單獨來看，弦長的誤差相當大，但是在同一個單位系之中，這是自洽的。

傅宗<v>隙積術和會圓術</v>：

<img src="https://pic.imgdb.cn/item/609533e4d1a9ae528fb89250.png" width='800'>

### 弧矢割圓術

<img src="https://pic.imgdb.cn/item/60953023d1a9ae528f948bb3.png" width='270'>

圖<n><v>中國古代曆法</v>頁 627</n>中 AOE 是赤道，AOD 是黃道，BD 是已知的黃道度，求 CE 長<n>卽赤道度</n>、BC 長<n>赤緯</n>。

<v>授時</v>用弧矢割圓術進行太陽黃赤轉換。<v>授時</v>黃赤轉換用幾何模型，此前的曆法都是經驗公式。由於會圓術的誤差，弧矢割圓術的誤差甚至比<v>紀元</v>的經驗公式還略差。弧矢割圓術是近似三角形、勾股定理、會圓術的組合，前兩者都是精確公式，只有會圓術是近似公式，那麼從理論上來講，如果用三角函數代替會圓術，就能得到和球面三角完全一致的結果，實際上也是這樣的。

授時只有黃度轉赤度的方法，我另外推導出了赤度轉黃度的方法：從 C 向上作垂線，與 OB 相較於點 T，T 超出了球體。從 P 向上作垂線，交 OD 於 Q。有了這兩條輔助線，就可以從赤轉黃了。

此處與上面授時黃赤轉換的區別是這裏可以隨意輸入黃赤交角。第一行「球面三角」是球面三角黃赤轉換的公式，第二行「三角割圓」是用三角函數代替會圓術的弧矢割圓術。弧矢割圓術在黃赤度數和黃赤交角在 45—50 度附近誤差達到最大，約 0.4 度。

### 三斜求積術

輸入三角形三邊邊長，求面積。秦九韶三斜求積術與希倫公式等價。

### 積度轉宿度

先秦時期的赤道宿度已不可俱考，但是出土材料能提供很多線索。到太初改曆，赤道宿度就固定下來了：

```javascript
    [12, '角'], // 1 東宮 總75
    [9, '亢'], // 2
    [15, '氐'], // 3
    [5, '房'], // 4
    [5, '心'], // 5
    [18, '尾'], // 6
    [11, '箕'], // 7
    [26, '斗'], // 8 北宮 總98
    [8, '牛'], // 9
    [12, '女'], // 10
    [10, '虛'], // 11
    [17, '危'], // 12
    [16, '室'], // 13
    [9, '壁'], // 14
    [16, '奎'], // 15 西宮 總80
    [12, '婁'], // 16
    [14, '胃'], // 17
    [11, '昴'], // 18
    [16, '畢'], // 19
    [2, '觜'], // 20
    [9, '參'], // 21
    [33, '井'], // 22 南宮 總112
    [4, '鬼'], // 23
    [15, '柳'], // 24
    [7, '星'], // 25
    [18, '張'], // 26
    [18, '翼'], // 27
    [17, '軫'], // 28
```

<v>太初</v>的赤度一直沿用到唐初。<v>大衍</v>重新制定了一份赤度表：

```javascript
    [12, '角'], // 1 東蒼龍
    [9, '亢'], // 2
    [15, '氐'], // 3
    [5, '房'], // 4
    [5, '心'], // 5
    [18, '尾'], // 6
    [11, '箕'], // 7
    [26, '斗'], // 8 北玄武
    [8, '牛'], // 9
    [12, '女'], // 10
    [10, '虛'], // 11
    [17, '危'], // 12
    [16, '室'], // 13
    [9, '壁'], // 14
    [16, '奎'], // 15 西白虎
    [12, '婁'], // 16
    [14, '胃'], // 17
    [11, '昴'], // 18
    [17, '畢'], // 19
    [1, '觜'], // 20
    [10, '參'], // 21
    [33, '井'], // 22 南朱雀
    [3, '鬼'], // 23
    [15, '柳'], // 24
    [7, '星'], // 25
    [18, '張'], // 26
    [18, '翼'], // 27
    [17, '軫'], // 28
```

改動主要在西方。<v>大衍</v>的赤度表一直沿用到宋代。<v>明天</v>重新定出一份赤道宿度表：

> 自漢太初後至唐開元治曆之初，凡八百年間，悉無更易。今雖測驗與舊不同，亦歲月未久。新曆兩備其數，如淳風從舊之意。

以從舊之誼，<v>明天</v>還是沿用<v>大衍</v>的赤度表。直到北宋最後一部曆法<v>紀元</v>又做出調整：

```javascript
    [12, '角'], // 1 東蒼龍
    [9.25, '亢'], // 2
    [16, '氐'], // 3
    [5.75, '房'], // 4
    [6.25, '心'], // 5
    [19.25, '尾'], // 6
    [10.5, '箕'], // 7
    [25, '斗'], // 8 北玄武
    [7.25, '牛'], // 9
    [11.25, '女'], // 10
    [9, '虛'], // 11
    [15.5, '危'], // 12
    [17, '室'], // 13
    [8.75, '壁'], // 14
    [16.5, '奎'], // 15 西白虎
    [12, '婁'], // 16
    [15, '胃'], // 17
    [11.25, '昴'], // 18
    [17.25, '畢'], // 19
    [0.5, '觜'], // 20
    [10.5, '參'], // 21
    [33.25, '井'], // 22 南朱雀
    [2.5, '鬼'], // 23
    [13.75, '柳'], // 24
    [6.75, '星'], // 25
    [17.25, '張'], // 26
    [18.75, '翼'], // 27
    [17, '軫'], // 28
```

就這樣用了一百多年。直到<v>授時</v>給出了新的觀測結果：

```javascript
    [12.1, '角'], // 1 東蒼龍
    [9.2, '亢'], // 2
    [16.3, '氐'], // 3
    [5.6, '房'], // 4
    [6.5, '心'], // 5
    [19.1, '尾'], // 6
    [10.4, '箕'], // 7
    [25.2, '斗'], // 8 北玄武
    [7.2, '牛'], // 9
    [11.35, '女'], // 10
    [8.7, '虛'], // 11
    [15.4, '危'], // 12
    [17.1, '室'], // 13
    [8.6, '壁'], // 14
    [16.6, '奎'], // 15 西白虎
    [11.8, '婁'], // 16
    [15.6, '胃'], // 17
    [11.3, '昴'], // 18
    [17.4, '畢'], // 19
    [0.05, '觜'], // 20
    [10.1, '參'], // 21
    [33.3, '井'], // 22 南朱雀
    [2.2, '鬼'], // 23
    [13.3, '柳'], // 24
    [6.3, '星'], // 25
    [17.25, '張'], // 26
    [18.75, '翼'], // 27
    [17.3, '軫'], // 28
```

<v>紀元</v>觀測精度已達到了 0.05 度。如果單從數字改變幅度來看的話，影響最深的是<v>太初</v>和<v>紀元</v>的赤度表。

而黃道觀測結果就更迭得頻繁得多，想看具體情況，可以看我的源代碼。

這個工具提供了各曆的宿度轉換，需要根據年代選用當時的曆法：<v>太初</v>前 104 — <v>麟德</v>665— <v>大衍</v>729 —<v>應天</v>964—<v>明天</v>1065—<v>紀元</v>1106 或<v>重修大明</v>1180—<v>授時</v>1281 

#### 斗分

「斗分」是什麼意思呢？歲實<n>回歸年長度</n>= 365 + 斗分 / 度法<n>當然，不同曆法有不同的名字</n>。<v>黃初</v>作者韓詡認爲<v>乾象</v>「減斗分太過，後當先天」，大槪就是比較早的出現「斗分」一詞的材料了。爲何要叫「斗分」？中國古代一週的度數是歲實，所以每部曆法都有各自的圓周度數，而我們看<v>太初</v>的赤度表，發現其中都是整數，沒有小數，這是怎麼回事？一般而言，小數點要加到斗宿的後面，所以叫 <b>斗分</b> ，曆法術語表述爲「經斗去分」。到了祖沖之將歲差引入曆法後，各曆上元日所在赤度一般在虛，所以小數點加在虛宿後面，卽「經虛去分」。因此唐代以後，「斗分」一詞就不再用了，否則就要叫「虛分」了。

#### 備忘

- <v>皇極</v>日所在宿度直接是黃道度。「劉焯歷仁壽四年<n>605</n>冬至，日在黃道斗十度，於赤道斗十一度也。」我算出來是斗 13，奇怪。

#### 黃道過宮

以後補充。直到時憲曆，宮纔固定是十二中氣，此前都沒有對應起來。

## 里差（地理位置東西時差）

《庚午》是唯一有里差的古曆：

> 《求朔弦望中日》以尋斯干城為準，置相去地里，以四千三百五十九乘之，退位，萬約為分，曰里差。以加減經朔弦望小餘，滿與不足，進退大餘，即中朔弦望日及餘。〔以東加之，以西減之。〕

算了《重修大明》和《庚午》，《庚午》經朔正好少了 1700 分，`24 * 0.17 = 4.08時 = 2.04辰`，結合 [郭津嵩：撒马尔干的中国历法——蒙古扩张中的知识变动及其文化因素](https://mp.weixin.qq.com/s/Yx3koK5KL11tnJeRC-_GbA)，「撒马尔干与燕京之间距离和时差的估计分别是二万里和二时」，考慮到修正因素，則尋斯干城與中國都城正好相差 2 辰。另外，里差並無球面三角經度的意義，只表示地表距離。

`里差 = 里  * 4359 / 10 /10000`，尋斯干城與中國都城的里差是 `20000 * 0.04359 / 日法5230 = 0.16667` 日，正好 2 辰。《庚午》經朔比《重修大明》減少 `33.3333 / 5230 = 0.63735 刻`。 撒馬爾罕在 67°E，北京在 116°E，時差 3.27 小時，遠小於 4 小時，耶律楚材高估了兩地距離。

里差怎麼用？

> 《求天正冬至》置上元庚午以來積年，以歲實乘之，為通積分；滿旬周，去之；不盡，以日法約之，為日，不盈為餘⋯⋯〔先以里差加減通積分，然後求之。〕
>
> 《求冬至赤道日度》置通積分，以周天分去之⋯⋯〔其在尋斯干之東西者，先以里差加減通積分。〕                                                    
>
> 《求經朔弦望入轉》置天正朔積分，以轉終分及秒去之，不盡，如日法而一，為日，不滿為餘秒，即天正十一月經朔入轉日及餘秒⋯⋯〔加減里差，即得中朔弦望入轉及餘秒〕
>
> 《求朔望入交》〔先置里差，半之，如九而一，所得依其加減天正朔積分，然後求之。〕置天正朔積分，以交終分去之
>
> 《求五星天正冬至後平合及諸段中積中星》置通積分，〔先以里差加減之。〕各以其星周率去之，不盡，為前合分

先把里差加在通積分上，接著按一般步驟求冬至、冬至日度、五星前合分。求經朔入轉，先用朔積分求得入轉日，再加減里差。「朔積分」是用沒有加減里差的通積分求得的：「置通積分，滿朔實去之，不盡，爲閏餘；以減通積分，爲朔積分」。稍微麻煩一點的是入交，`里差 / 2 / 9` 加到朔積分上，再求入交，為什麼要除 18 呢？按這樣的方法加上里差後，《庚午》比《大明》入轉日多 0.02 日，入交日少 0.002 日，幾乎每區別。

## 步晷漏

假設 1 尺 = 20 cm，小數點後 4 位是精度就是 20μm。日出時刻 = 夜半漏 + 一般 2.5 刻<n>一日百刻。</n>球面三角的日出、晷長有兩行，上行計入蒙氣差、日視半徑等修正因素，作爲誤差 1 標準，下行未加入修正，作爲誤差 2 標準。陳美東<v>中國古代太陽視赤緯計算方法</v>：各曆法赤緯誤差<n>度</n>：四分 0.7，麟德 0.13，大衍 0.06，宣明、儀天 0.45，崇玄 0.09，崇天 0.23、明天 0.2，觀天 0.21，紀元、授時 0.11。各曆漏刻誤差<n>分鐘</n>：授時 0.7、乾元、紀元、重修大明、庚午 3.8，四分、景初、元嘉 4.4，崇玄 4.6，大明 4.7，皇極 5.6，大業戊寅 6.1，麟德 4.6，明天、觀天 4.9，大衍 5.1，崇天 6.2，宣明 7.7，儀天 7.9。

藤豔輝<v>紀元曆日食算法及精度分析</v>距離冬至 31.816049 日，紀元日出 2126.2566/7290 = 29.1667572，我之前是直接用黃經，是 29.227518，差了 1 天多，改用距冬至日數，加上日躔，29.1664，只有 0.08 秒的區別。所以其他計算也應該要加上日躔。

### 觀測地點

各曆觀測地點及緯度<n>北極出地高度</n>，現代採用 360°，曆測採用古度：

- 四分、景初、元嘉、大明。洛陽34.6667<n>現代</n>
- 皇極、大業、戊寅、麟德、宣明：長安34.2833，
- 大衍、宣明、崇玄、應天、儀天、崇天：陽城34.4047<n>現代</n>，34.475<n>大衍宣明曆測</n>
- 欽天：岳臺 34.9<n>曆測</n>
- 乾元、明天、觀天、紀元、重修大明、庚午：俊儀34.8125<n>現代</n>34.8<n>麟德曆測「唐貞觀初，李淳風於浚儀縣古岳臺測北極出地高三十四度八分」</n>
- 授時：大都39.9500<n>現代</n>40.95<n>曆測</n>

我暫時沒找到各曆對地理緯度的確切記載，以後要補上。

### 晝漏夜漏

晝夜的槩念也很迷惑。大部分曆法的昏明時長是 2.5 刻，`晝漏 = 日出至日入 + 2*昏明`，`夜漏 = 日至日出 - 2*昏明`，`夜半漏 = 夜漏 / 2`。各曆名詞各有不同。

- 「晨初餘數」是唐曆的槩念，在數據庫搜只有<v>唐志</v>有。`晨初餘數 = 日出 - 昏明`，只是單位換成了日法，因爲這時天矇矇亮，晨剛開始，所以叫晨初。<v>五紀</v>與<v>大衍</v>的第二條不同之處：「以三萬二千一百六十乘夜半定漏刻，六十七乘刻分從之，二千四百而一，爲晨初餘數。」其實就是一個單位轉換而已：`1 * 32160 / 2400 / 日法1340 = 0.01`
- <v>宣明</v>：`昏明小餘 = 夜半定漏`
- <v>欽天</v>晝夜分以日入日出爲界：`晝分 = 日入 - 日出`，`夜分 = 1 - 晝分`，單位是日法。
- 應天、乾元 `晨半分 = 日出 - 昏明`，`昏分 = 1 - 晨分`，`晝半分 = 日出`，`夜分 = 1 - 晝分`

大體而言，看到「晨昏」二字，就是日出日入加減了昬明 2.5 刻的，看到「晝夜」二字，就是日出日入。

## 月亮位置

<img src="https://pic.imgdb.cn/item/609a3a5dd1a9ae528f07863c.png" width='250'>

黃赤白道示意圖<n><v>數</v>頁 347</n>

需要輸入此刻入降交點<n>正交</n>交點月的日數、距離冬至的日數。距離冬至日數會加上日躔、轉換爲黃道度，再進行接下來的計算。正交至半交：白大於黃，半交至正交：黃大於白。一交點月約 27.21222 日。一些觀點認爲，<v>大衍</v>月黃緯表用到了三次內插，我算得前半段<code>Δ = 171, -24, -8</code>後半段<code>Δ = -75, -40, 8</code>；曲安京否定這種說法，實質上還是二次。<v>宋曆</v>第一行赤道度以九道術求得，第二行以黃赤轉換公式求得；<v>授時</v>赤道度則直接以弧矢割圓術求得。赤白差一欄，除了紀元，都是赤道-白道，紀元較爲特殊，日月同名：赤白差=黃赤差+黃白差，異名：赤白差=黃赤差-黃白差

### 月行九道

<v>大衍</v>開始有月行九道法，以步黃道月道之差<n>四季爲節氣，而非月份</n>：

```
   | 春  夏  秋  冬 
------------------
陽 | 朱  靑  黑  白   
陰 | 黑  白  朱  靑
```

再加上與黃道交會，一共就是九道。<v>崇天曆</v>：

> 推月行九道：凡合朔所交，冬在陰曆，夏在陽曆，月行靑道；<n>冬、夏至後，靑道半交在春分之宿，當黃道東；立冬、立夏後，靑道半交在立春之宿，當黃道東南：至所衝之宿亦如之。</n>冬在陽曆，夏在陰曆，月行白道；<n>冬、夏至後，白道半交在秋分之宿，當黃道西；立冬、立夏後，白道半交在立秋之宿，當黃道西北：至所衝之宿亦如之。</n>春在陽曆，秋在陰曆，月行朱道；<n>春、秋分後，朱道半交在夏至之宿，當黃道南；立春、立秋後，朱道半交在立夏之宿，當黃道西南：至所衝之宿亦如之。</n>春在陰曆，秋在陽曆，月行黑道。<n>春、秋分後，黑道半交在冬至之宿，當黃道北；立春、立秋後，黑道半交在立冬之宿，當黃道東北：至所衝之宿亦如之。</n>

九道術前身是<u>劉洪</u><v>乾象</v>月行三道術，只有陰陽黃三道。漢代也有九道術，但是跟唐宋九道術沒什麼關係，漢代九道用來推算月行遲疾。<n><v>數</v>頁 336</n><u>陳久金</u>的示意圖：

<img src="https://pic.imgdb.cn/item/6095052ad1a9ae528f424d26.png" width='500'>

<v>數</v>頁 341：

<img src="https://pic.imgdb.cn/item/6099f0f8d1a9ae528f5344bb.jpg" width='650'>

## 交食

我把交會推步分一下階段：

0. 漢代：只能根據交食週期判斷是否可能出現日月食。
1. 魏晉南北朝：可以計算食分多少，判斷交食程度、虧食所起。
2. 隋唐初<n><v>大業</v>、<v>戊寅</v>、<v>皇極</v>、<v>麟德</v></n>：出現時差、食差改正，但相當不成熟，瑣碎不堪複雜無比。
3. 盛唐中唐<n><v>大衍</v>、<v>五紀</v>、<v>正元</v>、<v>欽天</v></n>：規範化。<v>宣明</v>之後， <v>崇玄</v>另起爐灶，五代<v>欽天</v>又回到<v>大衍</v>的思路，把食差加在食限上，而非去交分上。經過一番角逐，最終<v>宣明</v>方案勝出。<n>此前人所未發。</n>
4. 唐後期至北宋前期，<v>宣明</v>：日食三差公式算法確立下來，奠定後世步交會基本模式。此後<v>應天</v>、<v>乾元</v>、<v>儀天</v>都在不斷調整，變動幅度也不小。
5. <v>崇天</v>以後：成熟定型，此後各曆只有比較小的區別。<v>紀元</v>標誌著完全成熟。這一階段比以往都要簡明精練。

古代判斷交食都是用黃白經差，而月黃緯沒有參與計算，可能只是用來輔助判斷。

### 日食表格說明

<v>大業</v>、<v>戊寅</v>、<v>皇極</v>、<v>麟德</v>要根據月份來判斷，這裏爲了簡化輸入，改爲用節氣判斷季節，這不準確。入交日在正交、半交附近發生交食，交點月的一半約爲 13.6061。

### 參數、槩念

#### 交點月

交點月與交食週期轉換公式：`Node = Lunar * 交食週期/ (0.5 + 交食週期)`<n>我的獨創發明</n>。<v>皇極</v>是唯一<n>不確定</n>旣有交食週期又有交點月的曆法，以<v>皇極</v>驗之，分毫不差。<v>大明</v>以前無交點月，只有交食週期，我藉此全部統一爲用交點月進行計算，非常方便。可輸入小數或分數，算出來的小數可通過「同餘」標籤中的「連分數」化爲漸進分數。

#### 交點退行速度

交點退行速度用此公式計算： `Sidereal = (V月 + V退) * Node`，再把月平行速 `V月 = Sidereal/Lunar + 1` 公式代入，得 `V退 = Sidereal/Node - Sidereal/Lunar - 1`，我們可以用這個公式計算任意曆法的交點退行速度。<v>明天</v>步交會中的「朔差」表示一個朔望月交點退行距離<n>藤豔輝<v>宋代朔閏</v>頁 95</n>。

#### 交率交數

入交定日、去交定日指日月從黃白交點運動到定朔望的時間<n>黃經差</n>。由於日月速度不同，月亮從正交運動到平朔望時刻的時間與太陽不同。`入交定日 = 入交泛日 + 日改正 ± 交率/交數 * 月改正`

`交率/交數 = 交點月/交點年 = (V日+V退) / (V月+V退) = 27.2122/346.608 ≒ 0.0785` <n>見劉金沂<v>隋唐曆法中入交定日術的幾何解釋</v>，<v>自然科學史研究</v>1983(4)</n>

經過驗證，這個公式完全可靠，我們用上面的工具計算一下幾部曆法：

- <v>紀元</v>交率/交數 324 / 4127 = 0.07850739，精確値爲 7323715785246679/93286970952593250 = 0.078507381，精確到了小數點後 7 位，非常棒。通過「同餘」標籤下的連分數計算，可見紀元交率是精確值的一個漸進分數。
- <v>觀天</v> 183 / 2331 = 0.07850708，精確值爲 3271955768163223/41677024412605020 = 0.078507422597416，精確到了小數點後 6 位。
- <v>重修大明</v>10/127 = 0.07874，精確值 4098461650124679/52204833831588280 = 0.0785073，有些出入。
- <v>欽天</v> 72 / 963 = 0.0747664，精確值 5214687527858525/66791617777516270 = 0.078074，相差有點遠，計算漸進分數，沒有和 72 / 963 長得像的，所以應該不是傳鈔錯誤。

#### 食限

<v>宣明</v>、<v>應天</v>、<v>乾元</v>、<v>儀天</v>陽曆食限 4.2 度左右，陰曆 9.6 度，<v>崇天</v>、<v>觀天</v>陽 5.3，陰 8.84，<v>紀元</v>陽 4.88，陰 9.76，<v>授時</v>陽 6，陰 8。

#### 時差

古曆日食時差是基於定朔時刻 `r` 的一元函數，`R = | 0.5 - r |`，則 `時差 = kR(0.5 - R)`。但理論上還應該考慮太陽黃經，如果授時曆加上一個黃經的線性函數，就能很好地與理論曲線脗合。

#### 食差

食差是對日食視差影響的修正。由於視差，視月亮位置總是比真實位置低，古人用相對的模型，視太陽、視黃道比真實位置高，可以用此圖幫助理解<n>這個思路是我自己想的</n>：

<img src="https://pic.imgdb.cn/item/60bb916a8355f7f7187df301.jpg" width='350'>



虛線是真實的黃道、陰陽曆分界線<n>簡稱眞陰陽界</n>，以上是陰曆，以下是陽曆，實線是視黃道、視陰陽界，虛線到實線的距離就是食差，豎著的兩條折線是食限<n>月道當然是一條直線，我只是爲了好看</n>，月亮在食限之內則食。實線以上的區間 A 是陰曆，實線到虛線之間的區間 B 是類同陽曆，虛線以下的區間 C 是陽曆。由於視陰陽界移動到了實線，區間 B 的真位置雖然是在陰曆，但視位置是在陽曆，所以叫類同陽曆。去交分從眞陰陽界起算，箭頭方向表示增減方向；食分則以視陰陽界爲標準，離視陰陽界越近，食分越大；所以在陰曆和陽曆，都是去交分越大，食分越小，而在類陽曆，去交分越大，越靠近視陰陽界，食分越大。<v>大衍</v>、<v>欽天</v>是把食差加在陰陽界上，去交分不動，而<v>宣明</v>及後世曆法是把食差加在去交分上，陰陽界不動，兩者都是一個意思。有了這樣的認識，我們就能很快理解各曆術文。

書上看到的：食差只與月亮天頂距有關，與午正前後無關，古曆卻將此作爲正負判斷依據，完全不對，只能是正誤參半。

### 階段四五步交會

本文是一個提綱，主要目的是明晰各曆槩念的區別、各算法的自變量，這是最要命的。相關論文也有，但是看得不明不白，只好自己根據宋志等原文重新理一遍。

爲節省篇幅，「入交」表示加時入交日及餘分<n>或餘秒</n>。日月改正包含以距離爲單位的先後積和以時間爲單位的朏朒積，我統一稱爲日月改正，讀者需加以區分<n>凡言積度，則爲先後積；凡言入交，則爲朏朒積</n>。需要注意各名詞的細微區別，可能一字之差就完全不同。`月改正(定朔入轉)` 表示以定朔入轉爲自變量的月改正，`午前後分(定餘)` 表示午前後分以定餘爲自變量。「朔」指「朔望」。比例指 `交率/交數 ≒ 0.0785`，各曆比例不同。日月改正爲太陽改正、月亮改正相加減。

南宋各曆全同紀元；遼金系和紀元很像，除了單獨說明的，其他基本上都是紀元。

#### 〇、布算

<v>戊寅</v>：日出後日入前一時半<n>12.5 刻</n>，不注月食，<v>麟德</v>再加上：晨昏之間不可見食甚。<v>大統</v>：「定朔小餘在日出前日入後二十分已上者，日食在夜；定望小餘在日入前日出後八刻二十分已上者，月食在晝——皆不必布算。」不知道「日入後二十分」中間是不是漏了幾刻。<v>授時</v>日食時差的極大值是 6.5 刻，半食延的極大值是 5.74 刻，那麼日入後應該就看不到初虧了，所以就是二十分，沒有漏。其他曆法就不知道什麼情況了。

#### 一、入交

「定朔入轉」的概念也困擾我很久，終於在<v>授時</v>找到解釋：

> 置經朔弦望入轉日及分，以定朔弦望加減差加減之，爲定朔弦望加時入轉；以定朔弦望日下分減之，爲夜半入轉。

<v>大統</v>：

> 置經朔弦望遲疾曆，以定朔弦望加減差加減之。在疾曆，便爲定朔弦望加時入轉日；在遲曆，用加轉中。置定朔弦望加時入轉日，以定朔弦望小餘減之，爲夜半入轉日。

所以定朔入轉 = 經朔入轉 ± 日月改正。

天正經朔入交<n>應天：中盈度，乾元：平交朔日</n>

經朔夜半入交 = 經朔入交 - 小餘。

定朔夜半入交：整數日有進退的，加減一日，否則因經爲定<n>只有夜半是這樣，如果加時，就要相應加減了</n>。

明天求去交度分的算法很獨特，`交初度 = Sidereal - 積月 * 朔差 % Sidereal`，翻譯過來，就是上元以來交點退行的距離，再反減。這樣得到的是正交距冬至度數，另外再根據太陽距冬至度數，得出交前後分。

#### 二、入陰陽曆

朔入交常日 = 經朔入交 ± 日改正<n>應天：朔交初度分，乾元：朔交分</n>

【欽天乾元儀天崇天觀天遼金】朔入交定日 = 朔入交常日 ± 比例 × 月改正<n>乾元：度定分</n>

入陰陽曆()：

- 【應天】朔入交常日 ± 月改正<n>卽紀元的定朔入交泛日。很奇怪，不確定是不是這樣</n>
- 【應天乾元儀天崇天觀天遼金】朔入交定日

交前後分(入陰陽曆)

不論陰陽，近交初爲交初，在二十六日、二十七日爲交初；近交中爲交中，在十三日、十四日爲交中。交初交中主要用來判斷食差符號。

【紀元】食甚泛餘 = 經朔 ± 日月改正(朔入氣入轉)  ± 日月改正(朔入氣入轉) * 損益率(定朔入轉) <n>「朔入氣入轉」我暫時處理爲平朔</n>

【遼金】遼金系和紀元很像，除了直接以入交定日入陰陽曆，以及這條：食甚泛餘 = 經朔 ± 日月改正(朔入氣入轉) * 1337 / 轉定分(定朔入轉) 。

- 關於「泛餘」，<v>紀元</v>：

  > 以其朔望入氣入轉朏朒定數，同名相從，異名相消，副置之；以定朔、望加時入轉算外損益率乘之，如日法而一⋯⋯所得，視入轉，應朒者依其損益，應朏者益減損加其副；以朏減朒加經朔望小餘，爲泛餘。

  上文說過，唐宋以來躔離分母都是月平行速，這樣並不精確，這裏的泛餘實質上就是以月實行速爲分母的躔離。如果<v>紀元</v>還不好理解，那<v>重修大明</v>就非常明白了，乘月平行速，除月實行速，就等於把分母替換成了月實行速。<v>紀元</v>與<v>重修大明</v>幾乎等價。

【崇玄】定朔入交定積度 = 入交常日 * 月平行速<n>沒說入交常日是什麼，但是檢索交率、交數，發現只在列參數的時候出現一次，那麼很可能「入交常日」就是宋曆的「入交定日」。</n>

【崇天觀天】月入陰陽曆積度 = 入陰陽曆 * 月平行速

【紀元庚午授時】定朔入交泛日 = 經朔入交 ± 日月改正

【紀元庚午】定朔入交積度 = 定朔入交泛日 * 月平行速

【授時】交常度 = 經朔入交 * 月平行速

【紀元庚午】定朔入交定積度 = 定朔入交積度 ± 月改正(定朔入轉) 

【授時】交定度 = 交常度 ± 月改正(經朔入轉) 

#### 三、時差

只有紀元、授時有月食時差，其他都以定望爲食甚。

【應天乾元儀天崇天】午前後分(定朔) <n>宣明：初率末率，欽天：距午分，授時：中前後分</n>

【紀元庚午】中前後分(泛餘) 

【宣明應天乾元儀天】時差(午前後分, 半晝分) 

【欽天崇天觀天授時】時差(午前後分) 

【紀元】時差(中前後分)

【欽天應天乾元儀天崇天】食甚定餘 = 定朔 ± 時差

【明天】食甚 =  (經朔 ± 月改正) * 月平行速/月實行速 ± 日改正	

【紀元】食甚定餘 = 泛餘 ± 時差。

【應天乾元儀天崇天授時】距午分 = 午前後分 + 時差<n>應天：距中分，乾元：距午刻分，崇天：午前後定分、距午定分。注意，這裏是都加不減，紀元分加減：應天「以差皆加午前後分，爲距中分」乾元「皆加午前、後分，爲距日分；刻法而一，爲距午刻分」崇天「以時差加午前後分，爲午前後定分」，授時「以中前後分各加時差，爲距午定分」。宣明是食甚時刻，之前皇極等等大概是定朔</n>

<v>儀天</v>有一句很難懂：「置月行去交黃赤道差，視月道差，如黃赤道交者，依其加減；不如黃赤道交者，返其加減；定朔、望小餘爲食甚餘，亦返其加減去交定分。」存之再慮。

【明天觀天紀元】午前後分(明天觀天：食甚，紀元：定餘)

#### 四、氣差

氣差<n>欽天：黃道出入食差，應天、儀天：黃道差，乾元：晷差，明天、授時：南北差</n>

【應天乾元儀天崇天】氣差(定朔距冬至日, 距午分)   <n>應天：朔定積，崇天：朔中積，那就當成定朔，觀天：盈縮限度及分</n>

【宣明觀天】氣差(定朔距冬至日, 午前後分) <n>宣明沒說是定朔還是經朔距冬至，但差別應該不大</n>

【明天紀元授時】食甚距冬至日 = 經朔距冬至日 + 食甚 - 經朔<n>明天：朔加時中日 = 朔中日 + 加時小餘 - 經朔小餘，紀元：食甚入氣 = 經朔入氣 + 食甚 - 經朔</n>

【明天紀元授時】食甚日行積度 = 食甚距冬至日 ± 日改正(食甚) <n>明天：朔加時定日</n>

【明天紀元】氣差(食甚日行積度, 午前後分)

【授時】氣差(食甚日行積度, 距午分)

冬至前後符號：

宣明氣差「秋分後，陰曆減之，陽曆加之。」應天赤道差「盈初縮末內減外加」，乾元離差「秋分後陰減陽加」，紀元氣差「夏至後末限、冬至後初限，〔交初以加，交中以減。〕」崇天「秋分後，交初以加，交中以減」，庚午「秋分後陽曆加陰曆減」。

授時「在縮初盈末者，交前陰曆加陽曆減，交後陰曆減陽曆加」相當於交初交中。大統「縮初盈末，食在正交爲加，中交爲減」

#### 五、刻差

刻差<n>欽天：黃道斜正食差，應天、儀天：赤道差，乾元：離差，明天、授時：東西差</n>

【應天乾元儀天崇天】刻差(定朔距冬至日, 距午分)

【觀天】刻差(定朔距冬至日, 午前後分)

【明天紀元】刻差(食甚日行積度, 午前後分)

【授時】氣差(食甚日行積度, 距午分)

盈曆<n>冬至後</n>符號：

宣明刻差「冬至後食甚在午正前，夏至後食甚在午正後，陰曆以減，陽曆以加。」應天黃道差「入盈，以定分午前內減外加」，儀天黃道差「冬至後，甚在午正東，陰減陽加；甚在午正西，陰加陽減；夏至後卽返此。」紀元刻差符號「冬至後食甚在午前，夏至後食甚在午後：交初以加，交中以減」，崇天「冬至後食甚在午前，夏至後食甚在午後：交初以加，交中以減」，庚午「冬至後午前陽加陰減」。

授時東西差「在盈，中前者，交前陰曆減陽曆加，交後陰曆加陽曆減；中後者，交前陰曆加陽曆減，交後陰曆減陽曆加。」

#### 六、加差

只有宣明、儀天有加差。

符號：宣明「若蝕甚在午正後，則每刻累益其差，陰曆以減，陽曆以加。」

【宣明應天乾元儀天明天紀元授時】食差 = 氣差 ± 刻差 ± 加差<n>明天：食差總數</n> 【崇天觀天】食差 = 氣差 ± 刻差 ± 時差

#### 七、食分

除了【紀元授時】距交分 = 交前後分 ± 食差<n>乾元：定交分，宣明儀天明天：去交定分，崇天觀天：交前後分</n>，判斷是否返入內外道，陰曆食陽曆不食。

【紀元】朔入交定日 = 入交常日 ± 食差 ± k0。望入交定日 = 入交常日 ± 比例*月改正(望入轉)<n>卽乾元儀天的入交定日</n>

【紀元】入陰陽曆(入交定日) 。交前後分(入陰陽曆)

【授時】正交中交限 = 正交中交度 ± 食差。正交度 357.64 = 交終度 - k0<n>6.1534</n>，中交度：188.05 = 交終度/2 + k0<n>6.1533</n>。交前後度(正交中交限, 交定度)。不同的是，食差並不是加在交定度上，而是正交中交度，這樣的話符號就跟唐宋曆完全相反了，復檢術文，符號確與唐宋曆相反。爲統一起見，我把食差、k0 加在入交度上，符號就與授時術文相反。曲安京<v>數理</v>頁 451：根據黃白交點距離常數<n>交終度交中度</n>換算出黃道與視白道的距離<n>正交中交限</n>。

【應天乾元儀天】日食分(距交分, 定餘)

【應天乾元儀天】月食分(距交分)

【欽天崇天明天觀天紀元授時】食分(交前後分，明天：去交定分)

月食旣內外分

#### 八、食延

【應天】定用分(食分, 月實行速)

【乾元】定用分(食分)

【儀天】定用刻(食分, 去交定分)

【崇天明天觀天授時】日食定用分(食分, 月實行速)

【崇天明天觀天】月食定用分(交前後分，明天：去交定分, 月實行速)

【紀元】定用分(交前後分, 食甚入轉損益率)

這是<v>授時</v>月食定用分函數<n>爲便觀看，放大 10 倍</n>：

![](https://pic.imgdb.cn/item/60b9dd918355f7f718517585.jpg)

`f(食分) = sqrt((30 - x)x) * 0.00574 / 1.0962`，極值 `f(15) = 0.0785日`。1.0962 是月亮每限平行度，化爲每日平行度就是我們熟悉的 13.36875，`0.574/1.0962 = 7/13.36875`

以下是各曆定用分的分配，數字的單位是定用刻、定用分。

| 曆法         | 初虧——食甚                       | 食甚——復圓  |
| ------------ | -------------------------------- | ----------- |
| 皇極大衍宣明 | 0.5                              | 0.5         |
| 戊寅         | 0.6                              | 0.4         |
| 麟德         | 0.4                              | 0.6         |
| 五紀正元     | 日食根據食甚時刻確定是0.4還是0.6 | 月食都是0.5 |
| 崇玄以後     | 1                                | 1           |

計算食延一般來說只涉及食分，但也有幾部曆法用到了去交定分：儀天、明天、崇天觀天、紀元。

#### 九、虧蝕所起方位

無關緊要，略

#### 十、帶食出沒

<v>宣明</v>以後有了帶食計算：

> 凡日月帶蝕出沒，各以定法通蝕分，半定用刻約之，以乘見刻。多於半定用刻，出爲進，沒爲退。少於半定用刻，出爲退，沒爲進。各如定法而一，爲見蝕之大分。

說了半天，帶食分其實就是可見食延和真實食延的線性關係，非常簡單。崇玄也是線性關係。<v>欽天</v>在此基礎上加入了距食分的因素，有了些進步。

⋯⋯

### 階段三步交會

#### 大衍

##### 一、

入交定日。初步判斷入食限

##### 二、月食

去交前後分(入交定日)

食分(去交定分)

##### 三、日食

入氣差積(距冬至日)

朔定差及定限(入氣差積)

入陰陽曆

⋯⋯

時差

#### 五紀

<v>五紀</v>、<v>正元</v>是唯一有月食食差的曆法。

<v>五紀</v>跟宣明很像了，是把食差加在去交分上，但是還有交前交後之別，尚不成熟。

一項加在陰曆、類陽曆上的食差：

> 自大寒畢立春，交前五辰外，自大暑畢立冬，交後五辰外，又減一辰。

基於夏至前後對稱，以及覆蓋範圍連續性，我覺得應該改爲「自大寒畢立夏」。

#### 崇玄

<v>崇玄</v>的食差算法非常獨特，曲安京直接一筆帶過，說天文含義不明。我來梳理一下。

> 1、置其朔距天正中氣積度，  
> 2、以減三百六十五度半，餘以千乘，滿三百六十五度半除爲分，曰限心。加二百五十分，爲限首。減二百五十分，爲限尾。滿若不足，加減一千。   
> 3、退蝕定餘一等，   
> 4、與限首尾相近者，相減，餘爲限內外分。   
> 5、其蝕定餘多於限首、少於限尾者，爲外；少於限首、多於限尾者，爲內。

1、「距天正中氣積度」找不到解釋，上文步晷漏的自變量是「二至加時已來至其日昏後夜半日數及餘」，那積度應該指加上了日躔的實行度。

2、「滿若不足，加減一千」，就要用到 mod：

```javascript
C = (365.5 - 積度) / 0.3655 // 限心。舉例: C(182.5)≒49.317872
L = (C - 250 + 1000) % 1000 // 限尾。    L(182.5)=799.317872
R = (C + 250 + 1000) % 1000 // 限首。    R(182.5)=299.317872
```

3、「蝕定餘」是食甚時刻的約餘萬分小數，比如一日的 0.75 就是 7500，再退一等得 750。

4、限內外分的算法：` min(abs(食甚- R), abs(食甚- L))`，這樣就能求得與限首尾相近的了。

5、蝕定餘和限首尾比較，得出限內外。可見限內外是與距冬至積度、食甚時刻有關的二元一次函數。

藍色限首R，綠色限尾L：

<img src="https://pic.imgdb.cn/item/60b9f1008355f7f718a3e0ee.jpg" width='260'>

另外一個關鍵點是，「多於限首、少於限尾者」不應該是同時滿足，而是滿足其中之一卽可，否則很多區間旣不在限內，也不在限外。據此可以作下圖：

<img src="https://pic.imgdb.cn/item/60b9fab48355f7f718337e1a.jpg" width='270'>

與其他曆法的氣差刻差符號不同，<v>崇玄</v>的限內外標準是流動的，沒有固定的午前午後或者冬至後夏至後。

#### 欽天

欽天日食分：

> 以定準加中限，爲陰道定準；減中限，爲陽道定限。不足減者，反減之，爲限外分。視陰道距交分，定準以上，定限以下，爲陰道食；卽置定限，以距交分減之，爲距食分。定準以下，雖曰陰道，亦爲陽道食；卽加陽道定限，爲距食分。其有限外分者，卽減去限外分，爲距食分。不足減者，不食。其陽道距交分，定限以下，爲入定食限；卽用減陽道定限，爲距食分。

很迷惑。我索性這樣改：

> 以定準加中限，爲陰道定<b>限</b>；減中限，爲陽道定<b>準</b>。不足減者，反減之，爲限外分。視陰道距交分，定準以上，定限以下，爲陰道食——卽置定限，以距交分減之，爲距食分。定準以下，雖曰陰道，亦爲陽道食——卽加陽道定<b>準</b>，爲距食分。其有限外分者，卽減去限外分，爲距食分；不足減者，不食。其陽道距交分，定<b>準</b>以下，爲入定食限；卽用減陽道定<b>準</b>，爲距食分。

這樣就非常通暢了。

### 程序可靠性驗證

所有唐宋授時曆法的交食我都按原文梳理了一遍，但問題肯定還有，只能留待以後慢慢考慮。用有實例的交食推步論文來檢驗程序：

#### 大衍

《中國古代曆法》頁 539 有三次推算：

| 日期         | 《中》食分 | 程序食分 | 《中》食甚 | 程序食甚 |
| ------------ | ---------- | -------- | ---------- | -------- |
| 724 七月日食 | 9.49385    | 9.47     |            |          |
| 724 七月月食 | 9.66       | 9.66     | 8235       | 8239     |
| 729 十月日食 | 15         | 15       | 3389       | 3441     |

729 年主要區別是在定朔上，《中》是 3402，程序算得 3457，程序的月亮改正大了一些。

#### 宣明

《中》頁 605 說日本保存大量《宣明》預報資料，估計是說《韓國科學技術史資料大系天文學編》第 2 冊，驪江出版社，1986。還有日本寬永二十一年（1665）宣明曆刻本。

#### 崇天

藤豔輝《崇天曆的日食推步術》算了天聖二年五月丁亥日食，頁 544 說入轉 22 日轉定分 1377，錯了，應該是 1317。原文是 1377，但是很明顯是原文有誤，這樣食延就有錯了。《宋志》：「天聖二年五月丁亥，算食二分半，候之不食。」1.66、1.69 按照第一種標準是一分半強，按第二種標準是一分半，原文當爲一分半。

| 日期            | 藤食分                 | 程序食分 | 藤食甚 | 程序食甚      |
| --------------- | ---------------------- | -------- | ------ | ------------- |
| 1024 五月丁亥   | 1.66                   | 1.69     |        |               |
| 1026 十月癸酉   | 6.4                    | 6.44     | 9:38   | 4019=9:38:44  |
| 1029 八月丁亥   | 9.3                    | 9.33     | 7:06   | 2958=7:05:57  |
| 1040 閏正月丙辰 | 5.2                    | **4.80** | 13:43  | 5721=13:43:49 |
| 1042 六月壬申   | 5.1                    | 5.02     | 18:27  | 7693=18:27:47 |
| 1046 三月辛巳   | 7.2                    | 7.27     | 13:15  | 5527=13:15:53 |
| 1053 十月丙申   | 4.4（估計是5.4輸錯了） | **5.85** | 12:56  | 6386=15:19:35 |
| 1054 四月甲午   | 9.8                    | **9.54** | 16:04  | 6695=16:04:04 |
| 1059 閏正月丙申 | 5.2                    | 5.38     | 12:50  | 5341=12:49:06 |
| 1061 六月壬子   | 9.8                    | 9.83     | 13:41  | 5706=13:41:39 |

食甚時刻全部符合，食分有三個區別比較大，達到 0.4 分，由於文中沒有推算過程，不知道問題出在哪一步。看了下天聖二年五月丁亥的，半晝分相符，那應該不是這個的問題。

#### 紀元

藤豔輝《紀元曆日食算法及精度分析》：

| 日期           | 藤食分 | 程序食分 | 藤食甚  | 程序食甚     |
| -------------- | ------ | -------- | ------- | ------------ |
| 1107十二月壬子 | 8.14   | 8.19     | 14.0922 | 5872=14.0928 |
| 110806         | 3.40   | 不食     | 12.5541 |              |
| 1110九月丙寅   | 1.62   | 1.63     | 16.8216 | 7021=16.8504 |
| 111209         | 1.48   | 不食     | 4.7390  |              |
| 1113三月壬子   | 3.25   | **1.48** | 13.9006 | 5789=13.8936 |
| 1115七月戊辰   | 5.44   | **4.28** | 11.6928 | 4867=11.6808 |
| 1118五月壬午   | 2.32   | **0.27** | 18.4204 | 7671=18.4104 |
| 1119四月丙子   | 6.34   | 6.37     | 18.8275 | 7838=18.8112 |
| 112010         | 8.83   | 不食     | 13.5898 |              |
| 1122二月庚寅   | 7.51   | **6.83** | 13.6496 | 5698=13.6752 |
| 112308         | 9.06   | 不食     | 5.7544  |              |
| 113407         | 1.89   | 不食     | 13.0021 |              |
| 1135正月乙巳   | 9.68   | 9.58     | 10.3419 | 4310=10.344  |

看來還有 bug，沒有特殊情況就相合，有特殊情況就不對了。

## 古人眼中的宇宙

### 渾天說

渾天說就是渾儀的模型，天是一個球，地就不知道是什麼了，渾天說一直這是古曆的天文模型。姜岌<v>三紀甲子元曆</v>已知以月食所沖檢日之所在，這是明明白白的渾儀模型。可參考 [为什么 作为单个个体的某个古人 很早就知道 地球是球体？ - 桃李不言下自成蹊的回答](https://www.zhihu.com/question/263959552/answer/277638716)

不過，古人說的日月運行都是指公轉，但是他們是如何認識地球自轉的呢？

### 月相

<v>宋志十三</v>末尾：「又月之晦明，自昔弗燭厥理，獨揚雄云：「月未望則載魄於西，旣望則終魄於東，其溯於日乎？」京房云：「月有形無光，日照之乃光。」始知月本無光，溯日以爲光。本朝沈括用彈況月，粉塗其半，以象對日之光，正側視之，始盡圓缺之形。」漢人就知道了月光是由太陽照射產生的，沈括模擬出圓缺變化的原理。

> @gm zeng2017-12-18：月食張衡用闇虛<n>不是地球陰影</n>、奪光來解釋，可以認爲並沒有深入思考地球的存在。
>
> @尞祡：是的，古代普遍认为天大地小，但是天并没有比地大太多，太阳月亮则比地小太多，地影会有一个非常诡异的比例。

### 日食的政治意義

以古代的天文水平，不可能精確計算日食這樣複雜的三體運動，所以<u>一行</u><v>大衍曆議</v>說：「使日蝕皆不可以常數求，則無以稽歷數之疎密。若皆可以常數求，則無以知政教之休咎。」一行認爲不能求得的這部分是因爲天意。北宋<v>明天</v>作者<u>周琮</u>說：<q>「今以日行之所盈縮、月行之所遲疾，皆損益之，或進退其日，以爲定朔，則舒亟之度，乃勢數使然，非失政之致也。」</q><q>「日食當朔，月食當望，蓋自然之理。夫日之食，蓋天之垂誡，警悟時政，若道化得中，則變咎爲祥。國家務以至公理天下，不可私移晦朔，宜順天誡。」</q>宋人認識到交食是一種自然現象，並非因爲<q>「失政」</q>，但日食依然是不好的事情，所以每逢日食，君主就要修身理政，以<q>「變咎爲祥」</q>。如果預測不準，那就會讓君主錯過上天的警示。<v>明志一</v>：「十九年三月癸巳朔，臺官言日當食，已而不食。帝喜，以爲天眷，然實由推步之疏也。」

## 現代天文計算

### 任意時刻太陽高度、方位角、晷長

輸入年前冬至時刻<n><n>例如計算 2020 年 12 月 29 日、2021 年 6 月 29 日，均輸入 2020 年 12 月 21 日冬至時刻。可通過廖育棟網站、壽星天文曆、日梭天文曆、中國天文年曆等査詢</n></n>、該日距冬至的整數日數<n><n>冬至當日爲 0</n></n>、想要計算的時刻、地理緯度、影桿的高度<n><n>北京約 39 度</n></n>、公元年。程序自動將距冬至日數轉換爲眞黃經、赤緯。方位角正負：子線或午線以右以東爲負，以左以西爲正，本程序計算出的方位角不大於 90°