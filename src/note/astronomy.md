## 天文計算說明

下爲常用名詞解釋：

-  **歲實** 回歸年。不同時期大約長度：四分曆 365.25，魏晉系 365.246，唐系 365.244— .245，宋系 365.243 — .244，授時 365.2425。
-  **週天** 恆星年，祖沖之<v>大明</v>將歲差引入曆法<n>約 45 年差 1 度，誤差較大</n>，李淳風<v>麟德</v>不用歲差，此後一直沿用<n>大約 70 餘年差 1 度</n>。
-  **月** 一個朔望月<n>一般在 29.53059—29.5306  日之間</n>。日法：朔望月分母，從李淳風<v>麟德</v>開始用總法，所有參數的分母都是日法。
-  **轉**  **曆** 與近點月<n>約 27.5545 日</n>有關，「入轉日」卽在一個近點月中的日數。有 8 部曆法以遠地點<n>月速最慢</n>入轉，其餘都是近地點<n>月速最快</n>入轉。魏晉南北曆法的「曆」指與近點月相關的參數，「曆法」卽近點月長度。
-  **交** 與交點月 <n>約 27.21222 日</n>有關，「入交日」卽在一個交點月中的日數。古曆都以降交點入交，卽「正交」，升交點稱「中交」，兩個交點之間稱「半交」。降交點到升交點，月在黃道南，稱「陽曆」「外道」；升交點到降交點，月在黃道北，稱「陰曆」「內道」，所以看到「陰陽曆」的說法，不要與現在說的陰陽曆混淆了。唐代之前有「交前」「交後」的說法，我目前理解爲「交前」卽交在前，指交點在月亮前方，「交後」卽交在後，指交點在月亮後方。宋元的交前後都是在交點之前，在交點之後。
-  **日躔**  **月離**  指日月運動速度的快慢，後來泛指日月運行。日月都是在近地點最快，遠地點最慢。
-  **赤度**  **黃度** 赤道經度，黃道經度。古代天文模型與現代天文學不同，黃經不是現代意義上的黃經，而是黃道與赤經圈相交得到的黃道度數，可稱爲「極黃經」，同樣，白經其實是「極白經」。
-  **白道** 授時曆開始纔有的說法，此前都直說「月道」，白道是月行九道<n>詳見下</n>中的一個。
-  **內外度** 緯度。黃道內外度卽黃緯，赤道內外度卽赤緯。 **去極度** 象限度 - 內外度 = 去極度，卽到天頂的距離。
-  **昏中星** 太陽落山後約 2.5 刻<n>夜漏開始時刻</n>正南的星宿。
-  「進二位」「進二等」意思是 `× 100`，「退位」指 `/10`。
-  某自變量「反減」「覆減」某限的意思是 `某限 - 自變量`。

## 歲差與歲實消長

### 歲差

現代的歲差常數是 0.014162 度/年。

大衍曆議論歲差：<n><v>新唐志</v>卷二十七上</n>

> 大同九年<n>543</n>，虞𠠎等議：「姜岌、何承天俱以月蝕衝步日所在。承天雖移岌三度，然其冬至亦上岌三日。承天在斗十三四度，而岌在斗十七度。其實非移。祖沖之謂為實差，以推今冬至，日在斗九度<n>瀚案：算得大明543冬至在斗9.213</n>，用求中星不合。自岌至今，將二百年，而冬至在斗十二度。然日之所在難知，驗以中星，則漏刻不定。漢世課昏明中星，為法已淺。今候夜半中星，以求日衝，近於得密。而水有清濁，壺有增減，或積塵所擁，故漏有遲疾。臣等頻夜候中星，而前後相差或至三度。大畧冬至遠不過斗十四度，近不出十度。」又以九年三月十五日夜半，月在房四度蝕。九月十五日夜半，月在昴三度蝕。以其衝計，冬至皆在斗十二度。自姜岌、何承天所測，下及大同，日已却差二度。而淳風以為晉、宋以來三百餘歲，以月蝕衝考之，固在斗十三四度間，非矣。
>
> 劉孝孫甲子元歷，推太初<n>-103</n>冬至在牽牛初，下及晉太元、宋元嘉皆在斗十七度。開皇十四年<n>594</n>，在斗十三度。而劉焯歷仁壽四年<n>605</n>冬至，日在黃道斗十度，於赤道斗十一度也。其後孝孫改從焯法，而仁壽四年冬至，日亦在斗十度。焯卒後，冑玄以其前歷上元起虛五度，推漢太初，猶不及牽牛，乃更起虛七度，故太初在斗二十三度，永平在斗二十一度，並與今歷合。而仁壽四年<n>605</n>，冬至在斗十三度，以驗近事，又不逮其前歷矣。戊寅歷，太初元年辛酉冬至，進及甲子，日在牽牛三度。永平十一年，得戊午冬至，進及辛酉，在斗二十六度。至元嘉，中氣上景初三日，而冬至猶在斗十七度。欲以求合，反更失之。又曲循孝孫之論，而不知孝孫已變從皇極，故為淳風等所駁。歲差之術，由此不行。
>
> ⋯⋯又皇極歷歲差皆自黃道命之，其每歲周分，常當南至之軌，與赤道相較，所減尤多。計黃道差三十六度，赤道差四十餘度，雖每歲遯之，不足為過。然立法之體，宜盡其原，是以開元歷皆自赤道推之，乃以今有術從變黃道。

<v>數</v>頁188：虞𠠎<v>大同</v>公元前 2300 堯時四正昬中：冬至奎 10，春分井 31，夏至房1，秋分女 2。頁 190：<v>大衍</v>到<v>明天</v>以前都是公元前 2300 冬至日赤在虛 1 ，經檢驗，我的赤度昬中算對了。

### 歲實消長

《統天》發明歲實消長，《授時》繼之。《統天》百年減 2.1167 分，比實際高了 35 倍，授時百年減 1 分，比實際高了 16 倍，這樣三百年下來就有很大的誤差了，我暫時把授時調低 15 倍，等有需要的時候再改回原曆的値。

## 躔離

### 槩念、符號

太陽運動很簡單，週期項影響不大，用一次傅立葉函數就能比較準確地擬合，但有一個問題是，基本上所有的古曆都以冬至爲近日點<n>日速最快</n>，實際上並不是這麼回事，在 1250 年左右纔是正好以冬至爲近日點，往前往後誤差都會越來越大，只有<v>儀天曆</v>對日躔表有意識地做出了修正。月亮運動相當複雜，週期項非常多，而古曆都僅僅以一個近點月爲週期，我們只能用非常粗糙的近似修正來模擬古曆模型，這也是一個一次傅立葉函數。

表格各欄依次爲：

- 日盈縮積，距冬至日數這麼多天，太陽實際上走了多少度
- 月遲疾積，入近點月這麼多天，月亮實際走了多少度
- `日行改正 = 日盈縮積 / (月實行速-日實行速)`
- `月行改正 = -月遲疾積 / (月實行速-日實行速)`

`平朔 + 日行改正 + 月行改正 = 定朔`，`平氣 - 日盈縮積 = 定氣`，`入交定分 = 入交泛分 + 太陽改正 + 0.078507*月亮改正`。

自<v>乾象</v>始有月行遲疾，自<v>大業</v>始有日行盈縮，月離表、日躔表卽用來記錄每日、每氣的日月實行情況。表格的數據是離散的，所以要用內插法來計算特定時刻的日月實行。自<v>乾象</v>到<v>大業</v>、<v>戊寅</v>皆用線性內插，<v>皇極</v>始用二次差內插，到<v>授時</v>用三次公式。

- <v>隋志中</v>說張賔<v>開皇</v><q>「減朓就朒」</q>，我猜<q>「朓朒」「朏朒」</q>一詞就是張賔開始用的，隨後劉焯<v>皇極</v>沿用，成爲盈縮積的替代說法。晦而月見西方謂之朓，朔而月見東方謂之朒。

古代沒有負數運算的槩念，所以遇到負數都要轉換爲正數，朓朒的正負問題詳見張培瑜等<v>中國古代曆法</v>470 頁。但是要區別對待不同曆法的正負問題非常麻煩，所以我程序中所有曆法的正負都是這樣的：

<img src="https://pic.imgdb.cn/item/60950477d1a9ae528f3cfb1c.jpg">

依次爲：盈縮積、實行速、損益率、列差<n>圖很不精確，只是意思意思</n>。

另外，「四七日」指的是近點月中 6.8886、13.7772、20.6656、27.5545 這四個七日（向上取整），這四點是轉折點，當日損益率需要分段處理（《皇極》、《欽天》處理爲 6 8/9, 13 7/9, 20 6/9, 27 5/9）。有個標點本斷爲「四、七日」，哈哈。

另外，平朔一般稱「經朔」，《欽天》稱「常朔」，《庚午》稱「中朔」。

### 分母

精確的日月改正算法是：(日盈縮積 - 月朓朒積) / (月實行速 - 日實行速) 。這其實是一個簡單的 `t = v / s` 問題，不用考慮符號正負。古曆日月改正的算法可以統一爲這樣<n>加〔六角括號〕的是不同曆法或有或無</n>：

1. 日盈縮積或月朓朒積 = 整日朓朒積 + 該日損益率 * 比例
2. 月實行速 = 整日月實行速 + 〔列差*比例〕
3. 改正數 = (〔日盈縮積〕- 月朓朒積) / (月實行速<n>或月平行速</n> - 〔日平行速〕)

理想的分母是 `月實行速 - 日實行速`，但是不同時期的曆法所選分母各不相同，魏晉曆法基本上是 `月實行速-日平行速`，北系是 `月平行速`，大業是 `月實行-日平行`，隋唐宋系反而退步，都是 `月平行`，授時曆 `月實行`。<n>另可見<v>中國古代曆法</v>第434頁</n>

後來突然想到，之所以分母要用 `月平行速`，而不用 `月平行-日平行`，是因為古曆太陽改正都比實際偏大許多，分母更大的話能夠抵消一部分誤差。各曆太陽朏朒極值：麟德 2.767，大衍降到 2.42，此後一直在 2.4—2.42 之間，南宋後期會元達到最低的 2.3，後來三部南宋曆是 2.36，授時又返回 2.4，而實際上只有 1.98。若用這樣的比例抵銷，`2.14 * 12.36875/13.36875 = 1.98`，最常見的 2.4 等於 2.22。所以看起來唐以後相比魏晉退步了，但實際效果應該相差不多。

### 線性還是二次？

《崇天》日躔：

> 求經朔弦望入氣朏朒定數：各以所入氣小餘乘其日損益率，如樞法而一，即得。

明確說「其日」，則是二次插值。每部曆法都會根據日躔術和二十四節氣表編製全年每日的立成表，這就是「其日」的意思，在具體編製每年曆書時只用査立成表進行線性內差卽可（這是我猜的），但曆志中無一保存了唐宋曆的立成表，只能自己根據日躔術來寫程序。各曆二次插值具體形式有所不同。對於《皇極》二次公式，劉鈍（《皇極曆中等間距二次插值方法術文釋義及其物理意義》）、曲安京（《曆法》頁 240）有不同理解。原文「前少者⋯⋯乃別差加之」，劉鈍改爲「半別差減之」，而「前多者，卽以總差加末率」，劉鈍補上「半別差減之」；曲安京則完全未改動原文，指出這是《皇極》的失誤之處。結合《皇極》其他三種二次插值術（求月朔弦望應平會日所入遲速、推朔弦望定日術、求月入交去日道）來看，劉鈍校改之後的纔是術文原貌。對於崇玄，曲安京說原文是「日差」，但可能是「半日差」之誤。王榮彬認為儀天、崇玄完全一致（王榮彬《中國古代曆法的中心差算式之造術原理》），而崇玄又與崇天完全一致（曲安京《曆法》頁 241）。以上觀之，日躔等間距二次差公式有這四種形式：

符號：`Δ1` 爲本氣升降分、損益率，`Δ2` 爲後氣升降分、損益率，`(Δ1-Δ2) / n` 是總差、合差、差率，`(Δ1 - Δ2) / n^2` 是別差、日差。

1. 麟德：氣初日消息數 `(Δ1+Δ2)/2n + (Δ1-Δ2)/n`
2. 皇極：氣初日遲速數 `(Δ1+Δ2)/2n + (Δ1-Δ2)/n -(Δ1-Δ2)/2n^2`
3. 應天乾元：氣初日盈縮分 `Δ1/n + (Δ1-Δ2)/2n`
4. 崇玄儀天崇天以後：`Δ1/n + (Δ1-Δ2)/2n - (Δ1-Δ2)/2n^2` 

其中 1、3 等價，2、4 等價，在 1、3 的基礎上考慮半日差卽爲 2、4。經驗算，算法 4 與招差術結果相等，可以用招差術替代日躔術；對於算法 1、3，只能另外單獨編寫程序。

《儀天》採用公式進行計算，其公式是完全精確的（王榮彬《中國古代曆法的中心差算式之造術原理》），所以理論上來講可以用《儀天》公式來代替其他各曆的表格，只需修改系數即可。《儀天》象限採用定氣，卽 88.9、93.7 兩種，盈縮積、朏朒積在二分 88.9 日達到極值；而表格法宋曆都用的平氣，在 91.3 日達到極值，我把象限統一爲 91.3 日。以《紀元》爲例驗算，公式算法與表格算法存在不可忽視的差別，看來並不能用公式代替表格，只能用招差術。這是表格各氣二次差不同造成的，《儀天》公式默認的前提是一象限中各氣二次差相等。

至於不等間距內插的曆法，經驗算，《大衍》、《宣明》公式與拉格朗日內插等價，所以程序中直接調用拉格朗日內插。

再看月離表的算法。<v>皇極</v>一直到<v>崇玄</v>，月亮改正都用等間距二次內插，並且都進行了第二遍修正，交食用二次內插，注曆用線性內插。但是第二遍修正太難了（《中》皇極、大衍相關部分寫了第二遍修正的算法），我暫時忽略，只用招差術進行第一遍二次修正。到了宋曆，月離全都僅僅是線性內插，一下簡單不少，如《崇天》：

> 求朔弦望入轉朏朒定數：置所入轉餘，乘其日損益率，樞法而一，所得，以損益其下朏朒積為定數。其四七日下余如初數下，以初率乘之，初數而一，以損益朏朒為定數。

宋曆無一採用二次內插進行月離改正。

此前我一直把《皇極》以後的定朔躔離改正分為二次和一次，二次改正=二次日躔+二次月離，一次改正=一次日躔+一次月離。經過以上梳理，眉目終於清楚了：

- <b>唐曆</b>交食：二次改正 = 二次日躔 + 二次月離。定朔：一次改正 = 二次日躔 + 一次月離
- <b>宋曆</b>交食、定朔：二次改正 = 二次日躔 + 一次月離
- <b>授時</b>交食、定朔：三次改正 = 三次日躔 + 三次月離

### 欽天步月

《授時》編製曆書時用立成表來線性內插，立成是用三次內插函數編製的，一近點月分 336 限，所以可以用線性來代替三次內插。程序直接用公式計算，方便快捷，省去錄入立成之苦。《授時》月離立成大槩受到五代<u>王樸</u>《欽天》的啓發，《欽天》月行析爲 248 限，用二次內插編製立成，用立成取代以往的每日月離表，編製曆書時直接用線性內差。可惜《欽天》躔離表沒有流傳下來，我只好將五紀、紀元月離表平均，用二次招差術歸算爲 248 限立成，進行線性內插。

上文說過月離朓朒的計算，在唐代，只有交食用二次內插，一般注曆用線性內插，到宋代，乾脆交食也只用線性內差了。<u>王樸</u>批評道：

> 自古朓朒之法，率皆平行之數；入曆旣有前次，而又衰稍不倫。降及諸曆，則疎遠而多失。

「衰稍不倫」大概指線性內差誤差很大。248 限的好處是省去「《皇極》舊術，則迂迴而難用」的計算之煩，又能夠非常接近二次內插的效果，達到「衰稍有倫」的理想狀態。《欽天》的算法爲曆法史上的唯一，「今以月離朓朒，隨曆校定，日躔朓朒，臨用加減。」先計算日躔朓朒，加在經朔入轉上，得「入離定日」，再來計算月離朓朒。這樣從理論上來講比直接用經朔入轉準確，卽「入曆旣有前次」，不明白的是為什麼後世不延用。《欽天》近點月分 248 限，程節 800，算來 `248 * 800 = 198400` ，和轉分 `198393.09` 差一些，但這點誤差落在了小數點後 5 位，不會造成任何影響。

### 授時步月離

這是《授時》的月遲疾積度（唐宋稱朓朒）函數 `f(限) = (11.11限 - 0.0281限^2 -0.000325限^3)/100`：

![](https://pic.imgdb.cn/item/60b86a638355f7f718e6e4f1.jpg)

月亮改正在四個象限都是對稱的，《授時》近點月 27.5546 日分 336 限，每限 0.082，一象限爲 6.888625 日 84 象限，取該函數 0—84 的這一段。從圖像可知該函數極值 `f(81.748) = 5.429`，所以在 81.748—84 之間還有一點塌陷。朓朒極值 `5.429度 / 13.36875度每日 = 0.4061日`

又想到，之所以宋代只有《明天》用公式計算月離，其他都用表格，因為遲疾差積在轉折點附近有比較大的停留，而二次函數不能擬合這種停留。直到《授時》發明三次內插，纔能完美替代表格。太陽盈縮差積的停留不那麼明顯，用二次函數就能比較好地擬合，與三次函數的誤差不會太大，所以宋代《儀天》、《明天》、《觀天》都用公式代替表格。《紀元》爲了追求精確，又回到表格的老路上。

## 日軌

### 黃赤轉換

古代天文模型是以赤道爲基準，所謂「赤道者，常道也，其數常定，紘帶天中，儀極攸準」，太陽的黃道度要根據赤道轉換而來。只有<v>授時</v>求出來的直接就是黃道度，反而需要將黃度轉爲赤度。

度數從冬至起算，二至到二分：赤大於黃；二分到二至：黃大於赤。只有<v>紀元</v>有黃轉赤公式，其餘只能赤轉黃，我用與<v>紀元</v>相同的求反函數思路，復原出各宋系曆法的黃轉赤公式。最後一欄的赤緯是直接根據赤道度或黃道度算出來的，下面的赤緯是根據距離冬至日數算出來的，要考慮日躔，而表格法曆法在製表時已經考慮了日躔，所以此處不能加上表格法曆法的赤緯。小數點後 4 位的精度是 0.36”

> 宋代的姚瞬辅。他在编订《纪元历》时，利用求根公式给出了二次函数的反函数，将唐代边岗的双二次函数改造成了一套漂亮的二次复合函数，这个大体上等价于对三角函数用泰勒级数展开以后的前4次项结果。在误差上，当角度大于40度时，他的算法的精度比泰勒级数还要好。

### 會圓術

輸入圓的半徑 r、弓形的高「矢」h、週天度。會圓術求法：半弦長 <code>c = sqrt (r^2 - (r-h)^2)</code>。尤其需要注意的是，會圓術的標準是週天度 365.25，直徑 121.75，卽「週三徑一」，這個單位系是以 3 爲標準，而非圓周率 π<n>鄧可卉<v>授時曆中的弧矢割圓術再探</v>，<v>自然科學史研究</v>2007(2)</n>，所以在與三角函數對照時，需要進行參照系轉換，詳見源代碼。可以發現，弧-矢之間的轉換誤差大約在 1 度以內，而弦長誤差多達 5 度餘，這是單位系不同造成的。在弧矢割圓術中，以弧作爲入口，用會圓術轉換爲弦長，最後再以弧作爲出口，將弦長轉換爲弧長，單獨來看，弦長的誤差相當大，但是在同一個單位系之中，這是自洽的。

傅宗<v>隙積術和會圓術</v>：

<img src="https://pic.imgdb.cn/item/609533e4d1a9ae528fb89250.png" width='800'>

### 弧矢割圓術

<img src="https://pic.imgdb.cn/item/60953023d1a9ae528f948bb3.png" width='270'>

圖<n><v>中國古代曆法</v>頁 627</n>中 AOE 是赤道，AOD 是黃道，BD 是已知的黃道度，求 CE 長<n>卽赤道度</n>、BC 長<n>赤緯</n>。

<v>授時</v>用弧矢割圓術進行太陽黃赤轉換。<v>授時</v>黃赤轉換用幾何模型，此前的曆法都是經驗公式。由於會圓術的誤差，弧矢割圓術的誤差甚至比<v>紀元</v>的經驗公式還略差。弧矢割圓術是近似三角形、勾股定理、會圓術的組合，前兩者都是精確公式，只有會圓術是近似公式，那麼從理論上來講，如果用三角函數代替會圓術，就能得到和球面三角完全一致的結果，實際上也是這樣的。

授時只有黃度轉赤度的方法，我另外推導出了赤度轉黃度的方法：從 C 向上作垂線，與 OB 相較於點 T，T 超出了球體。從 P 向上作垂線，交 OD 於 Q。有了這兩條輔助線，就可以從赤轉黃了。

此處與上面授時黃赤轉換的區別是這裏可以隨意輸入黃赤交角。第一行「球面三角」是球面三角黃赤轉換的公式，第二行「三角割圓」是用三角函數代替會圓術的弧矢割圓術。弧矢割圓術在黃赤度數和黃赤交角在 45—50 度附近誤差達到最大，約 0.4 度。

### 三斜求積術

輸入三角形三邊邊長，求面積。秦九韶三斜求積術與希倫公式等價。

### 積度轉宿度

先秦時期的赤道宿度已不可俱考，但是出土材料能提供很多線索。到太初改曆，赤道宿度就固定下來了：

```javascript
    [12, '角'], // 1 東宮 總75
    [9, '亢'], // 2
    [15, '氐'], // 3
    [5, '房'], // 4
    [5, '心'], // 5
    [18, '尾'], // 6
    [11, '箕'], // 7
    [26, '斗'], // 8 北宮 總98
    [8, '牛'], // 9
    [12, '女'], // 10
    [10, '虛'], // 11
    [17, '危'], // 12
    [16, '室'], // 13
    [9, '壁'], // 14
    [16, '奎'], // 15 西宮 總80
    [12, '婁'], // 16
    [14, '胃'], // 17
    [11, '昴'], // 18
    [16, '畢'], // 19
    [2, '觜'], // 20
    [9, '參'], // 21
    [33, '井'], // 22 南宮 總112
    [4, '鬼'], // 23
    [15, '柳'], // 24
    [7, '星'], // 25
    [18, '張'], // 26
    [18, '翼'], // 27
    [17, '軫'], // 28
```

<v>太初</v>的赤度一直沿用到唐初。<v>大衍</v>重新制定了一份赤度表：

```javascript
    [12, '角'], // 1 東蒼龍
    [9, '亢'], // 2
    [15, '氐'], // 3
    [5, '房'], // 4
    [5, '心'], // 5
    [18, '尾'], // 6
    [11, '箕'], // 7
    [26, '斗'], // 8 北玄武
    [8, '牛'], // 9
    [12, '女'], // 10
    [10, '虛'], // 11
    [17, '危'], // 12
    [16, '室'], // 13
    [9, '壁'], // 14
    [16, '奎'], // 15 西白虎
    [12, '婁'], // 16
    [14, '胃'], // 17
    [11, '昴'], // 18
    [17, '畢'], // 19
    [1, '觜'], // 20
    [10, '參'], // 21
    [33, '井'], // 22 南朱雀
    [3, '鬼'], // 23
    [15, '柳'], // 24
    [7, '星'], // 25
    [18, '張'], // 26
    [18, '翼'], // 27
    [17, '軫'], // 28
```

改動主要在西方。<v>大衍</v>的赤度表一直沿用到宋代。<v>明天</v>重新定出一份赤道宿度表：

> 自漢太初後至唐開元治曆之初，凡八百年間，悉無更易。今雖測驗與舊不同，亦歲月未久。新曆兩備其數，如淳風從舊之意。

以從舊之誼，<v>明天</v>還是沿用<v>大衍</v>的赤度表。直到北宋最後一部曆法<v>紀元</v>又做出調整：

```javascript
    [12, '角'], // 1 東蒼龍
    [9.25, '亢'], // 2
    [16, '氐'], // 3
    [5.75, '房'], // 4
    [6.25, '心'], // 5
    [19.25, '尾'], // 6
    [10.5, '箕'], // 7
    [25, '斗'], // 8 北玄武
    [7.25, '牛'], // 9
    [11.25, '女'], // 10
    [9, '虛'], // 11
    [15.5, '危'], // 12
    [17, '室'], // 13
    [8.75, '壁'], // 14
    [16.5, '奎'], // 15 西白虎
    [12, '婁'], // 16
    [15, '胃'], // 17
    [11.25, '昴'], // 18
    [17.25, '畢'], // 19
    [0.5, '觜'], // 20
    [10.5, '參'], // 21
    [33.25, '井'], // 22 南朱雀
    [2.5, '鬼'], // 23
    [13.75, '柳'], // 24
    [6.75, '星'], // 25
    [17.25, '張'], // 26
    [18.75, '翼'], // 27
    [17, '軫'], // 28
```

就這樣用了一百多年。直到<v>授時</v>給出了新的觀測結果：

```javascript
    [12.1, '角'], // 1 東蒼龍
    [9.2, '亢'], // 2
    [16.3, '氐'], // 3
    [5.6, '房'], // 4
    [6.5, '心'], // 5
    [19.1, '尾'], // 6
    [10.4, '箕'], // 7
    [25.2, '斗'], // 8 北玄武
    [7.2, '牛'], // 9
    [11.35, '女'], // 10
    [8.7, '虛'], // 11
    [15.4, '危'], // 12
    [17.1, '室'], // 13
    [8.6, '壁'], // 14
    [16.6, '奎'], // 15 西白虎
    [11.8, '婁'], // 16
    [15.6, '胃'], // 17
    [11.3, '昴'], // 18
    [17.4, '畢'], // 19
    [0.05, '觜'], // 20
    [10.1, '參'], // 21
    [33.3, '井'], // 22 南朱雀
    [2.2, '鬼'], // 23
    [13.3, '柳'], // 24
    [6.3, '星'], // 25
    [17.25, '張'], // 26
    [18.75, '翼'], // 27
    [17.3, '軫'], // 28
```

<v>紀元</v>觀測精度已達到了 0.05 度。如果單從數字改變幅度來看的話，影響最深的是<v>太初</v>和<v>紀元</v>的赤度表。

而黃道觀測結果就更迭得頻繁得多，想看具體情況，可以看我的源代碼。

這個工具提供了各曆的宿度轉換，需要根據年代選用當時的曆法：<v>太初</v>前 104 — <v>麟德</v>665— <v>大衍</v>729 —<v>應天</v>964—<v>明天</v>1065—<v>紀元</v>1106 或<v>重修大明</v>1180—<v>授時</v>1281 

#### 斗分

「斗分」是什麼意思呢？歲實<n>回歸年長度</n>= 365 + 斗分 / 度法<n>當然，不同曆法有不同的名字</n>。<v>黃初</v>作者韓詡認爲<v>乾象</v>「減斗分太過，後當先天」，大槪就是比較早的出現「斗分」一詞的材料了。爲何要叫「斗分」？中國古代一週的度數是歲實，所以每部曆法都有各自的圓周度數，而我們看<v>太初</v>的赤度表，發現其中都是整數，沒有小數，這是怎麼回事？一般而言，小數點要加到斗宿的後面，所以叫 <b>斗分</b> ，曆法術語表述爲「經斗去分」。到了祖沖之將歲差引入曆法後，各曆上元日所在赤度一般在虛，所以小數點加在虛宿後面，卽「經虛去分」。因此唐代以後，「斗分」一詞就不再用了，否則就要叫「虛分」了。

#### 備忘

- <v>皇極</v>日所在宿度直接是黃道度。「劉焯歷仁壽四年<n>605</n>冬至，日在黃道斗十度，於赤道斗十一度也。」我算出來是斗 13，奇怪。

#### 黃道過宮

以後補充。直到時憲曆，宮纔固定是十二中氣，此前都沒有對應起來。

## 步晷漏

假設 1 尺 = 20 cm，小數點後 4 位是精度就是 20μm。日出時刻 = 夜半漏 + 2.5 刻<n>一日百刻。</n>球面三角的日出、晷長有兩行，上行計入蒙氣差、日視半徑等修正因素，作爲誤差 1 標準，下行未加入修正，作爲誤差 2 標準。陳美東<v>中國古代太陽視赤緯計算方法</v>：各曆法赤緯誤差<n>度</n>：四分 0.7，麟德 0.13，大衍 0.06，宣明、儀天 0.45，崇玄 0.09，崇天 0.23、明天 0.2，觀天 0.21，紀元、授時 0.11。各曆漏刻誤差<n>分鐘</n>：授時 0.7、乾元、紀元、重修大明、庚午 3.8，四分、景初、元嘉 4.4，崇玄 4.6，大明 4.7，皇極 5.6，大業戊寅 6.1，麟德 4.6，明天、觀天 4.9，大衍 5.1，崇天 6.2，宣明 7.7，儀天 7.9。

藤豔輝<v>紀元曆日食算法及精度分析</v>距離冬至 31.816049 日，紀元日出 2126.2566/7290 = 29.1667572，我之前是直接用黃經，是 29.227518，差了 1 天多，改用距冬至日數，加上日躔，29.1664，只有 0.08 秒的區別。所以其他計算也應該要加上日躔。

### 觀測地點

各曆觀測地點及緯度<n>北極出地高度</n>，現代採用 360°，曆測採用古度：

- 四分、景初、元嘉、大明。洛陽34.6667<n>現代</n>
- 皇極、大業、戊寅、麟德、宣明：長安34.2833，
- 大衍、宣明、崇玄、應天、儀天、崇天：陽城34.4047<n>現代</n>，34.475<n>大衍宣明曆測</n>
- 欽天：岳臺 34.9<n>曆測</n>
- 乾元、明天、觀天、紀元、重修大明、庚午：俊儀34.8125<n>現代</n>34.8<n>麟德曆測「唐貞觀初，李淳風於浚儀縣古岳臺測北極出地高三十四度八分」</n>
- 授時：大都39.9500<n>現代</n>40.95<n>曆測</n>

我暫時沒找到各曆對地理緯度的確切記載，以後要補上。

### 晝漏夜漏

晝夜的槩念也很迷惑。大部分曆法的昏明時長是 2.5 刻，`晝漏 = 日出至日入 + 2*昏明`，`夜漏 = 日至日出 - 2*昏明`，`夜半漏 = 夜漏 / 2`。各曆名詞各有不同。

- 「晨初餘數」是唐曆的槩念，在數據庫搜只有<v>唐志</v>有。`晨初餘數 = 日出 - 昏明`，只是單位換成了日法，因爲這時天矇矇亮，晨剛開始，所以叫晨初。
- <v>宣明</v>：`昏明小餘 = 夜半定漏`
- <v>欽天</v>晝夜分以日入日出爲界：`晝分 = 日入 - 日出`，`夜分 = 1 - 晝分`，單位是日法。
- 應天、乾元 `晨半分 = 日出 - 昏明`，`昏分 = 1 - 晨分`，`晝半分 = 日出`，`夜分 = 1 - 晝分`

大體而言，看到「晨昏」二字，就是日出日入加減了昬明 2.5 刻的，看到「晝夜」二字，就是日出日入。

## 月亮位置

<img src="https://pic.imgdb.cn/item/609a3a5dd1a9ae528f07863c.png" width='250'>

黃赤白道示意圖<n><v>數</v>頁 347</n>

需要輸入此刻入降交點<n>正交</n>交點月的日數、距離冬至的日數。距離冬至日數會加上日躔、轉換爲黃道度，再進行接下來的計算。正交至半交：白大於黃，半交至正交：黃大於白。一交點月約 27.21222 日。<v>大衍</v>月黃緯表用到了三次內插，前半段<code>Δ = 171, -24, -8</code>後半段<code>Δ = -75, -40, 8</code>。<v>宋曆</v>第一行赤道度以九道術求得，第二行以黃赤轉換公式求得；<v>授時</v>赤道度則直接以弧矢割圓術求得。赤白差一欄，除了紀元，都是赤道-白道，紀元較爲特殊，日月同名：赤白差=黃赤差+黃白差，異名：赤白差=黃赤差-黃白差

### 月行九道

<v>大衍</v>開始有月行九道法，以步黃道月道之差<n>四季爲節氣，而非月份</n>：

```
   | 春  夏  秋  冬 
------------------
陽 | 朱  靑  黑  白   
陰 | 黑  白  朱  靑
```

再加上與黃道交會，一共就是九道。<v>崇天曆</v>：

> 推月行九道：凡合朔所交，冬在陰曆，夏在陽曆，月行靑道；<n>冬、夏至後，靑道半交在春分之宿，當黃道東；立冬、立夏後，靑道半交在立春之宿，當黃道東南：至所衝之宿亦如之。</n>冬在陽曆，夏在陰曆，月行白道；<n>冬、夏至後，白道半交在秋分之宿，當黃道西；立冬、立夏後，白道半交在立秋之宿，當黃道西北：至所衝之宿亦如之。</n>春在陽曆，秋在陰曆，月行朱道；<n>春、秋分後，朱道半交在夏至之宿，當黃道南；立春、立秋後，朱道半交在立夏之宿，當黃道西南：至所衝之宿亦如之。</n>春在陰曆，秋在陽曆，月行黑道。<n>春、秋分後，黑道半交在冬至之宿，當黃道北；立春、立秋後，黑道半交在立冬之宿，當黃道東北：至所衝之宿亦如之。</n>

九道術前身是<u>劉洪</u><v>乾象</v>月行三道術，只有陰陽黃三道。漢代也有九道術，但是跟唐宋九道術沒什麼關係，漢代九道用來推算月行遲疾。<n><v>數</v>頁 336</n><u>陳久金</u>的示意圖：

<img src="https://pic.imgdb.cn/item/6095052ad1a9ae528f424d26.png" width='500'>

<v>數</v>頁 341：

<img src="https://pic.imgdb.cn/item/6099f0f8d1a9ae528f5344bb.jpg" width='650'>

## 交食

### 日食表格說明

<v>大業</v>、<v>戊寅</v>、<v>皇極</v>、<v>麟德</v>要根據月份來判斷，這裏爲了簡化輸入，我改爲用節氣判斷季節，這不準確。入交日在正交、半交附近發生交食，交點月的一半約爲 13.6061。

漢代以前，只能根據交食週期確定是否有可能出現日月食。魏晉時期，可以計算食分多少，判斷交食程度。到<v>大業</v>，開始考慮視差的影響。古代判斷交食都是用黃白經差，沒有用月黃緯輔助判斷。

### 參數、槩念

#### 交點月

我的獨創發明：<code>Node = Lunar * EcliRange / (0.5 + EcliRange)</code>，以<v>皇極</v>驗之，可見<v>皇極</v>之交點月正以此公式化之。<v>大明</v>以前無交點月，只有交食週期，我藉此全部統一爲用交點月進行計算，非常方便。可輸入小數或分數，算出來的小數可通過「同餘」標籤中的「連分數」化爲漸進分數。

#### 交點退行速度

交點退行速度用此公式計算： `Sidereal = (V月 + V退) * Node`《明天》步交會中的「朔差」表示一個朔望月交點退行距離（藤豔輝《宋代朔閏》頁 95）。再把月平行速 `V月 = Sidereal/Lunar + 1` 公式代入，得 `V退 = Sidereal/Node - Sidereal/Lunar - 1`，我們可以用這個公式計算任意曆法的交點退行速度。

#### 交率交數

入交定日、去交定日指日月從黃白交點運動到定朔望的時間（黃經差）。由於日月速度不同，月亮從正交運動到平朔望時刻的時間與太陽不同。`入交定日 = 入交泛日 + 日改正 ± 交率/交數 * 月改正`

`交率/交數 = 交點月/交點年 = (恆星月-V退) / (恆星年-V退) = (V日+V退) / (V月+V退) 27.2122/346.608 ≒ 0.0785` （見劉金沂《隋唐曆法中入交定日術的幾何解釋》，《自然科學史研究》1983(4)）

經過驗證，這個公式食完全可靠的，我們用上面的工具計算一下幾部曆法：

- 《紀元》交率/交數 324 / 4127 = 0.07850739，精確値爲 7323715785246679/93286970952593250 = 0.078507381，精確到了小數點後 7 位，非常棒。通過「同餘」標籤下的連分數計算，可見紀元交率是精確值的一個漸進分數。
- 《觀天》 183 / 2331 = 0.07850708，精確值爲 3271955768163223/41677024412605020 = 0.078507422597416，精確到了小數點後 6 位。
- 《重修大明》10/127 = 0.07874，精確值 4098461650124679/52204833831588280 = 0.0785073，有些出入。
- 《欽天》 72 / 963 = 0.0747664，精確值 5214687527858525/66791617777516270 = 0.078074，相差有點遠，計算漸進分數，沒有和 72 / 963 接近的，所以應該不是傳鈔錯誤。

#### 食限

《宣明》、《應天》、《乾元》、《儀天》陽曆食限 4.2 度左右，陰曆 9.6 度，《崇天》、《觀天》陽 5.3，陰 8.84，《紀元》陽 4.88，陰 9.76，《授時》陽 6，陰 8。

#### 食差

食差是對視差影響的修正，只與月亮天頂距有關，與午正前後無關，古曆卻將此作爲正負判斷依據，完全不對，只能正誤參半。

#### 時差

古曆日食時差是基於定朔時刻 `r` 的一元函數，`R = | 0.5 - r |`，則 `時差 = kR(0.5 - R)`。但理論上還應該考慮太陽黃經，如果授時曆加上一個黃經的線性函數，就能很好地與理論曲線脗合。

### 唐宋授時步交會

本文是一個提綱，主要目的是明晰各曆槩念的區別、各算法的自變量，這是最要命的。相關論文也有，但是看得不明不白，只好自己根據宋志原文重新理一遍。

爲節省篇幅，「入交」表示加時入交日及餘分（或餘秒）。日月改正包含以距離爲單位的先後積和以時間爲單位的朏朒積，我統一稱爲日月改正，讀者需加以區分（凡言積度，則爲先後積；凡言入交，則爲朏朒積）。需要注意各名詞的細微區別，可能一字之差就完全不同。`月改正(定朔入轉)` 表示以定朔入轉爲自變量的月改正，`午前後分(定餘)` 表示午前後分以定餘爲自變量。「朔」指「朔望」。比例指 `交率/交數 ≒ 0.0785`，各曆比例不同。日月改正爲太陽改正、月亮改正相加減。

南宋各曆全同紀元；遼金系和紀元很像，除了單獨說明的，其他基本上都是紀元。

距冬至日 = 崇天：中積 = 明天：中日

宣明去交度乘數十一，除數七千三百三 `8400 * 11/7303 = 12.6523`

崇玄去交度乘數十一，除數八千六百三十二 `13500 * 11/8632 = 17.203429`

#### 〇、布算

《大統》：「定朔小餘在日出前日入後二十分已上者，日食在夜；定望小餘在日入前日出後八刻二十分已上者，月食在晝——皆不必布算。」不知道「日入後二十分」中間是不是漏了幾刻。

#### 一、入交

「定朔入轉」的概念也困擾我很久，終於在《授時》找到解釋：

> 置經朔弦望入轉日及分，以定朔弦望加減差加減之，為定朔弦望加時入轉；以定朔弦望日下分減之，為夜半入轉。

《大統》：

> 置經朔弦望遲疾曆，以定朔弦望加減差加減之。在疾曆，便為定朔弦望加時入轉日；在遲曆，用加轉中。置定朔弦望加時入轉日，以定朔弦望小餘減之，為夜半入轉日。

所以定朔入轉 = 經朔入轉 ± 日月改正。

天正經朔入交（應天：中盈度，乾元：平交朔日）

經朔夜半入交 = 經朔入交 - 小餘。

定朔夜半入交：整數日有進退的，加減一日，否則因經為定（只有夜半是這樣，如果加時，就要相應加減了）。

明天求去交度分的算法很獨特，`交初度 = Sidereal - 積月 * 朔差 % Sidereal`，翻譯過來，就是上元以來交點退行的距離，再反減。這樣得到的是正交距冬至度數，另外再根據太陽距冬至度數，得出交前後分。

#### 二、入陰陽曆（紀元除外）

朔入交常日 = 經朔入交 ± 日改正（應天：朔交初度分，乾元：朔交分）

<b>欽天乾元儀天崇天觀天遼金</b>朔入交定日 = 朔入交常日 ± 比例 × 月改正（乾元：度定分）

入陰陽曆()：

- <b>應天</b>朔入交常日 ± 月改正（卽紀元的定朔入交泛日。很奇怪，不確定是不是這樣）
- <b>欽天乾元儀天崇天觀天遼金</b>朔入交定日

交前後分(入陰陽曆)

<b>紀元</b>食甚泛餘 = 經朔 ± 日月改正(朔入氣入轉) * 損益率(定朔入轉) （「朔入氣入轉」我暫時處理為平朔）

<b>遼金</b>遼金系和紀元很像，除了直接以入交定日入陰陽曆，以及這條：食甚泛餘 = 經朔 ± 日月改正(朔入氣入轉) * 1337 / 轉定分(定朔入轉)

不論陰陽，近交初為交初，在二十六日、二十七日為交初；近交中為交中，在十三日、十四日為交中。交初交中主要用來判斷食差符號。

<b>崇玄</b>定朔入交定積度 = 入交常日 * 月平行速（沒說入交常日是什麼，但是檢索交率、交數，發現只在列參數的時候出現一次，那麼很可能「入交常日」就是宋曆的「入交定日」。）

<b>崇天觀天</b>月入陰陽曆積度 = 入陰陽曆 * 月平行速

<b>紀元庚午授時</b>定朔入交泛日 = 經朔入交 ± 日月改正

<b>紀元庚午</b>定朔入交積度 = 定朔入交泛日 * 月平行速

<b>授時</b>交常度 = 經朔入交 * 月平行速

<b>紀元庚午</b>定朔入交定積度 = 定朔入交積度 ± 月改正(定朔入轉) 

<b>授時</b>交定度 = 交常度 ± 月改正(經朔入轉) 

#### 三、時差

只有紀元、授時有月食時差，其他都以定望爲食甚。

<b>應天乾元儀天崇天</b>午前後分(定朔) （宣明：初率末率，欽天：距午分，授時：中前後分）

<b>紀元庚午</b>中前後分(泛餘) 

<b>宣明應天乾元儀天</b>時差(午前後分, 半晝分) 

<b>欽天崇天觀天授時</b>時差(午前後分) 

<b>紀元</b>時差(中前後分)

<b>欽天應天乾元儀天崇天</b>食甚定餘 = 定朔 ± 時差

<b>明天</b>食甚 =  (經朔 ± 月改正) * 月平行速/月實行速 ± 日改正	

<b>紀元</b>食甚定餘 = 泛餘 ± 時差。

<b>應天乾元儀天崇天授時</b>距午分 = 午前後分 + 時差（應天：距中分，乾元：距午刻分，崇天：午前後定分、距午定分。注意，這裏是都加不減，紀元分加減：應天「以差皆加午前後分，爲距中分」乾元「皆加午前、後分，為距日分；刻法而一，為距午刻分」崇天「以時差加午前後分，為午前後定分」，授時「以中前後分各加時差，爲距午定分」。宣明是食甚時刻，之前皇極等等大概是定朔）

《儀天》有一句很難懂：「置月行去交黃赤道差，視月道差，如黃赤道交者，依其加減；不如黃赤道交者，返其加減；定朔、望小餘為食甚餘，亦返其加減去交定分。」存之再慮。

<b>明天觀天紀元</b>午前後分(明天觀天：食甚，紀元：定餘)

#### 四、氣差

氣差（欽天：黃道出入食差，應天、儀天：黃道差，乾元：晷差，明天、授時：南北差）

<b>應天乾元儀天崇天</b>氣差(定朔距冬至日, 距午分)   （應天：朔定積，崇天：朔中積，那就當成定朔，觀天：盈縮限度及分）

<b>宣明觀天</b>氣差(定朔距冬至日, 午前後分) （宣明沒說是定朔還是經朔距冬至，但差別應該不大）

<b>明天紀元授時</b>食甚距冬至日 = 經朔距冬至日 + 食甚 - 經朔（明天：朔加時中日 = 朔中日 + 加時小餘 - 經朔小餘，紀元：食甚入氣 = 經朔入氣 + 食甚 - 經朔）

<b>明天紀元授時</b>食甚日行積度 = 食甚距冬至日 ± 日改正(食甚) （明天：朔加時定日）

<b>明天紀元</b>氣差(食甚日行積度, 午前後分)

<b>授時</b>氣差(食甚日行積度, 距午分)

冬至前後符號：

宣明氣差「秋分後，陰曆減之，陽曆加之。」應天赤道差「盈初縮末內減外加」，乾元離差「秋分後陰減陽加」，紀元氣差「夏至後末限、冬至後初限，〔交初以加，交中以減。〕」崇天「秋分後，交初以加，交中以減」，庚午「秋分後陽曆加陰曆減」。

授時「在縮初盈末者，交前陰曆加陽曆減，交後陰曆減陽曆加」相當於交初交中。大統「縮初盈末，食在正交爲加，中交爲減」

#### 五、刻差

刻差（欽天：黃道斜正食差，應天、儀天：赤道差，乾元：離差，明天、授時：東西差）

<b>應天乾元儀天崇天</b>刻差(定朔距冬至日, 距午分)

<b>觀天</b>刻差(定朔距冬至日, 午前後分)

<b>明天紀元</b>刻差(食甚日行積度, 午前後分)

<b>授時</b>氣差(食甚日行積度, 距午分)

盈曆（冬至後）符號：

宣明刻差「冬至後食甚在午正前，夏至後食甚在午正後，陰曆以減，陽曆以加。」應天黃道差「入盈，以定分午前內減外加」，儀天黃道差「冬至後，甚在午正東，陰減陽加；甚在午正西，陰加陽減；夏至後即返此。」紀元刻差符號「冬至後食甚在午前，夏至後食甚在午後：交初以加，交中以減」，崇天「冬至後食甚在午前，夏至後食甚在午後：交初以加，交中以減」，庚午「冬至後午前陽加陰減」。

授時東西差「在盈，中前者，交前陰曆減陽曆加，交後陰曆加陽曆減；中後者，交前陰曆加陽曆減，交後陰曆減陽曆加。」

#### 六、加差

只有宣明、儀天有加差。

符號：宣明「若蝕甚在午正後，則每刻累益其差，陰曆以減，陽曆以加。」

<b>宣明應天乾元儀天明天紀元授時</b>食差 = 氣差 ± 刻差 ± 加差（明天：食差總數） <b>崇天觀天</b>食差 = 氣差 ± 刻差 ± 時差

《崇玄》的食差算法非常獨特，曲安京直接一筆帶過，說天文含義不明。我來解釋一下。

> 1、置其朔距天正中氣積度，  
> 2、以減三百六十五度半，餘以千乘，滿三百六十五度半除為分，曰限心。加二百五十分，為限首。減二百五十分，為限尾。滿若不足，加減一千。   
> 3、退蝕定餘一等，   
> 4、與限首尾相近者，相減，餘為限內外分。   
> 5、其蝕定餘多於限首、少於限尾者，為外；少於限首、多於限尾者，為內。

1、「距天正中氣積度」找不到解釋，上文步晷漏的自變量是「二至加時已來至其日昏後夜半日數及餘」，那積度應該指加上了日躔的實行度。

2、「滿若不足，加減一千」，就要用到 mod：

```javascript
C = (365.5 - 積度) / 0.3655 // 限心。舉例：C(182.5)≒49.317872
L = (C - 250 + 1000) % 1000 // 限尾。L(182.5)=799.317872
R = (C + 250 + 1000) % 1000 // 限首。R(182.5)=299.317872
```

3、「蝕定餘」是食甚時刻的約餘萬分小數，比如一日的 0.75 就是 7500，再退一等得 750。

4、限內外分的算法：` min(abs(食甚- R), abs(食甚- L))`，這樣就能求得與限首尾相近的了。

5、蝕定餘和限首尾比較，得出限內外。可見限內外是與距冬至積度、食甚時刻有關的二元一次函數。

藍色限首R，綠色限尾L：

<img src="https://pic.imgdb.cn/item/60b9f1008355f7f718a3e0ee.jpg" width='260'>

另外一個關鍵點是，「多於限首、少於限尾者」不應該是同時滿足，而是滿足其中之一即可，否則很多區間旣不在限內，也不在限外。據此可以作下圖：

<img src="https://pic.imgdb.cn/item/60b9fab48355f7f718337e1a.jpg" width='270'>

與其他曆法的氣差刻差符號不同，《崇玄》的限內外標準是流動的，沒有固定的午前午後或者冬至後夏至後。

#### 七、食分

<b>除了紀元授時</b>距交分 = 交前後分 ± 食差（乾元：定交分，宣明儀天明天：去交定分，崇天觀天：交前後分），判斷是否返入內外道，陰曆食陽曆不食。

<b>紀元</b>朔入交定日 = 入交常日 ± 食差 ± k0。望入交定日 = 入交常日 ± 比例*月改正(望入轉)（卽乾元儀天的入交定日）

<b>紀元</b>入陰陽曆(入交定日) 。交前後分(入陰陽曆)

<b>授時</b>正交中交限 = 正交中交度 ± 食差。正交度 357.64 = 交終度 - k0（6.1534），中交度：188.05 = 交終度/2 + k0（6.1533）。交前後度(正交中交限, 交定度)。不同的是，食差並不是加在交定度上，而是正交中交度，這樣的話符號就跟唐宋曆完全相反了，復檢術文，符號確與唐宋曆相反。爲統一起見，我把食差、k0 加在入交度上，符號就與授時術文相反。曲安京《數理》頁 451：根據黃白交點距離常數（交終度交中度）換算出黃道與視白道的距離（正交中交限）。

<b>應天乾元儀天</b>日食分(距交分, 定餘)

<b>應天乾元儀天</b>月食分(距交分)

<b>欽天崇天明天觀天紀元授時</b>食分(交前後分，明天：去交定分)

#### 八、食延

<b>應天</b>定用分(食分, 月實行速)

<b>乾元</b>定用分(食分)

<b>儀天</b>定用刻(食分, 去交定分)

<b>崇天明天觀天授時</b>日食定用分(食分, 月實行速)

<b>崇天明天觀天</b>月食定用分(交前後分，明天：去交定分, 月實行速)

<b>紀元</b>定用分(交前後分, 食甚入轉損益率)

這是《授時》月食定用分函數（爲便觀看，放大 10 倍）：

![](https://pic.imgdb.cn/item/60b9dd918355f7f718517585.jpg)

`f(食分) = sqrt((30 - x)x) * 0.00574 / 1.0962`，極值 `f(15) = 0.0785日`。1.0962 是月亮每限平行度，化爲每日平行度就是我們熟悉的 13.36875，`0.574/1.0962 = 7/13.36875`

以下是各曆定用分的分配，數字的單位是定用分。

| 曆法         | 初虧——食甚                   | 食甚——復圓 |
| ------------ | ---------------------------- | ---------- |
| 皇極大衍宣明 | 0.5                          | 0.5        |
| 戊寅         | 0.6                          | 0.4        |
| 麟德         | 0.4                          | 0.6        |
| 五紀正元     | 根據食甚時刻確定是0.4還是0.6 |            |
| 崇玄以後     | 1                            | 1          |

#### 九、帶食

⋯⋯

<b>紀元</b>帶食差(食甚小餘, 日出入分)⋯⋯

### 備忘

- <v>中</v>頁 538 大衍日食算例。

- 崇玄：

  > 其去交度分，在限外陰曆者，以陰曆差減之，不足減者，不蝕；又限外無陽曆。交在限內陰曆者，以陽曆蝕差加之；若在限內陽曆者，以去交度分反減陽曆蝕差，若不足反減者，不蝕。皆為去交定分。如既前法已下者，為既前分；已上者，以減千四百八十，餘為既後分——皆進一位。各以既前、後法除，為蝕分。在既後者，其虧復陰曆也；既前者，陽曆也。
  >
  > 凡朔望月行定分，日以九百乘，月以千乘，如千三百三十七而一，日以減千八百，月以減二千，餘為汎用刻分。凡月蝕汎用刻，在陽曆以三十四乘，在陰曆以四十一乘，百約，為月蝕既限。以減千四百八十，餘為月蝕定法。其去交度分，如既限已下者，既。已上者，以減千四百八十，餘進一位，以定法約，為蝕分。其蝕五分已下者，為或食；已上為的蝕。
  >
  > 凡日月食分，汎用刻乘之，千而一，為定用刻。不盡，退除為刻分。既者，以汎為定。
  
  「月行定分同轉分」，而轉分是每日月實行速，所以泛用刻分是關於當日月實行速的。
  
- 欽天日食分：

  > 以定準加中限，為陰道定準；減中限，為陽道定限。不足減者，反減之，為限外分。視陰道距交分，定準以上，定限以下，為陰道食；即置定限，以距交分減之，為距食分。定準以下，雖曰陰道，亦為陽道食；即加陽道定限，為距食分。其有限外分者，即減去限外分，為距食分。不足減者，不食。其陽道距交分，定限以下，為入定食限；即用減陽道定限，為距食分。

  很迷惑。我索性這樣改：
  
  > 以定準加中限，為陰道定<b>限</b>；減中限，為陽道定<b>準</b>。不足減者，反減之，為限外分。視陰道距交分，定準以上，定限以下，為陰道食——即置定限，以距交分減之，為距食分。定準以下，雖曰陰道，亦為陽道食——即加陽道定<b>準</b>，為距食分。其有限外分者，即減去限外分，為距食分；不足減者，不食。其陽道距交分，定<b>準</b>以下，為入定食限；即用減陽道定<b>準</b>，為距食分。
  
  這樣就非常通暢了。

## 古人眼中的宇宙

#### 日食的政治意義

以古代的天文水平，不可能精確計算日食這樣複雜的三體運動，所以<u>一行</u><v>大衍曆議</v>說：「使日蝕皆不可以常數求，則無以稽歷數之疎密。若皆可以常數求，則無以知政教之休咎。」一行認爲不能求得的這部分是因爲天意。北宋<v>明天</v>作者<u>周琮</u>說：<q>「今以日行之所盈縮、月行之所遲疾，皆損益之，或進退其日，以爲定朔，則舒亟之度，乃勢數使然，非失政之致也。」</q><q>「日食當朔，月食當望，蓋自然之理。夫日之食，蓋天之垂誡，警悟時政，若道化得中，則變咎爲祥。國家務以至公理天下，不可私移晦朔，宜順天誡。」</q>宋人認識到交食是一種自然現象，並非因爲<q>「失政」</q>，但日食依然是不好的事情，所以每逢日食，君主就要修身理政，以<q>「變咎爲祥」</q>。如果預測不準，那就會讓君主錯過上天的警示。<v>明志一</v>：「十九年三月癸巳朔，臺官言日當食，已而不食。帝喜，以爲天眷，然實由推步之疏也。」

### 月相

《宋志十三》末尾：「又月之晦明，自昔弗燭厥理，獨揚雄云：「月未望則載魄於西，既望則終魄於東，其溯於日乎？」京房云：「月有形無光，日照之乃光。」始知月本無光，溯日以為光。本朝沈括用彈況月，粉塗其半，以象對日之光，正側視之，始盡圓缺之形。」漢人就知道了月光是由太陽照射產生的，沈括模擬出圓缺變化的原理。

## 現代天文計算

### 任意時刻太陽高度、方位角、晷長

輸入年前冬至時刻<n><n>例如計算 2020 年 12 月 29 日、2021 年 6 月 29 日，均輸入 2020 年 12 月 21 日冬至時刻。可通過廖育棟網站、壽星天文曆、日梭天文曆、中國天文年曆等査詢</n></n>、該日距冬至的整數日數<n><n>冬至當日爲 0</n></n>、想要計算的時刻、地理緯度、影桿的高度<n><n>北京約 39 度</n></n>、公元年。程序自動將距冬至日數轉換爲眞黃經、赤緯。方位角正負：子線或午線以右以東爲負，以左以西爲正，本程序計算出的方位角不大於 90°