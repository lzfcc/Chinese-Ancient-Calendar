## 朔閏表說明

1.  可多選曆法；1 爲公元 1 年，0 爲公元前 1 年，-1 爲公元前 2 年；若僅需計算一年，在任意一框輸入年份卽可。 一曆一年爲 1 單位，最多可展示 400 單位的朔閏表，若超過 400 會自動下載到本地。
2.  第一行爲整年的情況，例如「積2759228 天紀己卯蔀49 大51小747 冬至12.5 閏餘6842閏11」的意思是：此年上元積年爲 2759228 年，入天紀己卯蔀 49 年，天正月大餘 51、小餘 747，冬至日數 12.5，閏餘 0.6842，按照閏餘法，11 月爲閏月。大餘加上蔀或紀名干支卽爲天正朔干支，如上例，己卯 16 + 大餘 51 = 67，mod (67, 60) = 7，正月朔爲庚午。四分曆日法爲 940，小餘 747 轉換爲十進制就是 747 / 940 ≒ 0.7947。冬至 12.5 同樣需要加上蔀干支。閏餘爲十進制，若以章法19爲單位，就是0.6842×19=13。
3.  「轉」表示冬至時刻入轉<n>近點月</n>日，「交」表示冬至時刻入交泛日<n>未加日月速度改正的入交點月日數</n>，「週」表示入週天度<n>恆星年</n>。
4.  劉歆<v>世經</v>論<v>三統</v>上元積年多爲算外，但也有用算上的；<v>殷曆</v> <v>周曆</v>等古四分曆，歷代學者論上元積年多用算上，但也有用算外的。統一起見，本表各曆上元積年均爲算外，入蔀<n>統</n>年均爲算上。
5.  置閏共有三種方法：閏餘法、無中氣法、固定冬至法，閏餘法可分爲年中置閏、年末置閏兩種，無中氣法閏月必在年中<n>當然也可能在最後一個月</n> ，固定冬至法閏月必在年末。漢代以後均採用無中氣法。古六曆並不確定採用何種置閏法，本工具能同時顯示三種置閏法的結果<n>超級獨家技術</n> ，以固定冬至法爲主。第一行最後標注的是閏餘年中置閏法的閏月，若採用閏餘年末置閏法，最後一個月就是閏月。中氣一行採用無中氣置閏法，有「□□」的年份爲無中氣置閏法的閏年，「□□」表示該月無中氣，爲閏月。需要留意的是，若固定冬至法閏年在閏餘法、無中氣法的上一年，那麼該年的閏餘法、無中氣法閏月數需要加 1 ，因爲固定冬至法把該年的第一個月往上年奪去了。固定冬至法的閏月必定置於年末；無中氣法的閏月可能比閏餘年中法提前或延後一個月：中氣與朔同在一日，中氣的時刻比朔早，則閏餘未達到閏準，還不能置閏；但是由於中氣與朔已經在一日了，上個月無中氣，需要置閏。
6.  本工具的另一個獨家技術是「算三年以求一年」：秦漢以後置閏採用無中氣置閏法，如果閏月在十二或一月，在特殊情況下閏年會推後或提前一年，因此欲求一年，需同時算前後一年，以應對特殊情況。這也就意味著，如果想算 10 年的朔閏，需要算 30 年。鑒於此，我們採用滾動數組，將之前的運算結果存儲下來，以空間換時間，算 10 年朔閏只需要算 12 年，經測試，這能減少近一半的計算時間。
7.  判斷大小月的方法：看天干是否相同。如一、二、三月的朔分別是辛亥、辛巳、庚戌，辛亥、辛巳天干一樣，說明一月有 30 日，爲大月；辛巳、庚戌天干不同，說明二月有 29 日，爲小月。
8.  「平朔」卽未考慮日月速度變化而得出的朔日，「平氣」卽未考慮日速度變化而得出的中氣日，「定朔」卽加上日月速度改正而得出的朔日，「定氣」卽加上日速度改正而得出的中氣日。干支下的數字爲小分，均爲十進制小數，如「8184」卽0.8184，換算成24小時制爲：0.8184 × 24 = 19.6416，0.6416 × 60 = 38.496，0.496 × 60 ≒ 30，卽19點38分30秒。小分到取小數點後四位，卽精度爲 8.64 s。各曆均有不同的辰法，需要您手動進行轉換。未來我可能會加入辰法自動轉換。
9.  「二次」表示用二次差內插法計算出的小分，「一次」表示用線性內插法計算出的小分，「三次」表示用三次差公式計算出的小分。若某曆有二次差定朔計算，則望干支及小餘爲二次差定望，其餘曆法同理。
10.  雖然漢末<v>乾象曆</v>便出現了定朔推步，但直到唐初<v>麟德曆</v>纔正式開始用定朔編排曆書，此前都是平朔注曆，定朔僅用於交食推步。雖然隋劉焯<v>皇極曆</v> 便發明了二次差計算定朔，但編排曆書時僅採用簡單的線性內插進行計算，二次差僅用於交食推步，本表進朔標準是高次內插所得小分。雖然<v>皇極曆</v>開始便可以計算定氣，但直到淸<v>時憲曆</v> 纔開始用定氣編排曆書，之前都是平氣注曆。本程序在平朔注曆時代用平朔編排閏月；在定朔推曆時代用二次差編排閏月、進朔，若遇一次差與二次差存在臨界差異，用戶大可進行手動調整，但這種極端情況應該不大可能出現。
11.  <v>元嘉</v>規定若月食發生在黎明之前，則屬上日，我把此規定用於所有的魏晉系曆法。干支減去1的，在定朔干支一格加上「-」，小分不變。<v>麟德</v>至<v>授時</v>之前行進朔法，我目前暫時簡單將 0.75 作爲進朔標準，進朔的月在干支後加上「+」來表示，僅將干支加 1，小分不變。如「乙丑+」表示原本的干支是甲子，進朔爲乙丑，而小分與進朔前一致。如果遇到與文獻不一致的情況，用戶可根據小分自行調整進朔與置閏。
12.  日食在朔，月食在望。`● ◐ ◔` 分別表示全食、偏食、光影相接虧蝕微少。隋代以前的交食計算非常原始，僅能根據交食週期判斷是否可能發生日月食。<v>乾象</v>僅能計算月食所在月，<v>景初</v>能根據去交度分判斷虧蝕程度，<v>正光</v>提出食分計算方法，<v>大明</v>沒有虧食的計算，<v>大業</v>以前的魏晉南北曆法均無全食限，均無法計算日食，僅能判斷是否交會。整齊起見，我將食分、虧蝕程度一槪補全。<v>大業</v>、<v>戊寅</v>沒有計算日食持續時間的方法，我姑且用月食來補。

## 幾個論題

### 置閏法

漢代以後皆用無中氣置閏法，卽沒有中氣的那個月置爲閏月。<v>太初</v>有一個特殊的置閏規則：<q>「中氣在朔若二日，則前月閏」</q>，但這條規則貫徹得並不徹底，有些前月朔，有些沒有前月朔，所以我的程序並沒有設置這條規則。<n>見斯琴畢力格等<v>太初曆特殊置閏問題</v>，<v>內師大學報</v>2007 年第 6 期，頁 748—753</n>

而先秦古六曆的置閏法並不清楚，有閏餘法、固定冬至法、無中法三種可能。他們的原理見 [大小月、無中氣置閏圖；固定冬至、無中氣置閏圖](https://kqh.me/post/midterm-leap)。

### 進朔

唐代以前都是平朔注曆，戊寅曆始用定朔注曆，但李淳風說645年有四月連大，<q>「庚子，詔用仁均平朔」</q>，又暫停了用定朔注曆，直到<v>麟德</v>纔固定用定朔。雖然<v>皇極</v>就發明了二次內插，但唐宋時期編排曆書依然用簡單的線性內插，精確的二次差只用於交食推算。用定朔注曆，就會出現四月連大現象，還有閏月不好放置的問題，所以<v>麟德</v>提出進朔法作爲解決方案，此後唐宋閒沿用進朔法，直到<v>授時</v>廢除。幾部曆法的進朔規則：

- <v>宣明</v>：秋分—春分：0.75，夏至0.74005，清明0.74924，小暑0.74031，穀雨0.74479，大暑0.74124，立夏、立秋0.74276，小滿0.74124，處暑0.74479，芒種0.74031，白露0.74924。<n><v>中國古代曆法</v>第570頁</n>
- <v>明天</v>：秋分—春分：0.75。<q>「若春分後，其定朔晨分差如春分之日者，三約之，以減四分之三；如定朔小餘及此數已上者，進一日；朔或當交有食，初虧在日入已前者，其朔不進。弦、望定小餘不滿日出分者，退一日；其望或當交有食，初虧在日出已前，其定望小餘雖滿日出分者，亦退之。又月行九道遲疾，曆有三大二小；日行盈縮累增損之，則有四大三小，理數然也。若循其常，則當察加時早晚，隨其所近而進退之，使月之大小不過連三。」</q><n><v>宋志八·明天</v>小字</n>
- 新唐志五說開頭說了<v>五紀</v>進朔法

我暫時都用簡單的 0.75。

### 備忘

- 1193 年 12 月紹興

> <v>宋律曆十四</v>五年，日官言，正月朔旦日食九分半，虧在辰正。常州布衣陳得一言，當食八分半，虧在巳初，其言卒驗。侍御史張致遠言：「今歲正月朔日食，太史所定不驗，得一嘗爲臣言，皆有依據。蓋患算造者不能通消息、盈虛之奧，進退、遲疾之分，致立朔有訛。凡定朔小餘七千五百以上者，進一日。紹興四年十二月小餘七千六百八十，太史不進，故十一月小盡；今年五月小餘七千一百八十，少三百二十，乃爲進朔，四月大盡。建炎三年定十一月三十日甲戌爲臘，陰陽書曰，臘者，接也，以故接新，在十二月近大寒前後戌日定之，若近大寒戌日在正月十一日，」

- <v>跋吐鲁番文书中的两件唐历</v>說麟徳 678 年閏十月，但是算出來閏十一月。
- <v>寶祐四年會天曆</v>四月進朔。
- 「晨初餘數」應該是唐曆的概念，在瀚堂搜只有唐志有，其實就是日出時刻、夜半漏，只是單位換成了日法。